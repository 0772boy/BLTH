// ==UserScript==
// @name         bliveproxy
// @namespace    http://tampermonkey.net/
// @version      0.3
// @description  B站直播websocket hook框架
// @author       https://github.com/xfgryujk
// @include      /https?:\/\/live\.bilibili\.com\/?\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/\d+\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/(blanc\/)?\d+\??.*/
// @run-at       document-start
// @require      https://cdn.jsdelivr.net/gh/google/brotli@5692e422da6af1e991f9182345d58df87866bc5e/js/decode.js
// @require      https://cdn.jsdelivr.net/npm/pako@2.0.3/dist/pako_inflate.min.js
// @grant        none
// ==/UserScript==
!function(){let e=new TextEncoder,n=new TextDecoder;let t={addCommandHandler(e,n){let t=this._commandHandlers[e];t||(t=this._commandHandlers[e]=[]),t.push(n)},removeCommandHandler(e,n){let t=this._commandHandlers[e];t&&(this._commandHandlers[e]=t.filter((e=>e!==n)))},hook(){window.WebSocket=new Proxy(window.WebSocket,{construct(e,n){let t=new e(...n);return new Proxy(t,r)}})},_commandHandlers:{},_getCommandHandlers(e){return this._commandHandlers[e]||null}},r={get(e,n){let t=e[n];return"function"==typeof t&&(t=t.bind(e)),t},set(e,n,t){if("onmessage"===n){let e=t;t=function(n){!function(e,n){if(!(e.data instanceof ArrayBuffer))return void n(e);function t(t){n({...e,data:t})}o(new Uint8Array(e.data),t)}(n,e)}}return e[n]=t,t}};function a(e,n){let t=16+e.byteLength,r=new ArrayBuffer(t),a=3===n?1:0,o=new DataView(r);o.setUint32(0,t),o.setUint16(4,16),o.setUint16(6,a),o.setUint32(8,n),o.setUint32(12,1);let i=new Uint8Array(r,16,e.byteLength);for(let n=0;n<e.byteLength;n++)i[n]=e[n];return r}function o(e,t){let r=0;for(;r<e.byteLength;){let d=new DataView(e.buffer,r),f=d.getUint32(0),l=d.getUint16(6),s=d.getUint32(8),c=new Uint8Array(e.buffer,r+16,f-16);if(5===s)switch(l){case 0:c=n.decode(c),c=JSON.parse(c),i(c,t);break;case 2:c=pako.inflate(c),o(c,t);break;case 3:c=BrotliDecode(c),o(c,t);break;default:t(a(c,s));break}else{t(a(c,s))}r+=f}}function i(n,r){if(n instanceof Array){for(let e of n)this.handleCommand(e);return}let o=n.cmd||"",i=o.indexOf(":");-1!=i&&(o=o.substr(0,i));let d=t._getCommandHandlers(o);if(d)for(let e of d)e(n);r(function(n){return a(e.encode(JSON.stringify(n)),5)}(n))}window.bliveproxy||(window.bliveproxy=t)}();
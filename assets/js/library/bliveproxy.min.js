// ==UserScript==
// @name         bliveproxy
// @namespace    http://tampermonkey.net/
// @version      0.3
// @description  B站直播websocket hook框架
// @author       https://github.com/xfgryujk
// @include      /https?:\/\/live\.bilibili\.com\/?\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/\d+\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/(blanc\/)?\d+\??.*/
// @run-at       document-start
// @require      https://cdn.jsdelivr.net/gh/google/brotli@5692e422da6af1e991f9182345d58df87866bc5e/js/decode.min.js
// @require      https://cdn.jsdelivr.net/npm/pako@2.0.3/dist/pako_inflate.min.js
// @grant        none
// ==/UserScript==
!function(){let e=new TextEncoder,t=new TextDecoder;let n={addCommandHandler(e,t){let n=this._commandHandlers[e];n||(n=this._commandHandlers[e]=[]),n.push(t)},removeCommandHandler(e,t){let n=this._commandHandlers[e];n&&(this._commandHandlers[e]=n.filter((e=>e!==t)))},_commandHandlers:{},_getCommandHandlers(e){return this._commandHandlers[e]||null}};let r={get(e,t){let n=e[t];return"function"==typeof n&&(n=n.bind(e)),n},set(e,t,n){if("onmessage"===t){let e=n;n=function(t){!function(e,t){if(!(e.data instanceof ArrayBuffer))return void t(e);function n(n){t({...e,data:n})}i(new Uint8Array(e.data),n)}(t,e)}}return e[t]=n,n}};function a(e,t){let n=16+e.byteLength,r=new ArrayBuffer(n),a=3===t?1:0,i=new DataView(r);i.setUint32(0,n),i.setUint16(4,16),i.setUint16(6,a),i.setUint32(8,t),i.setUint32(12,1);let o=new Uint8Array(r,16,e.byteLength);for(let t=0;t<e.byteLength;t++)o[t]=e[t];return r}function i(e,n){let r=0;for(;r<e.byteLength;){let d=new DataView(e.buffer,r),l=d.getUint32(0),f=d.getUint16(6),s=d.getUint32(8),c=new Uint8Array(e.buffer,r+16,l-16);if(5===s)switch(f){case 0:c=t.decode(c),c=JSON.parse(c),o(c,n);break;case 2:c=pako.inflate(c),i(c,n);break;case 3:c=BrotliDecode(c),i(c,n);break;default:n(a(c,s));break}else{n(a(c,s))}r+=l}}function o(t,r){if(t instanceof Array){for(let e of t)this.handleCommand(e);return}let i=t.cmd||"",o=i.indexOf(":");-1!=o&&(i=i.substr(0,o));let d=n._getCommandHandlers(i);if(d)for(let e of d)e(t);r(function(t){return a(e.encode(JSON.stringify(t)),5)}(t))}window.bliveproxy||(window.bliveproxy=n,window.WebSocket=new Proxy(window.WebSocket,{construct(e,t){let n=new e(...t);return new Proxy(n,r)}}))}();
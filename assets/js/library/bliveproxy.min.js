// ==UserScript==
// @name         bliveproxy
// @namespace    https://github.com/xfgryujk
// @version      0.1
// @description  B站直播websocket hook框架
// @author       xfgryujk
// @include      /https?:\/\/live\.bilibili\.com\/?\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/\d+\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/(blanc\/)?\d+\??.*/
// @require      https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.10/pako.min.js
// @grant        none
// ==/UserScript==
!function(){let e=new TextEncoder,n=new TextDecoder;let t={addCommandHandler(e,n){let t=this._commandHandlers[e];t||(t=this._commandHandlers[e]=[]),t.push(n)},removeCommandHandler(e,n){let t=this._commandHandlers[e];t&&(this._commandHandlers[e]=t.filter((e=>e!==n)))},_commandHandlers:{},_getCommandHandlers(e){return this._commandHandlers[e]||null}};let r={get(e,n){let t=e[n];return"function"==typeof t&&(t=t.bind(e)),t},set(e,n,t){if("onmessage"===n){let e=t;t=function(n){!function(e,n){if(!(e.data instanceof ArrayBuffer))return void n(e);function t(t){n({...e,data:t})}o(new Uint8Array(e.data),t)}(n,e)}}return e[n]=t,t}};function i(e,n){let t=16+e.byteLength,r=new ArrayBuffer(t),i=3===n?0:1,o=new DataView(r);o.setUint32(0,t),o.setUint16(4,16),o.setUint16(6,i),o.setUint32(8,n),o.setUint32(12,1);let a=new Uint8Array(r,16,e.byteLength);for(let n=0;n<e.byteLength;n++)a[n]=e[n];return r}function o(e,t){let r=0;for(;r<e.byteLength;){let d=new DataView(e.buffer,r),f=d.getUint32(0),l=d.getUint16(6),s=d.getUint32(8),c=new Uint8Array(e.buffer,r+16,f-16);if(5===s)2==l?(c=pako.inflate(c),o(c,t)):(c=JSON.parse(n.decode(c)),a(c,t));else{t(i(c,s))}r+=f}}function a(n,r){if(n instanceof Array){for(let e of n)this.handleCommand(e);return}let o=n.cmd||"",a=o.indexOf(":");-1!=a&&(o=o.substr(0,a));let d=t._getCommandHandlers(o);if(d)for(let e of d)e(n);r(function(n){return i(e.encode(JSON.stringify(n)),5)}(n))}window.bliveproxy||(window.bliveproxy=t,window.WebSocket=new Proxy(window.WebSocket,{construct(e,n){let t=new e(...n);return new Proxy(t,r)}}))}();
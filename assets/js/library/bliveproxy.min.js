// ==UserScript==
// @name         bliveproxy
// @namespace    https://github.com/xfgryujk
// @version      0.2
// @description  B站直播websocket hook框架
// @author       xfgryujk
// @include      /https?:\/\/live\.bilibili\.com\/?\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/\d+\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/(blanc\/)?\d+\??.*/
// @require      https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.10/pako.min.js
// @grant        unsafeWindow
// ==/UserScript==
!function(){const e="undefined"==typeof unsafeWindow?window:unsafeWindow;let n=new TextEncoder,t=new TextDecoder;let r={addCommandHandler(e,n){let t=this._commandHandlers[e];t||(t=this._commandHandlers[e]=[]),t.push(n)},removeCommandHandler(e,n){let t=this._commandHandlers[e];t&&(this._commandHandlers[e]=t.filter((e=>e!==n)))},hook(){e.WebSocket=new Proxy(window.WebSocket,{construct(e,n){let t=new e(...n);return new Proxy(t,o)}})},_commandHandlers:{},_getCommandHandlers(e){return this._commandHandlers[e]||null}},o={get(e,n){let t=e[n];return"function"==typeof t&&(t=t.bind(e)),t},set(e,n,t){if("onmessage"===n){let e=t;t=function(n){!function(e,n){if(!(e.data instanceof ArrayBuffer))return void n(e);function t(t){n({...e,data:t})}a(new Uint8Array(e.data),t)}(n,e)}}return e[n]=t,t}};function i(e,n){let t=16+e.byteLength,r=new ArrayBuffer(t),o=3===n?0:1,i=new DataView(r);i.setUint32(0,t),i.setUint16(4,16),i.setUint16(6,o),i.setUint32(8,n),i.setUint32(12,1);let a=new Uint8Array(r,16,e.byteLength);for(let n=0;n<e.byteLength;n++)a[n]=e[n];return r}function a(e,n){let r=0;for(;r<e.byteLength;){let o=new DataView(e.buffer,r),f=o.getUint32(0),l=o.getUint16(6),s=o.getUint32(8),u=new Uint8Array(e.buffer,r+16,f-16);if(5===s)2==l?(u=pako.inflate(u),a(u,n)):(u=JSON.parse(t.decode(u)),d(u,n));else{n(i(u,s))}r+=f}}function d(e,t){if(e instanceof Array){for(let n of e)this.handleCommand(n);return}let o=e.cmd||"",a=o.indexOf(":");-1!=a&&(o=o.substr(0,a));let d=r._getCommandHandlers(o);if(d)for(let n of d)n(e);t(function(e){return i(n.encode(JSON.stringify(e)),5)}(e))}window.bliveproxy||(window.bliveproxy=r)}();
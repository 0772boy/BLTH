// ==UserScript==
// @namespace      https://github.com/andywang425
// @name           B站直播间挂机助手
// @name:en        B站直播间挂机助手
// @author         andywang425
// @description    自动获取小心心，参加天选时刻抽奖，直播区签到，应援团签到，银瓜子换硬币，完成主站每日任务(登录,观看视频,投币,分享视频)，批量送礼、点亮勋章，参与实物抽奖，参与Bilibili直播区礼物抽奖(现在极少)，参加被广播的节奏风暴(几乎没有)，定时发弹幕，快捷购买粉丝勋章
// @description:en 自动获取小心心，参加天选时刻抽奖，直播区签到，应援团签到，银瓜子换硬币，完成主站每日任务(登录,观看视频,投币,分享视频)，批量送礼、点亮勋章，参与实物抽奖，参与Bilibili直播区礼物抽奖(现在极少)，参加被广播的节奏风暴(几乎没有)，定时发弹幕，快捷购买粉丝勋章
// @updateURL      https://raw.githubusercontent.com/andywang425/Bilibili-SGTH/master/B%E7%AB%99%E7%9B%B4%E6%92%AD%E9%97%B4%E6%8C%82%E6%9C%BA%E5%8A%A9%E6%89%8B.user.js
// @downloadURL    https://raw.githubusercontent.com/andywang425/Bilibili-SGTH/master/B%E7%AB%99%E7%9B%B4%E6%92%AD%E9%97%B4%E6%8C%82%E6%9C%BA%E5%8A%A9%E6%89%8B.user.js
// @homepageURL    https://github.com/andywang425/BLTH/
// @supportURL     https://github.com/andywang425/BLTH/issues
// @icon           https://s1.hdslb.com/bfs/live/d57afb7c5596359970eb430655c6aef501a268ab.png
// @copyright      2020, andywang425 (https://github.com/andywang425)
// @license        MIT
// @compatible     chrome 80 or later
// @compatible     firefox 77 or later
// @compatible     opera 69 or later
// @version        5.1
// @include       /https?:\/\/live\.bilibili\.com\/[blanc\/]?[^?]*?\d+\??.*/
// @run-at        document-end
// @connect       passport.bilibili.com
// @connect       api.live.bilibili.com
// @connect       live-trace.bilibili.com
// @connect       sc.ftqq.com
// @require       https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js
// @require       https://cdn.jsdelivr.net/gh/andywang425/BLTH@00b017a0db1d854cbccf8a69857617551d22a972/modules/BilibiliAPI_Mod.min.js
// @require       https://cdn.jsdelivr.net/gh/andywang425/BLTH@4716930900e64769f19dd7aa00b0824a4961cdd0/modules/layer.js
// @require       https://cdn.jsdelivr.net/gh/andywang425/BLTH@4716930900e64769f19dd7aa00b0824a4961cdd0/modules/libBilibiliToken.js
// @require       https://cdn.jsdelivr.net/gh/andywang425/BLTH@4716930900e64769f19dd7aa00b0824a4961cdd0/modules/libWasmHash.js
// @resource      layerCss https://cdn.jsdelivr.net/gh/andywang425/BLTH@d86732c07164300f64a2e543f264ce4f6099fbfc/modules/layer.css
// @grant         unsafeWindow
// @grant         GM_xmlhttpRequest
// @grant         GM_getResourceText
// @grant         GM_addStyle
// ==/UserScript==
!function(){const NAME="IGIFTMSG",debugSwitch=!0,BAPI=BilibiliAPI,UA=navigator.userAgent,tz_offset=(new Date).getTimezoneOffset()+480,ts_ms=()=>Date.now(),ts_s=()=>Math.round(ts_ms()/1e3),runUntilSucceed=(t,e=0,i=100)=>{setTimeout(()=>{t()||runUntilSucceed(t,i,i)},e)},delayCall=(t,e=12e4)=>{const i=$.Deferred();return setTimeout(()=>{const e=t();e&&e.then?e.then((t,e,n,o,a,r)=>i.resolve(t,e,n,o,a,r)):i.resolve()},e),i},MYDEBUG=(t,...e)=>{if(!debugSwitch)return;let i=new Date;i=`[${NAME}][${i.getHours()}:${i.getMinutes()}:${i.getSeconds()}:${i.getMilliseconds()}]`,1!==e.length?console.log(i,`${t}:`,e):console.log(i,`${t}:`,e[0])},runMidnight=(t,e)=>{const i=new Date;let n=e||" ";i.setMinutes(i.getMinutes()+tz_offset),i.setDate(i.getDate()+1),i.setHours(0,1,0,0),i.setMinutes(i.getMinutes()-tz_offset),setTimeout(t,i-ts_ms()),MYDEBUG("runMidnight",n+" "+i.toString())},runExactMidnight=(t,e)=>{const i=new Date;let n=e||" ";i.setMinutes(i.getMinutes()+tz_offset),i.setDate(i.getDate()+1),i.setHours(0,0,0,0),i.setMinutes(i.getMinutes()-tz_offset),setTimeout(t,i-ts_ms()),MYDEBUG("runExactMidnight",n+" "+i.toString())},runTomorrow=(t,e,i,n)=>{const o=new Date;let a=n||" ";o.setMinutes(o.getMinutes()+tz_offset),o.setDate(o.getDate()+1),o.setHours(e,i,0,0),o.setMinutes(o.getMinutes()-tz_offset),setTimeout(t,o-ts_ms()),MYDEBUG("runTomorrow",a+" "+o.toString())},appToken=new BilibiliToken,baseQuery=`actionKey=appkey&appkey=${BilibiliToken.appKey}&build=5561000&channel=bili&device=android&mobi_app=android&platform=android&statistics=%7B%22appId%22%3A1%2C%22platform%22%3A3%2C%22version%22%3A%225.57.0%22%2C%22abtest%22%3A%22%22%7D`,setToken=async()=>(tokenData.time>ts_s()?userToken=tokenData:((tokenData=await appToken.getToken()).time=ts_s()+tokenData.expires_in,localStorage.setItem(`${NAME}_Token`,JSON.stringify(tokenData)),userToken=tokenData),MYDEBUG(`${NAME}_Token`,tokenData),"OK"),newWindow={init:()=>newWindow.Toast.init().then(()=>{}),Toast:{init:()=>{try{const t=[];return window.toast=((e,i="info",n=5e3)=>{switch(i){case"success":case"info":case"caution":case"error":break;default:i="info"}const o=$(`<div class="link-toast ${i} fixed" style="z-index:10001"><span class="toast-text">${e}</span></div>`)[0];document.body.appendChild(o),o.style.top=document.body.scrollTop+40*t.length+10+"px",o.style.left=document.body.offsetWidth+document.body.scrollLeft-o.offsetWidth-5+"px","hide"==msgHide&&$(".link-toast").hide(),t.push(o),setTimeout(()=>{o.className+=" out",setTimeout(()=>{t.shift(),t.forEach(t=>{t.style.top=parseInt(t.style.top,10)-40+"px"}),$(o).remove()},200)},n)}),$.Deferred().resolve()}catch(t){return console.error("初始化浮动提示时出现异常",t),$.Deferred().reject()}}}},addStyle=async()=>{const t=await GM_getResourceText("layerCss");return GM_addStyle(t+".chatLogDiv{text-align:center;border-radius:4px;min-height:30px;width:256px;color:#9585ff;line-height:30px;padding:0 10px;margin:10px auto}.chatLogMsg{word-wrap:break-word;width:100%;line-height:1em;margin-bottom:10px}.chatLogWarning{border:1px solid rgb(236,221,192);color:rgb(218,142,36);background:rgb(245,235,221) none repeat scroll 0% 0%}.chatLogSuccess{border:1px solid rgba(22,140,0,.28);color:rgb(69,171,69);background:none 0% 0% repeat scroll rgba(16,255,0,.18)}.chatLogError{border:1px solid rgba(255,0,39,.28);color:rgb(116,0,15);background:none 0% 0% repeat scroll rgba(255,0,39,.18)}.chatLogDefault{border:1px solid rgb(203,195,255);background:rgb(233,230,255) none repeat scroll 0% 0%}.igiftMsg_input{outline:none;border:1px solid #e9eaec;background-color:#fff;border-radius:4px;padding:1px 0 0;overflow:hidden;font-size:12px;line-height:19px;width:30px;z-index:10001}.igiftMsg_btn{background-color:#23ade5;color:#fff;border-radius:4px;border:none;padding:5px;cursor:pointer;box-shadow:0 0 2px #00000075;line-height:10px;z-index:10001}.igiftMsg_btn:active{background-color:#0e8bbd;position:relative;top:1px}.igiftMsg_fs{border:2px solid #d4d4d4;z-index:10001}.chatLogDiv{text-align:center;border-radius:4px;min-height:30px;width:256px;line-height:30px;padding:0 10px;margin:10px auto}.chatLogMsg{word-wrap:break-word;width:100%;line-height:1em;margin-bottom:10px}.chatLogWarning{border:1px solid rgb(209,194,164);color:rgb(190,125,33);background:rgb(255,223,175) none repeat scroll 0% 0%}.chatLogSuccess{border:1px solid rgba(22,140,0,.28);color:rgb(69,171,69);background:none 0% 0% repeat scroll rgba(16,255,0,.18)}.chatLogError{border:1px solid rgba(255,0,39,.28);color:rgb(116,0,15);background:none 0% 0% repeat scroll rgba(255,0,39,.18)}.chatLogDefault{border:1px solid rgb(203,195,255);color:#9585ff;background:rgb(233,230,255) none repeat scroll 0% 0%}.chatLogLottery{text-align:center;border-radius:4px;min-height:30px;width:256px;color:#9585ff;line-height:30px;padding:0 10px;margin:10px auto;border:1px solid rgb(203,195,255);background:rgb(233,230,255) none repeat scroll 0% 0%}.chatLogWinPrize{border:1px solid rgb(223,187,0);color:rgb(145,123,0);background:none 0% 0% repeat scroll rgb(255,215,0,30%)}.igiftMsg_num{min-width:12px;height:16px;padding:0 3px;border-radius:8px;line-height:16px;font-size:12px;text-align:center;color:#fff;position:absolute;top:3px;right:15px;z-index:10000;background-color:#fa5a57}")},getScrollPosition=(t=window)=>({x:void 0!==t.pageXOffset?t.pageXOffset:t.scrollLeft,y:void 0!==t.pageYOffset?t.pageYOffset:t.scrollTop}),linkMsg=(t,e)=>'<a href="'+e+'"target="_blank">'+t+"</a>",liveRoomUrl="https://live.bilibili.com/";let msgHide=localStorage.getItem(`${NAME}_msgHide`)||"hide",gift_join_try=0,guard_join_try=0,pk_join_try=0,winPrizeNum=0,SEND_GIFT_NOW=!1,SEND_DANMU_NOW=!1,LIGHT_MEDAL_NOW=!1,hideBtnClickable=!0,getFollowBtnClickable=!0,unFollowBtnClickable=!0,Live_info={room_id:void 0,uid:void 0,ruid:void 0,gift_list:void 0,rnd:void 0,visit_id:void 0,bili_jct:void 0,tid:void 0},userToken=void 0,tokenData=JSON.parse(localStorage.getItem(`${NAME}_Token`))||{},mainIndex=void 0,menuIndex=void 0,layerMenuWindow=void 0,JQlogRedPoint=void 0;function init(){const MY_API={CONFIG_DEFAULT:{AUTO_DANMU:!1,AUTO_GIFT:!1,AUTO_GIFT_ROOMID:["0"],AUTO_GROUP_SIGN:!0,ANCHOR_LOTTERY:!1,ANCHOR_MAXROOM:1e3,ANCHOR_CHECK_INTERVAL:10,ANCHOR_IGNORE_BLACKLIST:!0,ANCHOR_BLACKLIST_WORD:["测试","钓鱼","炸鱼"],ANCHOR_INTERVAL:150,AHCHOR_NEED_GOLD:0,CHECK_HOUR_ROOM:!1,CHECK_HOUR_ROOM_INTERVAL:600,COIN:!1,COIN_NUMBER:0,COIN_TYPE:"COIN_DYN",COIN_UID:0,DANMU_CONTENT:["这是一条弹幕"],DANMU_ROOMID:["22474988"],DANMU_INTERVAL_TIME:["10m"],EXCLUDE_ROOMID:["0"],FORCE_LOTTERY:!1,FORCE_LIGHT:!1,FT_NOTICE:!1,FT_SCKEY:"SCKEY",GIFT_LIMIT:1,GIFT_SEND_HOUR:23,GIFT_SEND_MINUTE:59,GIFT_INTERVAL:5,GIFT_METHOD:"GIFT_SEND_TIME",GIFT_SORT:"high",IN_TIME_RELOAD_DISABLE:!1,LOTTERY:!0,LIVE_SIGN:!0,LOGIN:!0,LITTLE_HEART:!0,LIGHT_MEDALS:["0"],LIGHT_METHOD:"LIGHT_WHITE",MAX_GIFT:99999,MATERIAL_LOTTERY:!0,MATERIAL_LOTTERY_CHECK_INTERVAL:60,MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY:!0,QUESTIONABLE_LOTTERY:["test","encrypt","测试","钓鱼","加密","炸鱼"],MATERIAL_LOTTERY_REM:10,NOSLEEP:!0,RANDOM_DELAY:!0,RANDOM_SEND_DANMU:0,RANDOM_SKIP:0,REMOVE_ELEMENT_2233:!1,REMOVE_ELEMENT_activity:!0,REMOVE_ELEMENT_rank:!0,RND_DELAY_END:5,RND_DELAY_START:2,SEND_ALL_GIFT:!1,SHARE:!0,SILVER2COIN:!1,SPARE_GIFT_ROOM:"0",STORM:!1,STORM_MAX_COUNT:100,STORM_ONE_LIMIT:200,STORM_QUEUE_SIZE:3,TIME_AREA_DISABLE:!0,TIME_AREA_END_H0UR:8,TIME_AREA_END_MINUTE:0,TIME_AREA_START_H0UR:2,TIME_AREA_START_MINUTE:0,TIME_RELOAD:!1,TIME_RELOAD_MINUTE:120,WATCH:!0},CACHE_DEFAULT:{AUTO_SEND_DANMU_TS:[],AUTO_GROUP_SIGH_TS:0,DailyReward_TS:0,LiveReward_TS:0,Silver2Coin_TS:0,Gift_TS:0,GiftInterval_TS:0,LittleHeart_TS:0,materialobject_ts:0,AnchorLottery_TS:0,last_aid:639},CONFIG:{},CACHE:{},GIFT_COUNT:{COUNT:0,SILVER_COUNT:0,CLEAR_TS:0},init:async()=>{await addStyle();const t=$(".tab-list.dp-flex"),e=$(".tab-content"),i=e.offset(),n=e.height(),o=$("#chat-history-list"),a=o.outerWidth(!0),r=o.height(),l=$(".icon-item").height(),s=i.top,d=i.left,_=$('<li data-v-2fdbecb2="" data-v-d2be050a="" class="item dp-i-block live-skin-separate-border border-box t-center pointer live-skin-normal-text" style = \'font-weight:bold\' id = "menuDiv"><label id="menuDivText">日志<div class="igiftMsg_num" style="display: none;" id = \'logRedPoint\'>0</div></label></li>');([".chat-history-list",".attention-btn-ctnr",".live-player-mounter"].some(t=>0===t.length)||0===t.length||0===e.length)&&window.toast("必要页面元素缺失，强制运行（可能会看不到控制面板，提示信息）","error"),t.append(_),JQlogRedPoint=$("#logRedPoint");let I=[];for(let e=0;e<t.children("li").length;e++)I.push(t.children("li")[e]);function c(t=!0){return t?e.hide():e.show()}menuIndex=await layer.open({type:1,title:!1,offset:[String(s-getScrollPosition().y)+"px",d+"px"],closeBtn:0,shade:0,zIndex:9999,fixed:!1,area:[String(a)+"px",String(r+n+l)+"px"],anim:-1,isOutAnim:!1,resize:!1,content:'<div id = "menuWindow"></div>',success:()=>{layerMenuWindow=document.querySelector("#layui-layer1 > div")}}),layer.style(menuIndex,{"box-shadow":"none",display:"none","background-color":"#f2f3f5"});for(const t of I){let e="none",i=!1,n=!1;$(t).click(()=>{for(const e of I)e!=t&&$(e).removeClass("active");return $(t).addClass("active"),"menuDiv"===$(t).attr("id")&&(e="block",i=!0,n=!0,JQlogRedPoint.hide()),layer.style(menuIndex,{display:e}),n&&layerMenuWindow.scrollTo(0,layerMenuWindow.scrollHeight),c(i)})}try{BAPI.setCommonArgs(Live_info.bili_jct)}catch(t){return void console.error(`[${NAME}]设置token错误`,t)}let A=$.Deferred();try{MY_API.loadConfig().then(()=>{MY_API.chatLog("脚本载入配置成功","success"),A.resolve()})}catch(t){console.error("API初始化出错",t),MY_API.chatLog("API初始化出错","error"),A.reject()}try{MY_API.loadCache().then(()=>{window.toast("CACHE载入成功","success"),A.resolve()})}catch(t){console.error("CACHE初始化出错",t),window.toast("CACHE初始化出错","error"),A.reject()}return A},loadConfig:()=>{let t=$.Deferred();try{const e=JSON.parse(localStorage.getItem(`${NAME}_CONFIG`));$.extend(!0,MY_API.CONFIG,MY_API.CONFIG_DEFAULT);for(const t in MY_API.CONFIG)MY_API.CONFIG.hasOwnProperty(t)&&void 0!==e[t]&&null!==e[t]&&(MY_API.CONFIG[t]=e[t]);MY_API.loadGiftCount(),t.resolve()}catch(e){MYDEBUG("API载入配置失败，加载默认配置",e),MY_API.setDefaults(),t.reject()}return t},loadCache:()=>{let t=$.Deferred();try{const e=JSON.parse(localStorage.getItem(`${NAME}_CACHE`));$.extend(!0,MY_API.CACHE,MY_API.CACHE_DEFAULT);for(const t in MY_API.CACHE)MY_API.CACHE.hasOwnProperty(t)&&void 0!==e[t]&&null!==e[t]&&(MY_API.CACHE[t]=e[t]);t.resolve()}catch(e){MYDEBUG("CACHE载入配置失败，加载默认配置",e),MY_API.setDefaults(),t.reject()}return t},newMessage:t=>{try{const e=localStorage.getItem(`${NAME}_NEWMSG_CACHE`);null!=e&&"5.1"==e||(layer.open({title:`${t}更新提示`,content:`1.新功能：实物/天选中奖后通过方糖推送通知<br>\n                            2.忽略关键字编辑方式优化<br>\n                            3,新增按钮点击特效<br>\n                            4.实物/天选参与抽奖后会追踪获奖情况，若中奖则在日志区域显示金色日志，通过方糖推送通知（如果开启），并在【日志】右上角显示小红点<br>\n                            5.修复自动投币的一些bug<br>\n                            6.一些运行效率上的优化<br>  \n                            <hr>\n                            <em style="color:grey;">\n                            如果使用过程中遇到问题，欢迎去${linkMsg("github","https://github.com/andywang425/BLTH/issues")}\n                            （或者进qq群${linkMsg("1106094437","https://jq.qq.com/?_wv=1027&amp;k=fCSfWf1O")}）反馈。\n                            </em>`}),localStorage.setItem(`${NAME}_NEWMSG_CACHE`,t))}catch(t){MYDEBUG("提示信息CACHE载入失败",t)}},saveConfig:(t=!0)=>{try{return localStorage.setItem(`${NAME}_CONFIG`,JSON.stringify(MY_API.CONFIG)),t&&window.toast("配置已保存，部分设置需刷新后才能生效","info"),MYDEBUG("MY_API.CONFIG",MY_API.CONFIG),!0}catch(t){return MYDEBUG("API保存出错",t),!1}},saveCache:(t=!0)=>{try{return localStorage.setItem(`${NAME}_CACHE`,JSON.stringify(MY_API.CACHE)),t&&MYDEBUG("CACHE已保存",MY_API.CACHE),!0}catch(t){return MYDEBUG("CACHE保存出错",t),!1}},setDefaults:()=>{MY_API.CONFIG=MY_API.CONFIG_DEFAULT,MY_API.CACHE=MY_API.CACHE_DEFAULT,MY_API.saveConfig(),MY_API.saveCache(),MY_API.chatLog("配置和CACHE已重置为默认。3秒后刷新页面"),setTimeout(()=>{window.location.reload()},3e3)},ReDoDailyTasks:()=>{window.toast("3秒后再次执行所有任务","info"),setTimeout(()=>{MY_API.CACHE=MY_API.CACHE_DEFAULT,MY_API.GroupSign.run(),MY_API.DailyReward.run(),MY_API.LiveReward.run(),MY_API.Exchange.runS2C(),MY_API.Gift.run(),MY_API.LITTLE_HEART.run(),MY_API.AUTO_DANMU.run(),MY_API.MaterialObject.run(),MY_API.AnchorLottery.run()},3e3)},loadGiftCount:()=>{try{const t=JSON.parse(localStorage.getItem(`${NAME}_GIFT_COUNT`));for(const e in MY_API.GIFT_COUNT)MY_API.GIFT_COUNT.hasOwnProperty(e)&&void 0!==t[e]&&null!==t[e]&&(MY_API.GIFT_COUNT[e]=t[e]);MYDEBUG("MY_API.GIFT_COUNT",MY_API.GIFT_COUNT)}catch(t){MYDEBUG("读取统计失败",t)}},saveGiftCount:()=>{try{return localStorage.setItem(`${NAME}_GIFT_COUNT`,JSON.stringify(MY_API.GIFT_COUNT)),MYDEBUG("统计保存成功",MY_API.GIFT_COUNT),!0}catch(t){return MYDEBUG("统计保存出错",t),!1}},addGift:t=>{MY_API.GIFT_COUNT.COUNT+=t,$("#giftCount span:eq(0)").text(MY_API.GIFT_COUNT.COUNT),MY_API.saveGiftCount()},addSilver:t=>{MY_API.GIFT_COUNT.SILVER_COUNT+=t,$("#giftCount span:eq(1)").text(MY_API.GIFT_COUNT.SILVER_COUNT),MY_API.saveGiftCount()},removeUnnecessary:()=>{const t=["#my-dear-haruna-vm",".activity-entry",".activity-rank"],e=["REMOVE_ELEMENT_2233","REMOVE_ELEMENT_activity","REMOVE_ELEMENT_rank"],i=i=>{MY_API.CONFIG[e[i]]&&setInterval(()=>{const e=$(t[i]);e.length>0&&e.remove()},200)};for(let e=0;e<t.length;e++)i(e);MY_API.CONFIG.NOSLEEP&&setInterval(()=>document.dispatchEvent(new Event("visibilitychange")),6e5)},buyFanMedal:t=>BAPI.live_user.get_anchor_in_room(t).then(function(t){MYDEBUG("API.live_user.get_anchor_in_room response",t),0===t.code&&t.data.info?layer.confirm(`是否消耗20硬币购买UP主【${t.data.info.uname}】的粉丝勋章？`,{title:"购买勋章",btn:["是","否"]},function(){return BAPI.link_group.buy_medal(t.data.info.uid).then(t=>{MYDEBUG("API.link_group.buy_medal re",t),0===t.code?layer.msg("购买成功",{time:2e3,icon:1}):layer.msg(`购买失败 ${t.message}`,{time:2500,icon:2})})},function(){layer.msg("已取消购买",{time:2e3})}):0===t.code&&void 0===t.data.info?layer.msg("房间不存在",{time:2500}):layer.msg(`检查房间出错 ${t.message}`,{time:2500})}),creatSetBox:async()=>{const t=$(`<button class="igiftMsg_btn" style="display: inline-block; float: left; margin-right: 7px;cursor: pointer;box-shadow: 1px 1px 2px #00000075;" id="hiderbtn">${"hide"==msgHide?"显示窗口和提示信息":"隐藏窗口和提示信息"}<br></button>`),e=$('button[data-title="网页全屏"]'),i=$(".live-player-mounter").height(),n=$(".live-player-mounter").offset();let o='"float:left"';UA.toLowerCase().indexOf("firefox")>-1&&(o='""');const a=`\n                <div id='allsettings' class = "igiftMsg_main">\n                <fieldset class="igiftMsg_fs">\n                    <legend style="color: black">今日统计</legend>\n                    <div id="giftCount" style="font-size: large; text-shadow: 1px 1px #00000066; color: blueviolet;">\n                        辣条&nbsp;<span>${MY_API.GIFT_COUNT.COUNT}</span>\n                        银瓜子&nbsp;<span>${MY_API.GIFT_COUNT.SILVER_COUNT}万</span>\n                        &nbsp;<button style="font-size: small" class="igiftMsg_btn" data-action="save">保存所有设置</button>\n                    </div>\n                </fieldset>\n                <div id="left_fieldset" style=${o}>\n                    <fieldset class="igiftMsg_fs">\n                        <legend style="color: black">抽奖设置</legend>\n                    <div data-toggle="LOTTERY">\n                        <label style="margin: 5px auto; color: purple;line-height:30px";>\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            参与礼物抽奖\n                        </label>\n                    </div>\n                        <div data-toggle="RANDOM_DELAY">\n                            <label style="margin: 5px auto; color: darkgreen">&nbsp;&nbsp;&nbsp;&nbsp;\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                抽奖附加随机延迟\n                                <input class="RND_DELAY_START igiftMsg_input" style="width: 30px;vertical-align: top;" type="text">~\n                                <input class="RND_DELAY_END igiftMsg_input" style="width: 30px;vertical-align: top;" type="text">s\n                            </label>\n                        </div>\n                        <div data-toggle="TIME_AREA_DISABLE">\n                            <label style="margin: 5px auto; color: darkgreen">&nbsp;&nbsp;&nbsp;&nbsp;\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                启用\n                                <input class="startHour igiftMsg_input" style="width: 20px;" type="text">点\n                                <input class="startMinute igiftMsg_input" style="width: 20px;" type="text">分至\n                                <input class="endHour igiftMsg_input" style="width: 20px;" type="text">点\n                                <input class="endMinute igiftMsg_input" style="width: 20px;" type="text">分不抽奖(24小时制)\n                            </label>\n                        </div>\n                        <div data-toggle="RANDOM_SKIP">\n                            <label style="margin: 5px auto; color: darkgreen">&nbsp;&nbsp;&nbsp;&nbsp;\n                                随机跳过礼物(0到100,为0则不跳过)<input class="per igiftMsg_input" style="width: 30px;" type="text">%\n                            </label>\n                        </div>\n                        <div data-toggle="MAX_GIFT">\n                            <label style="margin: 5px auto; color: darkgreen">&nbsp;&nbsp;&nbsp;&nbsp;\n                                当天最多抢辣条数量<input class="num igiftMsg_input" style="width: 100px;" type="text">\n                            </label>\n                        </div>\n                        <div data-toggle="RANDOM_SEND_DANMU">\n                            <label style="margin: 5px auto; color: darkgreen">&nbsp;&nbsp;&nbsp;&nbsp;\n                                抽奖时活跃弹幕发送概率(0到5,为0则不发送)<input class="per igiftMsg_input" style="width: 30px;" type="text">%\n                            </label>\n                        </div>\n                        <div data-toggle="CHECK_HOUR_ROOM">\n                            <label style="margin: 5px auto; color: darkgreen">&nbsp;&nbsp;&nbsp;&nbsp;\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                检查小时榜（间隔时间<input class="num igiftMsg_input" style="width: 25px;" type="text">秒）\n                            </label>\n                        </div>\n                        <div data-toggle="FORCE_LOTTERY" style="line-height: 20px">\n                        <label style="margin: 5px auto; color: red;">&nbsp;&nbsp;&nbsp;&nbsp;\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            访问被拒绝后强制重复抽奖(最多5次)\n                        </label>\n                        </div>\n                        <div data-toggle="MATERIAL_LOTTERY">\n                        <label style="margin: 5px auto; color: purple;">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            参与实物抽奖\n                        </label>\n                    </div>\n                    <div data-toggle="MATERIAL_LOTTERY_CHECK_INTERVAL">\n                        <label style="margin: 5px auto; color: black;">&nbsp;&nbsp;&nbsp;&nbsp;\n                            检查间隔\n                            <input class="num igiftMsg_input" style="width: 30px;" type="text">\n                            分钟\n                        </label>\n                    </div>\n                    <div data-toggle="MATERIAL_LOTTERY_REM">\n                    <label style="margin: 5px auto; color: black;">&nbsp;&nbsp;&nbsp;&nbsp;\n                        检测到\n                        <input class="num igiftMsg_input" style="width: 30px;" type="text">\n                        个不存在活动的aid后停止检测\n                    </label>\n                </div>\n                    <div data-toggle="MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY">\n                    <label style="margin: 5px auto; color: black;">&nbsp;&nbsp;&nbsp;&nbsp;\n                        <input style="vertical-align: text-top;" type="checkbox">\n                        忽略关键字\n                        <label class = 'str' style = 'font-weight:bold'>${MY_API.CONFIG.QUESTIONABLE_LOTTERY.length}个</label>\n                        &nbsp;<button style="font-size: small" class="igiftMsg_btn" data-action="edit_QUESTIONABLE_LOTTERY">编辑</button>\n                    </label>\n                </div>\n                    </fieldset>\n            \n                    <fieldset class="igiftMsg_fs" style ="line-height:16px;">\n                        <legend style="color: black">每日任务设置</legend>\n                        <div data-toggle="LOGIN" style=" color: black">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            登陆\n                        </div>\n                        <div data-toggle="WATCH" style=" color: black">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            观看视频\n                        </div>\n                        <div data-toggle="COIN" style=" color: black">\n                            <label style="cursor: pointer">\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                自动投币<input class="coin_number igiftMsg_input" style="width: 40px;" type="text">个(0-5)\n                            </label>\n                        </div>\n                        <div data-toggle="COIN_TYPE" style=" color: black">\n                            <div data-toggle="COIN_UID">\n                            <input style="vertical-align: text-top;" type="radio" name="COIN_TYPE">\n                            给用户(UID:<input class="num igiftMsg_input" style="width: 80px;" type="text">)\n                            的视频投币\n                            </div>\n                            <div data-toggle="COIN_DYN">\n                                <input style="vertical-align: text-top;" type="radio" name="COIN_TYPE">\n                                给动态中的的视频投币\n                            </div>\n                        </div>\n                        <div data-toggle="SHARE" style=" color: black">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            分享视频\n                        </div>\n                        <div data-toggle="SILVER2COIN" style=" color: black">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            银瓜子换硬币\n                        </div>\n                        <div data-toggle="LIVE_SIGN" style=" color: black">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            直播区签到\n                        </div>\n                        <div data-toggle="AUTO_GROUP_SIGN" style=" color: darkgreen">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            应援团签到\n                        </div>\n                    </fieldset>\n                    <fieldset class="igiftMsg_fs">\n                        <legend style="color: black">自动送礼设置</legend>\n                        <div data-toggle="AUTO_GIFT" style=" color: purple">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            自动送礼\n                        </div>\n            \n                        <div data-toggle="AUTO_GIFT_ROOMID" style=" color: purple">\n                            优先送礼房间\n                            <input class="num igiftMsg_input" style="width: 150px;" type="text">\n                        </div>\n            \n                        <div data-toggle="EXCLUDE_ROOMID" style=" color: purple">\n                            不送礼房间\n                            <input class="num igiftMsg_input" style="width: 150px;" type="text">\n                        </div>\n                        <div data-toggle="GIFT_INTERVAL" style=" color: black">\n                            <input style="vertical-align: text-top;" type="radio" name="GIFT_TYPE">\n                            间隔\n                            <input class="num igiftMsg_input" style="width: 30px;" type="text">\n                            分钟送礼\n                        </div>\n                        <div data-toggle="GIFT_SEND_TIME" style=" color: purple">\n                            <input style="vertical-align: text-top;" type="radio" name="GIFT_TYPE">\n                            定时送礼<br>&nbsp;&nbsp;&nbsp;&nbsp;\n                            送礼时间\n                            <input class="Hour igiftMsg_input" style="width: 20px;" type="text">点\n                            <input class="Minute igiftMsg_input" style="width: 20px;" type="text">分\n                            &nbsp;<button style="font-size: small" class="igiftMsg_btn" data-action="sendGiftNow">立刻开始送礼</button>\n                        </div>\n                        \n                        <div data-toggle="GIFT_LIMIT" style=" color: purple">\n                            礼物到期时间\n                            <input class="num igiftMsg_input" style="width: 20px;" type="text">\n                            天\n                        </div>\n                        <div data-toggle="GIFT_SORT_HIGH" style=" color: black;line-height: 20px;">\n                        粉丝牌送礼优先级<br>\n                        &nbsp;&nbsp;&nbsp;&nbsp;<input style="vertical-align: text-top;" type="radio" name = "GIFT_SORT">\n                            优先<strong style="color: purple">高</strong>等级粉丝牌\n                        </div>\n                        <div data-toggle="GIFT_SORT_LOW" style=" color: black">\n                        &nbsp;&nbsp;&nbsp;&nbsp;<input style="vertical-align: text-top;" type="radio" name = "GIFT_SORT">\n                        优先<strong style="color: purple">低</strong>等级粉丝牌\n                        </div>\n                        <div data-toggle="SEND_ALL_GIFT" style="color: #ff5200;line-height:15px;">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            无视礼物类型和到期时间限制\n                        </div>\n                        <div data-toggle="SPARE_GIFT_ROOM" style="color: black;line-height:20px;">\n                            剩余礼物送礼直播间：\n                            <input class="num igiftMsg_input" type="text" style="width: 100px;">\n                        </div>\n                    </fieldset>\n                    <fieldset class="igiftMsg_fs">\n                        <legend style="color: black">节奏风暴设置</legend>\n                        <div data-toggle="STORM" style="line-height: 15px">\n                            <label style="margin: 5px auto; color: #ff5200">\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                参与节奏风暴\n                            </label>\n                        </div>\n                        <div data-toggle="STORM_QUEUE_SIZE" style="color: black">\n                            允许同时参与的节奏风暴次数：\n                            <input class="num igiftMsg_input" type="text" style="width: 30px;">\n                        </div>\n                        <div data-toggle="STORM_MAX_COUNT" style="color: black">\n                            单个风暴最大尝试次数：\n                            <input class="num igiftMsg_input" type="text" style="width: 30px;">\n                        </div>\n                        <div data-toggle="STORM_ONE_LIMIT" style="color: black">\n                            单个风暴参与次数间隔：\n                            <input class="num igiftMsg_input" type="text" style="width: 30px;">\n                            毫秒\n                        </div>\n                    </fieldset>\n                </div>\n            \n            \n            \n                <div id="right_fieldset" style=${o}>\n                    <fieldset class="igiftMsg_fs">\n                        <legend style="color: black">购买粉丝勋章</legend>\n                        <div data-toggle="BUY_MEDAL" style="color: black; line-height: 15px">\n                        输入粉丝勋章对应房间号：<input class="num igiftMsg_input" type="text" value = ${Live_info.room_id} onclick="select();" style="width: 70px">\n                        &nbsp;<button  class="igiftMsg_btn" data-action="buy_medal">点击购买勋章</button>\n                        （花费20硬币）\n                    </div>\n                    </fieldset>\n                    <fieldset class="igiftMsg_fs">\n                        <legend style="color: black">小心心</legend>\n                        <div data-toggle="LITTLE_HEART" style="line-height: 15px">\n                            <label style="margin: 5px auto; color: black">\n                                <input style="vertical-align: text-top;" type="checkbox"> 自动获取小心心\n                            </label>\n                        </div>\n                        <div data-toggle="LIGHT_MEDALS" style=" color: purple">\n                            自动点亮勋章房间号\n                        <input class="num igiftMsg_input" style="width: 300px;" type="text">\n                    </div>\n                    <div data-toggle="LIGHT_METHOD" style="line-height: 15px; color: black; display:inline">\n                        勋章点亮模式：&nbsp;&nbsp;\n                        <div data-toggle="LIGHT_WHITE" style="color: black; display:inline">\n                            <input style="vertical-align: text-top;" type="radio" name="LIGHT_TYPE">\n                            白名单\n                        </div>\n                        <div data-toggle="LIGHT_BLACK" style="color: black; display:inline">\n                            &nbsp;\n                            <input style="vertical-align: text-top;" type="radio" name="LIGHT_TYPE">\n                            黑名单\n                        </div>\n                        &nbsp;<button style="font-size: small" class="igiftMsg_btn" data-action="lightMedalNow">立刻点亮勋章</button>\n                    </div>\n                    <div data-toggle="FORCE_LIGHT" style="line-height: 15px">\n                    <label style="margin: 5px auto; color: black">\n                        <input style="vertical-align: text-top;" type="checkbox"> 点亮勋章时忽略亲密度上限\n                    </label>\n                    </div>\n                    </fieldset>\n                    <fieldset class="igiftMsg_fs">\n                        <legend style="color: black">天选时刻</legend>\n                        <div data-toggle="ANCHOR_LOTTERY" style="line-height: 15px">\n                            <label style="margin: 5px auto; color: purple">\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                参加天选时刻抽奖\n                            </label>\n                        </div>\n                        <div data-toggle="ANCHOR_CHECK_INTERVAL" style="line-height: 15px">\n                            <label style="margin: 5px auto; color: black">\n                                天选检查房间间隔\n                                <input class="num igiftMsg_input" style="width: 25px;" type="text">\n                                分钟\n                            </label>\n                        </div>\n                        <div data-toggle="ANCHOR_MAXROOM" style="line-height: 15px">\n                            <label style="margin: 5px auto; color: black">\n                                检查房间最大数量\n                                <input class="roomNum igiftMsg_input" style="width: 50px;" type="text">\n                            </label>\n                        </div>\n                        <div data-toggle="AHCHOR_NEED_GOLD" style="line-height: 15px">\n                        <label style="margin: 5px auto; color: black">\n                            忽略所需金瓜子大于\n                            <input class="num igiftMsg_input" style="width: 50px;" type="text">\n                            的天选\n                        </label>\n                    </div>\n                        <div data-toggle="ANCHOR_IGNORE_BLACKLIST" style="line-height: 15px">\n                            <label style="margin: 5px auto; color: black">\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                忽略关键字\n                                <label class = 'str' style = 'font-weight:bold'>${MY_API.CONFIG.ANCHOR_BLACKLIST_WORD.length}个</label>\n                                &nbsp;<button style="font-size: small" class="igiftMsg_btn" data-action="edit_ANCHOR_BLACKLIST_WORD">编辑</button>\n                            </label>\n                        </div>\n                        <div data-toggle="ANCHOR_INTERVAL" style="line-height: 15px">\n                        <label style="margin: 5px auto; color: black">\n                            请求间隔\n                            <input class="num igiftMsg_input" style="width: 30px;" type="text">\n                            毫秒\n                        </label>\n                    </div>\n                        &nbsp;<button data-action="saveFollowingList" class="igiftMsg_btn">保存当前关注列表为白名单</button>\n                            &nbsp;<button data-action="removeAnchorFollowing" class="igiftMsg_btn" style="color: red;">取关不在白名单内的UP主</button>\n                    </fieldset>\n                    <fieldset class="igiftMsg_fs">\n                        <legend style="color: black">内容屏蔽</legend>\n                        <div data-toggle="REMOVE_ELEMENT_2233" style="line-height: 15px">\n                            <label style="margin: 5px auto; color: black">\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                移除2233模型\n                            </label>\n                        </div>\n                        <div data-toggle="REMOVE_ELEMENT_activity" style="line-height: 15px">\n                            <label style="margin: 5px auto; color: black">\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                移除活动入口\n                            </label>\n                        </div>\n                        <div data-toggle="REMOVE_ELEMENT_rank" style="line-height: 15px">\n                        <label style="margin: 5px auto; color: black">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            移除排行榜\n                        </label>\n                    </div>\n                        <div data-toggle="NOSLEEP">\n                        <label style="margin: 5px auto; color: black">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            屏蔽挂机检测\n                        </label>\n                    </div>\n                    </fieldset>\n                    <fieldset class="igiftMsg_fs" style="line-height: 25px">\n                        <legend style="color: black">弹幕设置</legend>\n                        <div data-toggle="AUTO_DANMU">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            自动发弹幕<br>\n                            弹幕内容\n                            <input class="Danmu igiftMsg_input" style="width: 330px;" type="text"><br>\n                            房间号\n                            <input class="Roomid igiftMsg_input" style="width: 330px;" type="text"><br>\n                            发送时间\n                            <input class="Time igiftMsg_input" style="width: 330px;" type="text">\n                        </div>\n                        &nbsp;<button style="font-size: small" class="igiftMsg_btn" data-action="sendDanmuNow">立刻发送弹幕</button>\n                        &nbsp;<button style="font-size: small" class="igiftMsg_btn" data-action="clearDanmuCache">清除弹幕缓存</button>\n                    </fieldset>\n                    <fieldset class="igiftMsg_fs" style="line-height: 15px">\n                        <legend style="color: black">其他设置</legend>\n                        <div data-toggle="TIME_RELOAD" style="color: black">\n                        <input style="vertical-align: text-top;" type="checkbox">\n                            每\n                            <input class="delay-seconds igiftMsg_input" type="text" style="width: 30px;">\n                            分钟刷新一次页面\n                        </div>\n                        <div data-toggle="IN_TIME_RELOAD_DISABLE" style="line-height: 20px">\n                            <label style="margin: 5px auto">\n                                <input style="vertical-align: text-top;" type="checkbox">\n                                不抽奖时段不刷新直播间\n                            </label>\n                        </div>\n                        <div data-toggle="FT_NOTICE" style="line-height: 20px">\n                        <label style="margin: 5px auto; color: darkgreen">\n                            <input style="vertical-align: text-top;" type="checkbox">\n                            实物/天选中奖后通过${linkMsg("方糖","http://sc.ftqq.com/")}推送通知<br>\n                            &nbsp;&nbsp;&nbsp;&nbsp;\n                            SCKEY\n                            <input class="str igiftMsg_input" type="text" style="width: 350px;">\n                        </label>\n                        </div>\n                        <div id="resetArea">\n                            &nbsp;<button data-action="reset" style="color: red;" class="igiftMsg_btn">重置所有为默认</button>\n                            &nbsp;<button data-action="redo_dailyTasks" style="color: red;" class="igiftMsg_btn">再次执行所有任务</button>\n                            &nbsp;<button style="font-size: small" class="igiftMsg_btn" data-action="countReset">重置统计</button>\n                        </div>\n            \n                    </fieldset>\n                    <label style="color: darkblue; font-size:large;">\n                         <a href="https://github.com/andywang425/BLTH"\n                            target="_blank">v${GM_info.script.version}&nbsp;更多信息见github上的项目说明(点我)</a>\n                    </label>\n                </div>\n            </div>`,r=()=>mainIndex=layer.open({type:1,title:!1,offset:[String(n.top-getScrollPosition().y)+"px",String(n.left)+"px"],closeBtn:0,shade:0,zIndex:9998,fixed:!1,area:[,String(i)+"px"],resize:!1,content:a,success:()=>{const t=$("#allsettings");t.find('div[data-toggle="FT_NOTICE"] .str').val(MY_API.CONFIG.FT_SCKEY.toString()),t.find('div[data-toggle="ANCHOR_INTERVAL"] .num').val(parseInt(MY_API.CONFIG.ANCHOR_INTERVAL).toString()),t.find('div[data-toggle="AHCHOR_NEED_GOLD"] .num').val(parseInt(MY_API.CONFIG.AHCHOR_NEED_GOLD).toString()),t.find('div[data-toggle="ANCHOR_MAXROOM"] .roomNum').val(parseInt(MY_API.CONFIG.ANCHOR_MAXROOM).toString()),t.find('div[data-toggle="ANCHOR_CHECK_INTERVAL"] .num').val(parseInt(MY_API.CONFIG.ANCHOR_CHECK_INTERVAL).toString()),t.find('div[data-toggle="MATERIAL_LOTTERY_REM"] .num').val(parseInt(MY_API.CONFIG.MATERIAL_LOTTERY_REM).toString()),t.find('div[data-toggle="MATERIAL_LOTTERY_CHECK_INTERVAL"] .num').val(parseInt(MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL).toString()),t.find('div[data-toggle="AUTO_DANMU"] .Time').val(MY_API.CONFIG.DANMU_INTERVAL_TIME.toString()),t.find('div[data-toggle="AUTO_DANMU"] .Roomid').val(MY_API.CONFIG.DANMU_ROOMID.toString()),t.find('div[data-toggle="AUTO_DANMU"] .Danmu').val(MY_API.CONFIG.DANMU_CONTENT.toString()),t.find('div[data-toggle="MAX_TAB"] .num').val(parseInt(MY_API.CONFIG.MAX_TAB).toString()),t.find('div[data-toggle="GIFT_INTERVAL"] .num').val(parseInt(MY_API.CONFIG.GIFT_INTERVAL).toString()),t.find('div[data-toggle="LIGHT_MEDALS"] .num').val(MY_API.CONFIG.LIGHT_MEDALS.toString()),t.find('div[data-toggle="STORM_MAX_COUNT"] .num').val(parseInt(MY_API.CONFIG.STORM_MAX_COUNT).toString()),t.find('div[data-toggle="STORM_ONE_LIMIT"] .num').val(parseInt(MY_API.CONFIG.STORM_ONE_LIMIT).toString()),t.find('div[data-toggle="STORM_QUEUE_SIZE"] .num').val(parseInt(MY_API.CONFIG.STORM_QUEUE_SIZE).toString()),t.find('div[data-toggle="SPARE_GIFT_ROOM"] .num').val(MY_API.CONFIG.SPARE_GIFT_ROOM.toString()),t.find('div[data-toggle="TIME_RELOAD"] .delay-seconds').val(parseInt(MY_API.CONFIG.TIME_RELOAD_MINUTE).toString()),t.find('div[data-toggle="RANDOM_SKIP"] .per').val(parseFloat(MY_API.CONFIG.RANDOM_SKIP).toString()),t.find('div[data-toggle="RANDOM_SEND_DANMU"] .per').val(parseFloat(MY_API.CONFIG.RANDOM_SEND_DANMU).toString()),t.find('div[data-toggle="MAX_GIFT"] .num').val(parseInt(MY_API.CONFIG.MAX_GIFT).toString()),t.find('div[data-toggle="COIN"] .coin_number').val(parseInt(MY_API.CONFIG.COIN_NUMBER).toString()),t.find('div[data-toggle="COIN_UID"] .num').val(parseInt(MY_API.CONFIG.COIN_UID).toString()),t.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_START').val(parseFloat(MY_API.CONFIG.RND_DELAY_START).toString()),t.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_END').val(parseFloat(MY_API.CONFIG.RND_DELAY_END).toString()),t.find('div[data-toggle="TIME_AREA_DISABLE"] .startHour').val(parseInt(MY_API.CONFIG.TIME_AREA_START_H0UR).toString()),t.find('div[data-toggle="TIME_AREA_DISABLE"] .endHour').val(parseInt(MY_API.CONFIG.TIME_AREA_END_H0UR).toString()),t.find('div[data-toggle="TIME_AREA_DISABLE"] .startMinute').val(parseInt(MY_API.CONFIG.TIME_AREA_START_MINUTE).toString()),t.find('div[data-toggle="TIME_AREA_DISABLE"] .endMinute').val(parseInt(MY_API.CONFIG.TIME_AREA_END_MINUTE).toString()),t.find('div[data-toggle="CHECK_HOUR_ROOM"] .num').val(parseInt(MY_API.CONFIG.CHECK_HOUR_ROOM_INTERVAL).toString()),t.find('div[data-toggle="AUTO_GIFT_ROOMID"] .num').val(MY_API.CONFIG.AUTO_GIFT_ROOMID.toString()),t.find('div[data-toggle="EXCLUDE_ROOMID"] .num').val(MY_API.CONFIG.EXCLUDE_ROOMID.toString()),t.find('div[data-toggle="GIFT_SEND_TIME"] .Hour').val(MY_API.CONFIG.GIFT_SEND_HOUR.toString()),t.find('div[data-toggle="GIFT_SEND_TIME"] .Minute').val(MY_API.CONFIG.GIFT_SEND_MINUTE.toString()),t.find('div[data-toggle="GIFT_LIMIT"] .num').val(parseInt(MY_API.CONFIG.GIFT_LIMIT).toString());const e=()=>{let e=void 0,i=void 0,n=parseInt(t.find('div[data-toggle="TIME_AREA_DISABLE"] .startHour').val()),o=parseInt(t.find('div[data-toggle="TIME_AREA_DISABLE"] .endHour').val()),a=parseInt(t.find('div[data-toggle="TIME_AREA_DISABLE"] .startMinute').val()),r=parseInt(t.find('div[data-toggle="TIME_AREA_DISABLE"] .endMinute').val());if(n>=24||o>=24||a>=60||r>=60||n<0||o<0||a<0||r<0)MY_API.chatLog("[定时休眠]时间错误","warning");else if(MY_API.CONFIG.TIME_AREA_START_H0UR=n,MY_API.CONFIG.TIME_AREA_END_H0UR=o,MY_API.CONFIG.TIME_AREA_START_MINUTE=a,MY_API.CONFIG.TIME_AREA_END_MINUTE=r,(e=parseFloat(t.find('div[data-toggle="RANDOM_SKIP"] .per').val()))<0||e>100)MY_API.chatLog("[随机跳过礼物]数据小于0或大于100","warning");else if(MY_API.CONFIG.RANDOM_SKIP=e,(e=parseFloat(t.find('div[data-toggle="RANDOM_SEND_DANMU"] .per').val()))>5)MY_API.chatLog("[活跃弹幕]为维护直播间弹幕氛围,弹幕发送概率不得大于5%","warning");else if(e<0)MY_API.chatLog("[活跃弹幕]数据小于0","warning");else if(MY_API.CONFIG.RANDOM_SEND_DANMU=e,e=parseInt(t.find('div[data-toggle="MAX_GIFT"] .num').val()),MY_API.CONFIG.MAX_GIFT=e,(e=parseInt(t.find('div[data-toggle="TIME_RELOAD"] .delay-seconds').val()))<=0||e>1e4)MY_API.chatLog("[直播间重载时间]数据小于等于0或大于10000","warning");else if(MY_API.CONFIG.TIME_RELOAD_MINUTE=e,e=parseFloat(t.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_START').val()),o=parseFloat(t.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_END').val()),e<0||o>100)MY_API.chatLog("[抽奖延时]数据小于0或大于100","warning");else if(o<=e)MY_API.chatLog("[抽奖延时]数据大小关系不正确","warning");else if(MY_API.CONFIG.RND_DELAY_START=e,MY_API.CONFIG.RND_DELAY_END=o,(e=parseInt(t.find('div[data-toggle="COIN"] .coin_number').val()))<0||e>5)MY_API.chatLog("[自动投币]数据小于0或大于5","warning");else if(MY_API.CONFIG.COIN_NUMBER=e,(e=parseInt(t.find('div[data-toggle="CHECK_HOUR_ROOM"] .num').val()))<=0)MY_API.chatLog("[检查小时榜间隔]数据小于等于0","warning");else{MY_API.CONFIG.CHECK_HOUR_ROOM_INTERVAL=e,i=(e=t.find('div[data-toggle="AUTO_GIFT_ROOMID"] .num').val()).split(",");for(let t=0;t<i.length;t++)""===i[t]&&(i[t]=22474988);MY_API.CONFIG.AUTO_GIFT_ROOMID=i,i=(e=t.find('div[data-toggle="EXCLUDE_ROOMID"] .num').val()).split(",");for(let t=0;t<i.length;t++)""===i[t]&&(i[t]=0);if(MY_API.CONFIG.EXCLUDE_ROOMID=i,e=parseInt(t.find('div[data-toggle="GIFT_LIMIT"] .num').val()),MY_API.CONFIG.GIFT_LIMIT=e,n=parseInt(t.find('div[data-toggle="GIFT_SEND_TIME"] .Hour').val()),o=parseInt(t.find('div[data-toggle="GIFT_SEND_TIME"] .Minute').val()),n<0||o<0)MY_API.chatLog("[送礼时间]数据小于0","warning");else if(n>=24||o>=60)MY_API.chatLog("[送礼时间]时间错误","warning");else{MY_API.CONFIG.GIFT_SEND_HOUR=n,MY_API.CONFIG.GIFT_SEND_MINUTE=o,e=t.find('div[data-toggle="SPARE_GIFT_ROOM"] .num').val(),MY_API.CONFIG.SPARE_GIFT_ROOM=e,e=parseInt(t.find('div[data-toggle="STORM_QUEUE_SIZE"] .num').val()),MY_API.CONFIG.STORM_QUEUE_SIZE=e,e=parseInt(t.find('div[data-toggle="STORM_MAX_COUNT"] .num').val()),MY_API.CONFIG.STORM_MAX_COUNT=e,e=parseInt(t.find('div[data-toggle="STORM_ONE_LIMIT"] .num').val()),MY_API.CONFIG.STORM_ONE_LIMIT=e,e=parseInt(t.find('div[data-toggle="COIN_UID"] .num').val()),MY_API.CONFIG.COIN_UID=e,i=(e=t.find('div[data-toggle="LIGHT_MEDALS"] .num').val()).split(",");for(let t=0;t<i.length;t++)""===i[t]&&(i[t]=0);MY_API.CONFIG.LIGHT_MEDALS=i,e=parseInt(t.find('div[data-toggle="MAX_TAB"] .num').val()),MY_API.CONFIG.MAX_TAB=e,i=(n=t.find('div[data-toggle="AUTO_DANMU"] .Danmu').val()).split(",");for(let t=0;t<i.length;t++)""===i[t]&&(i[t]="这是一条弹幕");n=i,i=(o=t.find('div[data-toggle="AUTO_DANMU"] .Roomid').val()).split(",");for(let t=0;t<i.length;t++)""===i[t]&&(i[t]="22474988");o=i,i=(a=t.find('div[data-toggle="AUTO_DANMU"] .Time').val()).split(",");for(let t=0;t<i.length;t++)""===i[t]&&(i[t]="10m");if(a=i,MY_API.CONFIG.DANMU_CONTENT=n,MY_API.CONFIG.DANMU_ROOMID=o,MY_API.CONFIG.DANMU_INTERVAL_TIME=a,e=t.find('div[data-toggle="MATERIAL_LOTTERY_CHECK_INTERVAL"] .num').val(),MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL=parseInt(e),e=t.find('div[data-toggle="MATERIAL_LOTTERY_REM"] .num').val(),isNaN(e)&&(e=9),MY_API.CONFIG.MATERIAL_LOTTERY_REM=parseInt(e),e=t.find('div[data-toggle="ANCHOR_CHECK_INTERVAL"] .num').val(),MY_API.CONFIG.ANCHOR_CHECK_INTERVAL=e,e=t.find('div[data-toggle="ANCHOR_MAXROOM"] .roomNum').val(),MY_API.CONFIG.ANCHOR_MAXROOM=e,e=t.find('div[data-toggle="AHCHOR_NEED_GOLD"] .num').val(),MY_API.CONFIG.AHCHOR_NEED_GOLD=parseInt(e),!((e=t.find('div[data-toggle="ANCHOR_INTERVAL"] .num').val())<0))return MY_API.CONFIG.ANCHOR_INTERVAL=parseInt(e),e=t.find('div[data-toggle="FT_NOTICE"] .str').val(),MY_API.CONFIG.FT_SCKEY=e,MY_API.saveConfig();MY_API.chatLog("[请求间隔]数据小于0","warning")}}};t.find('div[id="giftCount"] [data-action="save"]').click(()=>{e()}),t.find('div[data-toggle="BUY_MEDAL"] [data-action="buy_medal"]').click(function(){const e=parseInt(t.find('div[data-toggle="BUY_MEDAL"] .num').val());MY_API.buyFanMedal(e)}),t.find('button[data-action="reset"]').click(()=>{MY_API.setDefaults()}),t.find('button[data-action="checkUpdate"]').click(()=>{MY_API.checkUpdate()}),t.find('button[data-action="redo_dailyTasks"]').click(()=>{MY_API.ReDoDailyTasks()}),t.find('#resetArea [data-action="countReset"]').click(()=>{MY_API.GIFT_COUNT={COUNT:0,SILVER_COUNT:0,CLEAR_TS:0},MY_API.saveGiftCount(),$("#giftCount span:eq(0)").text(MY_API.GIFT_COUNT.COUNT),$("#giftCount span:eq(1)").text(MY_API.GIFT_COUNT.SILVER_COUNT),MY_API.chatLog("已重置统计数据")}),t.find('button[data-action="edit_QUESTIONABLE_LOTTERY"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.QUESTIONABLE_LOTTERY),title:"请输入实物抽奖忽略关键字"},function(e,i){let n=e.split(",");for(let t=0;t<n.length;t++)""===n[t]&&(n[t]="test");MY_API.CONFIG.QUESTIONABLE_LOTTERY=n,MY_API.saveConfig(!1),layer.msg("实物抽奖忽略关键字保存成功",{time:2500,icon:1}),t.find('div[data-toggle="MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY"] label.str').html(MY_API.CONFIG.QUESTIONABLE_LOTTERY.length+"个"),layer.close(i)})}),t.find('button[data-action="edit_ANCHOR_BLACKLIST_WORD"]').click(()=>{layer.prompt({formType:2,value:String(MY_API.CONFIG.ANCHOR_BLACKLIST_WORD),title:"请输入天选时刻忽略关键字"},function(e,i){let n=e.split(",");for(let t=0;t<n.length;t++)""===n[t]&&(n[t]="钓鱼");MY_API.CONFIG.ANCHOR_BLACKLIST_WORD=n,MY_API.saveConfig(!1),layer.msg("天选时刻忽略关键字保存成功",{time:2500,icon:1}),t.find('div[data-toggle="ANCHOR_IGNORE_BLACKLIST"] label.str').html(MY_API.CONFIG.ANCHOR_BLACKLIST_WORD.length+"个"),layer.close(i)})}),t.find('button[data-action="saveFollowingList"]').click(()=>{if(getFollowBtnClickable)return getFollowBtnClickable=!1,setTimeout(function(){getFollowBtnClickable=!0},2e3),window.toast("[保存当前关注列表为白名单] 开始获取关注列表"),MY_API.AnchorLottery.getFollowingList()}),t.find('button[data-action="removeAnchorFollowing"]').click(()=>{if(unFollowBtnClickable)return unFollowBtnClickable=!1,setTimeout(function(){unFollowBtnClickable=!0},2e3),window.toast("[取关不在白名单内的UP主] 开始获取关注列表并取消关注"),MY_API.AnchorLottery.delAnchorFollowing()}),t.find('button[data-action="sendGiftNow"]').click(()=>{MY_API.CONFIG.AUTO_GIFT?(SEND_GIFT_NOW=!0,MY_API.Gift.run()):window.toast("[立刻开始送礼] 请先勾选【自动送礼】再点击此按钮","info")}),t.find('button[data-action="lightMedalNow"]').click(()=>{MY_API.CONFIG.AUTO_GIFT?(LIGHT_MEDAL_NOW=!0,MY_API.Gift.run()):window.toast("[立刻点亮勋章] 请先勾选【自动送礼】再点击此按钮","info")}),t.find('button[data-action="sendDanmuNow"]').click(()=>{MY_API.CONFIG.AUTO_DANMU?(SEND_DANMU_NOW=!0,MY_API.AUTO_DANMU.run()):window.toast("[立刻发送弹幕] 请先勾选【自动发弹幕】再点击此按钮","info")}),t.find('button[data-action="clearDanmuCache"]').click(()=>{MY_API.CACHE.AUTO_SEND_DANMU_TS=[],MY_API.saveCache()&&MY_API.chatLog("清除弹幕缓存成功","success")});const i=["AUTO_DANMU","RANDOM_DELAY","TIME_AREA_DISABLE","AUTO_GROUP_SIGN","FORCE_LOTTERY","LOGIN","WATCH","COIN","SHARE","SILVER2COIN","LIVE_SIGN","IN_TIME_RELOAD_DISABLE","TIME_RELOAD","IN_TIME_RELOAD_DISABLE","AUTO_GIFT","SEND_ALL_GIFT","STORM","LITTLE_HEART","REMOVE_ELEMENT_2233","REMOVE_ELEMENT_activity","REMOVE_ELEMENT_rank","FORCE_LIGHT","LOTTERY","CHECK_HOUR_ROOM","NOSLEEP","MATERIAL_LOTTERY","MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY","ANCHOR_IGNORE_BLACKLIST","ANCHOR_LOTTERY","FT_NOTICE"];for(const n of i){const i=t.find(`div[data-toggle="${n}"] input:checkbox`);MY_API.CONFIG[n]&&i.attr("checked",""),i.change(function(){MY_API.CONFIG[n]=$(this).prop("checked"),e()})}$("input:text").bind("keydown",function(t){13==t.keyCode&&e()}),"COIN_DYN"==MY_API.CONFIG.COIN_TYPE?$("div[data-toggle='COIN_DYN'] input:radio").attr("checked",""):$("div[data-toggle='COIN_UID'] input:radio").attr("checked",""),"LIGHT_WHITE"==MY_API.CONFIG.LIGHT_METHOD?$("div[data-toggle='LIGHT_WHITE'] input:radio").attr("checked",""):$("div[data-toggle='LIGHT_BLACK'] input:radio").attr("checked",""),"GIFT_INTERVAL"==MY_API.CONFIG.GIFT_METHOD?$("div[data-toggle='GIFT_INTERVAL'] input:radio").attr("checked",""):$("div[data-toggle='GIFT_SEND_TIME'] input:radio").attr("checked",""),"high"==MY_API.CONFIG.GIFT_SORT?$("div[data-toggle='GIFT_SORT_HIGH'] input:radio").attr("checked",""):$("div[data-toggle='GIFT_SORT_LOW'] input:radio").attr("checked",""),$("input:radio[name='COIN_TYPE']").change(function(){return $("div[data-toggle='COIN_DYN'] input:radio").is(":checked")?MY_API.CONFIG.COIN_TYPE="COIN_DYN":MY_API.CONFIG.COIN_TYPE="COIN_UID",e()}),$("input:radio[name='LIGHT_TYPE']").change(function(){return $("div[data-toggle='LIGHT_WHITE'] input:radio").is(":checked")?MY_API.CONFIG.LIGHT_METHOD="LIGHT_WHITE":MY_API.CONFIG.LIGHT_METHOD="LIGHT_BLACK",e()}),$("input:radio[name='GIFT_TYPE']").change(function(){return $("div[data-toggle='GIFT_INTERVAL'] input:radio").is(":checked")?MY_API.CONFIG.GIFT_METHOD="GIFT_INTERVAL":MY_API.CONFIG.GIFT_METHOD="GIFT_SEND_TIME",e()}),$("input:radio[name='GIFT_SORT']").change(function(){return $("div[data-toggle='GIFT_SORT_HIGH'] input:radio").is(":checked")?MY_API.CONFIG.GIFT_SORT="high":MY_API.CONFIG.GIFT_SORT="low",e()})},end:()=>{msgHide="hide",localStorage.setItem(`${NAME}_msgHide`,msgHide),$(".link-toast").hide(),document.getElementById("hiderbtn").innerHTML="显示窗口和提示信息"}});t.click(()=>{hideBtnClickable&&(hideBtnClickable=!1,setTimeout(function(){hideBtnClickable=!0},200),"show"==msgHide?(msgHide="hide",localStorage.setItem(`${NAME}_msgHide`,msgHide),$(".link-toast").hide(),layer.close(mainIndex),document.getElementById("hiderbtn").innerHTML="显示窗口和提示信息"):(msgHide="show",localStorage.setItem(`${NAME}_msgHide`,msgHide),$(".link-toast").show(),r(),document.getElementById("hiderbtn").innerHTML="隐藏窗口和提示信息"))}),e.click(()=>{layer.close(mainIndex),document.getElementById("hiderbtn").innerHTML="显示窗口和提示信息",layer.style(menuIndex,{display:"none"}),$("#menuDiv").removeClass("active"),$(".tab-list.dp-flex").children("li")[0].click()}),$(".attention-btn-ctnr").append(t),MY_API.CACHE.DailyReward_TS||(layer.tips("点我隐藏/显示控制面板","#hiderbtn",{tips:1}),setTimeout(()=>layer.tips("点我查看日志","#menuDiv",{tips:1}),6e3)),"show"==msgHide&&r()},chatLog:function(t,e="info"){let i=$("<div class='chatLogDiv'>"),n=$("<div class='chatLogMsg'>"),o=new Date;switch(n.html(t),i.text(o.toLocaleString()),i.append(n),e){case"warning":i.addClass("chatLogWarning");break;case"success":i.addClass("chatLogSuccess");break;case"error":i.addClass("chatLogError");break;case"prize":i.addClass("chatLogWinPrize");break;default:i.addClass("chatLogDefault")}$("#menuWindow").append(i),layerMenuWindow.scrollTo(0,layerMenuWindow.scrollHeight)},blocked:!1,max_blocked:!1,listen:(t,e,i="本直播间")=>{BAPI.room.getConf(t).then(n=>{MYDEBUG(`获取弹幕服务器信息 ${i}`,n);let o=new BAPI.DanmuWebSocket(e,t,n.data.host_server_list,n.data.token);o.bind(t=>{o=t,MY_API.chatLog(`${i}弹幕服务器连接断开，尝试重连`,"warning")},()=>{MY_API.chatLog(`——————连接弹幕服务器成功——————<br>房间号: ${t} 分区: ${i}`,"success")},()=>{(MY_API.blocked||MY_API.stormBlack)&&(o.close(),MY_API.chatLog(`进了小黑屋主动与弹幕服务器断开连接-${i}`,"warning")),MY_API.max_blocked&&!MY_API.CONFIG.STORM&&(o.close(),MY_API.chatLog(`辣条最大值主动与弹幕服务器断开连接-${i}`,"warning"))},t=>{if(!inTimeArea(MY_API.CONFIG.TIME_AREA_START_H0UR,MY_API.CONFIG.TIME_AREA_END_H0UR,MY_API.CONFIG.TIME_AREA_START_MINUTE,MY_API.CONFIG.TIME_AREA_END_MINUTE)||!MY_API.CONFIG.TIME_AREA_DISABLE)switch(MYDEBUG("弹幕公告"+i,t),t.cmd){case"GUARD_MSG":t.roomid===t.real_roomid?MY_API.checkRoom(t.roomid,i):(MY_API.checkRoom(t.roomid,i),MY_API.checkRoom(t.real_roomid,i));break;case"PK_BATTLE_SETTLE_USER":t.data.winner?MY_API.checkRoom(t.data.winner.room_id,i):MY_API.checkRoom(t.data.my_info.room_id,i),MY_API.checkRoom(t.data.winner.room_id,i);break;case"NOTICE_MSG":switch(t.msg_type){case 1:break;case 2:case 3:case 4:case 8:t.roomid===t.real_roomid?MY_API.checkRoom(t.roomid,i):(MY_API.checkRoom(t.roomid,i),MY_API.checkRoom(t.real_roomid,i));break;case 5:break;case 6:window.toast(`监控到房间 ${t.roomid} 的节奏风暴`,"info"),MY_API.Storm.run(t.roomid)}break;case"SPECIAL_GIFT":if(t.data[39])switch(t.data[39].action){case"start":window.toast(`监控到房间 ${t.roomid} 的节奏风暴`,"info"),MY_API.Storm.run(t.roomid)}break;default:return}})},()=>{MY_API.chatLog("获取弹幕服务器地址错误","error")})},EntryRoom_list_history:{add:function(t){let e=[];try{(e=[...JSON.parse(localStorage.getItem(`${NAME}_EntryRoom_list`)).list]).push(t),e.length>100&&e.splice(0,50),localStorage.setItem(`${NAME}_EntryRoom_list`,JSON.stringify({list:e}))}catch(i){e.push(t),localStorage.setItem(`${NAME}_EntryRoom_list`,JSON.stringify({list:e}))}},isIn:function(t){let e=[];try{const i=JSON.parse(localStorage.getItem(`${NAME}_EntryRoom_list`));return(e=null===i?[]:[...i.list]).indexOf(t)>-1}catch(i){return localStorage.setItem(`${NAME}_EntryRoom_list`,JSON.stringify({list:e})),MYDEBUG("读取"+`${NAME}_EntryRoom_list`+"缓存错误已重置"),e.indexOf(t)>-1}}},RoomId_list:[],err_roomId:[],auto_danmu_list:["(=・ω・=)","（￣▽￣）","nice","666","kksk","(⌒▽⌒)","(｀・ω・´)","╮(￣▽￣)╭","(￣3￣)","Σ( ￣□￣||)","(^・ω・^ )","_(:3」∠)_"],checkRoom:function(t,e="本直播间"){MY_API.blocked||MY_API.max_blocked||MY_API.RoomId_list.indexOf(t)>=0||(MY_API.RoomId_list.push(t),!MY_API.EntryRoom_list_history.isIn(t)&&MY_API.CONFIG.LOTTERY&&(BAPI.room.room_entry_action(t),MY_API.EntryRoom_list_history.add(t)),probability(MY_API.CONFIG.RANDOM_SEND_DANMU)&&BAPI.room.get_info(t).then(e=>{MYDEBUG(`API.room.get_info roomId=${t} res`,e),BAPI.sendLiveDanmu(MY_API.auto_danmu_list[Math.floor(Math.random()*MY_API.auto_danmu_list.length)],e.data.room_id).then(t=>{MYDEBUG("[活跃弹幕]弹幕发送返回信息",t)})}),BAPI.xlive.lottery.check(t).then(i=>{MY_API.RoomId_list.remove(t),MYDEBUG("检查房间返回信息",i);const n=i.data;if(0===i.code){if(n.gift){const i=n.gift;for(let n in i)i.hasOwnProperty(n)&&MY_API.creat_join(t,i[n],"gift",e)}if(n.guard){const i=n.guard;for(let n in i)i.hasOwnProperty(n)&&MY_API.creat_join(t,i[n],"guard",e)}if(n.pk){const i=n.pk;for(let n in i)i.hasOwnProperty(n)&&MY_API.creat_join(t,i[n],"pk",e)}}else MY_API.chatLog(`[检查房间出错]${response.msg}`,"error"),MY_API.err_roomId.indexOf(t)>-1?MYDEBUG(`[检查此房间出错多次]${t}${i.message}`):(MY_API.err_roomId.push(t),MY_API.checkRoom(t,e),MYDEBUG(`[检查房间出错_重试一次]${t}${i.message}`))}))},Id_list_history:{add:function(t,e){const i=[];try{i=[...JSON.parse(localStorage.getItem(`${NAME}_${e}Id_list`)).list],i.push(t),i.length>200&&i.splice(0,50),localStorage.setItem(`${NAME}_${e}Id_list`,JSON.stringify({list:i})),MYDEBUG(`${NAME}_${e}Id_list_add`,i)}catch(n){i.push(t),localStorage.setItem(`${NAME}_${e}Id_list`,JSON.stringify({list:i}))}},isIn:function(t,e){let i=[];try{const n=JSON.parse(localStorage.getItem(`${NAME}_${e}Id_list`));return i=null===n?[]:[...n.list],MYDEBUG(`${NAME}_${e}Id_list_read`,n),i.indexOf(t)>-1}catch(n){return localStorage.setItem(`${NAME}_${e}Id_list`,JSON.stringify({list:i})),MYDEBUG("读取"+`${NAME}_${e}Id_list`+"缓存错误已重置"),i.indexOf(t)>-1}}},raffleId_list:[],guardId_list:[],pkId_list:[],creat_join:function(t,e,i,n="本直播间"){if(MYDEBUG("礼物信息",e),MY_API.GIFT_COUNT.COUNT>=MY_API.CONFIG.MAX_GIFT)return MYDEBUG("超过今日辣条限制，不参与抽奖"),void(MY_API.max_blocked=!0);switch(i){case"gift":if(MY_API.Id_list_history.isIn(e.raffleId,"raffle"))return void MYDEBUG("礼物重复",`raffleId ${e.raffleId}`);MY_API.raffleId_list.push(e.raffleId),MY_API.Id_list_history.add(e.raffleId,"raffle");break;case"guard":if(MY_API.Id_list_history.isIn(e.id,"guard"))return void MYDEBUG("舰长重复",`id ${e.id}`);MY_API.guardId_list.push(e.id),MY_API.Id_list_history.add(e.id,"guard");break;case"pk":if(MY_API.Id_list_history.isIn(e.id,"pk"))return void MYDEBUG("pk重复",`id ${e.id}`);MY_API.pkId_list.push(e.id),MY_API.Id_list_history.add(e.id,"pk")}let o=e.time_wait||0;MY_API.CONFIG.RANDOM_DELAY&&(o+=Math.floor(Math.random()*(MY_API.CONFIG.RND_DELAY_END-MY_API.CONFIG.RND_DELAY_START+1))+MY_API.CONFIG.RND_DELAY_START);let a=$("<div class='chatLogLottery'>"),r=$("<div class='chatLogMsg'>"),l=$("<div>"),s=new Date;r.text(`[${n}]`+e.thank_text.split("<%")[1].split("%>")[0]+e.thank_text.split("%>")[1]),a.text(s.toLocaleString()),a.append(r),l.css("color","red"),l.text("等待抽奖"),r.append(l),$("#menuWindow").append(a),layerMenuWindow.scrollTo(0,layerMenuWindow.scrollHeight);let d=setInterval(()=>{if(l.text(`等待抽奖倒计时${o}秒`),o<=0){if(probability(MY_API.CONFIG.RANDOM_SKIP))l.text("跳过此礼物抽奖");else switch(l.text("进行抽奖..."),i){case"gift":MY_API.gift_join(t,e.raffleId,e.type).then(function(t,i){l.text(t),i&&(t.indexOf("辣条")>-1?MY_API.addGift(i):t.indexOf("银瓜子")>-1&&MY_API.addSilver(i)),MY_API.raffleId_list.remove(e.raffleId)});break;case"guard":MY_API.guard_join(t,e.id).then(function(t,i){l.text(t),i&&(t.indexOf("辣条")>-1?MY_API.addGift(i):t.indexOf("银瓜子")>-1&&MY_API.addSilver(i)),MY_API.guardId_list.remove(e.id)});break;case"pk":MY_API.pk_join(t,e.id).then(function(t,i){l.text(t),i&&(t.indexOf("辣条")>-1?MY_API.addGift(i):t.indexOf("银瓜子")>-1&&MY_API.addSilver(i)),MY_API.pkId_list.remove(e.id)})}l.css("color","green"),clearInterval(d)}o--},1e3)},gift_join:function(t,e,i){let n=$.Deferred();return BAPI.Lottery.Gift.join(t,e,i).then(o=>{switch(MYDEBUG("抽奖返回信息",o),o.code){case 0:o.data.award_text?n.resolve(o.data.award_text,o.data.award_num):n.resolve(o.data.award_name+"X"+o.data.award_num.toString(),o.data.award_num);break;default:o.msg.indexOf("拒绝")>-1?0==MY_API.CONFIG.FORCE_LOTTERY?(MY_API.blocked=!0,n.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):++gift_join_try<=5?MY_API.gift_join(t,e,i):(gift_join_try=0,n.resolve(`[礼物抽奖](roomid=${t},id=${e},type=${i})${o.msg}`)):n.resolve(`[礼物抽奖](roomid=${t},id=${e},type=${i})${o.msg}`)}}),n},guard_join:function(t,e){let i=$.Deferred();return BAPI.Lottery.Guard.join(t,e).then(n=>{switch(MYDEBUG("上船抽奖返回信息",n),n.code){case 0:n.data.award_text?i.resolve(n.data.award_text,n.data.award_num):i.resolve(n.data.award_name+"X"+n.data.award_num.toString(),n.data.award_num);break;default:n.msg.indexOf("拒绝")>-1?0==MY_API.CONFIG.FORCE_LOTTERY?(MY_API.blocked=!0,i.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):++guard_join_try<=5?MY_API.guard_join(t,id):(guard_join_try=0,i.resolve(`[礼物抽奖](roomid=${t},id=${raffleId},type=${type})${n.msg}`)):i.resolve(`[上船](roomid=${t},id=${e})${n.msg}`)}}),i},pk_join:function(t,e){let i=$.Deferred();return BAPI.Lottery.Pk.join(t,e).then(n=>{switch(MYDEBUG("PK抽奖返回信息",n),n.code){case 0:n.data.award_text?i.resolve(n.data.award_text,n.data.award_num):i.resolve(n.data.award_name+"X"+n.data.award_num.toString(),n.data.award_num);break;default:n.msg.indexOf("拒绝")>-1?0==MY_API.CONFIG.FORCE_LOTTERY?(MY_API.blocked=!0,i.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):++pk_join_try<=5?MY_API.pk_join(t,id):(pk_join_try=0,i.resolve(`[礼物抽奖](roomid=${t},id=${raffleId},type=${type})${n.msg}`)):i.resolve(`[PK](roomid=${t},id=${e})${n.msg}`)}}),i},GroupSign:{getGroups:()=>BAPI.Group.my_groups().then(t=>(MYDEBUG("GroupSign.getGroups: API.Group.my_groups",t),0===t.code?$.Deferred().resolve(t.data.list):(window.toast(`[自动应援团签到]'${t.msg}`,"caution"),$.Deferred().reject())),()=>(window.toast("[自动应援团签到]获取应援团列表失败，请检查网络","error"),delayCall(()=>MY_API.GroupSign.getGroups()))),signInList:(t,e=0)=>{if(e>=t.length)return $.Deferred().resolve();const i=t[e];return i.owner_uid==Live_info.uid?MY_API.GroupSign.signInList(t,e+1):BAPI.Group.sign_in(i.group_id,i.owner_uid).then(n=>{MYDEBUG("GroupSign.signInList: API.Group.sign_in",n);let o=$.Deferred();return 0!==n.code?(window.toast(`[自动应援团签到]'${n.msg}`,"caution"),$.Deferred().reject()):(n.data.add_num>0?(window.toast(`[自动应援团签到]应援团(group_id=${i.group_id},owner_uid=${i.owner_uid})签到成功，当前勋章亲密度+${n.data.add_num}`,"success"),o.resolve()):0==n.data.add_num?(window.toast(`[自动应援团签到]应援团(group_id=${i.group_id},owner_uid=${i.owner_uid})已签到`,"caution"),o.resolve()):o.reject(),$.when(MY_API.GroupSign.signInList(t,e+1),o))},()=>(window.toast(`[自动应援团签到]应援团(group_id=${i.group_id},owner_uid=${i.owner_uid})签到失败，请检查网络`,"error"),delayCall(()=>MY_API.GroupSign.signInList(t,e))))},run:()=>{try{return MY_API.CONFIG.AUTO_GROUP_SIGN?checkNewDay(MY_API.CACHE.AUTO_GROUP_SIGH_TS)?(new Date).getHours()<8&&0!=MY_API.CACHE.AUTO_GROUP_SIGH_TS?(setTimeout(MY_API.GroupSign.run,getIntervalTime(8,0)),$.Deferred().resolve()):MY_API.GroupSign.getGroups().then(t=>MY_API.GroupSign.signInList(t).then(()=>(MY_API.CACHE.AUTO_GROUP_SIGH_TS=ts_ms(),MY_API.saveCache(),runTomorrow(MY_API.GroupSign.run,8,0,"应援团签到"),$.Deferred().resolve()),()=>delayCall(()=>MY_API.GroupSign.run())),()=>delayCall(()=>MY_API.GroupSign.run())):(runTomorrow(MY_API.GroupSign.run,8,0,"应援团签到"),$.Deferred().resolve()):$.Deferred().resolve()}catch(t){return window.toast("[自动应援团签到]运行时出现异常，已停止","error"),console.error(`[${NAME}]`,t),$.Deferred().reject()}}},DailyReward:{coin_exp:0,login:()=>BAPI.DailyReward.login().then(()=>{MYDEBUG("DailyReward.login: API.DailyReward.login"),window.toast("[自动每日奖励][每日登录]完成","success")},()=>(window.toast("[自动每日奖励][每日登录]完成失败，请检查网络","error"),delayCall(()=>MY_API.DailyReward.login()))),watch:(t,e)=>MY_API.CONFIG.WATCH?BAPI.DailyReward.watch(t,e,Live_info.uid,ts_s()).then(e=>{MYDEBUG("DailyReward.watch: API.DailyReward.watch",e),0===e.code?window.toast(`[自动每日奖励][每日观看]完成(av=${t})`,"success"):window.toast(`[自动每日奖励][每日观看]'${e.msg}`,"caution")},()=>(window.toast("[自动每日奖励][每日观看]完成失败，请检查网络","error"),delayCall(()=>MY_API.DailyReward.watch(t,e)))):$.Deferred().resolve(),coin:(t,e,i=0,n=!1)=>{if(!MY_API.CONFIG.COIN)return $.Deferred().resolve();if(MY_API.DailyReward.coin_exp>=10*MY_API.CONFIG.COIN_NUMBER)return window.toast("[自动每日奖励][每日投币]今日投币已完成","info"),$.Deferred().resolve();if(i>=t.length)return window.toast("[自动每日奖励][每日投币]动态里可投币的视频不足","caution"),$.Deferred().resolve();const o=JSON.parse(t[i].card);let a=Math.min(2,e);return n&&(a=1),BAPI.x.getCoinInfo("","jsonp",o.aid,ts_ms()).then(r=>2===r.data.multiply?(MYDEBUG("API.x.getCoinInfo",`已投币两个 aid = ${o.aid}`),MY_API.DailyReward.coin(vlist,e,i+1)):(1===r.data.multiply&&(a=1),BAPI.DailyReward.coin(o.aid,a).then(r=>(MYDEBUG("DailyReward.coin: API.DailyReward.coin",r),0===r.code?(MY_API.DailyReward.coin_exp+=10*a,window.toast(`[自动每日奖励][每日投币]投币成功(av=${o.aid},num=${a})`,"success"),MY_API.DailyReward.coin(t,e-a,i+1)):-110===r.code?(window.toast("[自动每日奖励][每日投币]未绑定手机，已停止","error"),$.Deferred().reject()):34003===r.code?n?MY_API.DailyReward.coin(t,e,i+1):MY_API.DailyReward.coin(t,e,i,!0):34005===r.code?MY_API.DailyReward.coin(t,e,i+1):-104===r.code?(window.toast("[自动每日奖励][每日投币]剩余硬币不足，已停止","warning"),$.Deferred().reject()):(window.toast(`[自动每日奖励][每日投币]'${r.msg}`,"caution"),MY_API.DailyReward.coin(t,e,i+1))),()=>delayCall(()=>MY_API.DailyReward.coin(t,e,i)))))},coin_uid:(t,e,i,n,o=0,a=!1)=>{if(!MY_API.CONFIG.COIN)return $.Deferred().resolve();if(MY_API.DailyReward.coin_exp>=10*MY_API.CONFIG.COIN_NUMBER)return window.toast("[自动每日奖励][每日投币]今日投币已完成","info"),$.Deferred().resolve();if(o>=t.length)return MY_API.DailyReward.UserSpace(MY_API.CONFIG.COIN_UID,30,0,i++,"","pubdate","jsonp");const r=t[o];if(r.hasOwnProperty("is_union_video")&&1===r.is_union_video&&r.mid!=n)return MYDEBUG("DailyReward.coin_uid",`联合投稿且UP不是指定UID用户 aid = ${r.aid}`),MY_API.DailyReward.coin_uid(t,e,i,n,o+1);let l=Math.min(2,e);return a&&(l=1),BAPI.x.getCoinInfo("","jsonp",r.aid,ts_ms()).then(s=>2===s.data.multiply?(MYDEBUG("API.x.getCoinInfo",`已投币两个 aid = ${r.aid}`),MY_API.DailyReward.coin_uid(t,e,i,n,o+1)):(1===s.data.multiply&&(l=1),BAPI.DailyReward.coin(r.aid,l).then(s=>(MYDEBUG("DailyReward.coin_uid: API.DailyReward.coin_uid",s),0===s.code?(MY_API.DailyReward.coin_exp+=10*l,window.toast(`[自动每日奖励][每日投币]投币成功(av=${r.aid},num=${l})`,"success"),MY_API.DailyReward.coin_uid(t,e-l,i,n,o+1)):-110===s.code?(window.toast("[自动每日奖励][每日投币]未绑定手机，已停止","error"),$.Deferred().reject()):34003===s.code?a?MY_API.DailyReward.coin_uid(t,e,i,n,o+1):MY_API.DailyReward.coin_uid(t,e,o,i,n,!0):34005===s.code?MY_API.DailyReward.coin_uid(t,e,i,n,o+1):-104===s.code?(window.toast("[自动每日奖励][每日投币]剩余硬币不足，已停止","warning"),$.Deferred().reject()):(window.toast(`[自动每日奖励][每日投币]'${s.msg}`,"caution"),MY_API.DailyReward.coin_uid(t,e,i,n,o+1))),()=>delayCall(()=>MY_API.DailyReward.coin_uid(t,e,i,n,o)))))},share:t=>MY_API.CONFIG.SHARE?BAPI.DailyReward.share(t).then(e=>{MYDEBUG("DailyReward.share: API.DailyReward.share",e),0===e.code?window.toast(`[自动每日奖励][每日分享]分享成功(av=${t})`,"success"):71e3===e.code?window.toast("[自动每日奖励][每日分享]今日分享已完成","info"):window.toast(`[自动每日奖励][每日分享]'${e.msg}`,"caution")},()=>(window.toast("[自动每日奖励][每日分享]分享失败，请检查网络","error"),delayCall(()=>MY_API.DailyReward.share(t)))):$.Deferred().resolve(),dynamic:async()=>{const t=MY_API.CONFIG.COIN_NUMBER-MY_API.DailyReward.coin_exp/10,e=await BAPI.getuserinfo().then(e=>(MYDEBUG("DailyReward.dynamic: API.getuserinfo",e),e.data.biliCoin<t?e.data.biliCoin:t));return e<t&&window.toast(`[自动每日奖励][每日投币]剩余硬币不足，仅能投${e}个币`,"warning"),BAPI.dynamic_svr.dynamic_new(Live_info.uid,8).then(t=>{if(MYDEBUG("DailyReward.dynamic: API.dynamic_svr.dynamic_new",t),0===t.code){if(t.data.cards){const i=JSON.parse(t.data.cards[0].card),n=MY_API.DailyReward.watch(i.aid,i.cid);let o;o=0==MY_API.CONFIG.COIN_UID||"COIN_DYN"==MY_API.CONFIG.COIN_TYPE?MY_API.DailyReward.coin(t.data.cards,Math.max(e,0)):MY_API.DailyReward.UserSpace(MY_API.CONFIG.COIN_UID,30,0,1,"","pubdate","jsonp");const a=MY_API.DailyReward.share(i.aid);return $.when(n,o,a)}window.toast('[自动每日奖励]"动态-投稿视频"中暂无动态',"info")}else window.toast(`[自动每日奖励]获取"动态-投稿视频"'${t.msg}`,"caution")},()=>(window.toast('[自动每日奖励]获取"动态-投稿视频"失败，请检查网络',"error"),delayCall(()=>MY_API.DailyReward.dynamic())))},UserSpace:(t,e,i,n,o,a,r)=>BAPI.x.getUserSpace(t,e,i,n,o,a,r).then(e=>{if(MYDEBUG("DailyReward.UserSpace: API.dynamic_svr.UserSpace",e),0===e.code){if(e.data.list.vlist){const i=MY_API.CONFIG.COIN_NUMBER-MY_API.DailyReward.coin_exp/10;return MY_API.DailyReward.coin_uid(e.data.list.vlist,Math.max(i,0),n,t)}window.toast('[自动每日奖励]"空间-投稿视频"中暂无视频',"info")}else window.toast(`[自动每日奖励]获取"空间-投稿视频"'${e.msg}`,"caution")},()=>(window.toast('[自动每日奖励]获取"空间-投稿视频"失败，请检查网络',"error"),delayCall(()=>MY_API.DailyReward.UserSpace(t,e,i,n,o,a,r)))),run:()=>{try{return MY_API.CONFIG.LOGIN||MY_API.CONFIG.COIN||MY_API.CONFIG.WATCH?checkNewDay(MY_API.CACHE.DailyReward_TS)?BAPI.DailyReward.exp().then(t=>{MYDEBUG("DailyReward.run: API.DailyReward.exp",t),0===t.code?(MY_API.DailyReward.coin_exp=t.number,MY_API.DailyReward.login(),MY_API.DailyReward.dynamic(),MY_API.CACHE.DailyReward_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.DailyReward.run,"每日任务")):window.toast(`[自动每日奖励]${t.message}`,"caution")},()=>(window.toast("[自动每日奖励]获取每日奖励信息失败，请检查网络","error"),delayCall(()=>MY_API.DailyReward.run()))):(runMidnight(MY_API.DailyReward.run,"每日任务"),$.Deferred().resolve()):$.Deferred().resolve()}catch(t){return window.toast("[自动每日奖励]运行时出现异常","error"),console.error(`[${NAME}]`,t),$.Deferred().reject()}}},LiveReward:{dailySignIn:()=>BAPI.xlive.dosign().then(t=>{MYDEBUG("LiveReward.dailySignIn: API.xlive.dosign",t),0===t.code?(window.toast("[自动直播签到]完成","success"),$(".hinter").remove(),$(".checkin-btn").remove()):1011040===t.code?window.toast("[自动直播签到]今日直播签到已完成","info"):(window.toast(`[自动直播签到]${t.message}，尝试点击签到按钮`,"caution"),$(".checkin-btn").click())},()=>(window.toast("[自动直播签到]直播签到失败，请检查网络","error"),delayCall(()=>MY_API.LiveReward.dailySignIn()))),run:()=>{try{if(!MY_API.CONFIG.LIVE_SIGN)return $.Deferred().resolve();if(!checkNewDay(MY_API.CACHE.LiveReward_TS))return runMidnight(MY_API.LiveReward.run,"直播签到"),$.Deferred().resolve();MY_API.LiveReward.dailySignIn(),MY_API.CACHE.LiveReward_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.LiveReward.run,"直播签到")}catch(t){return window.toast("[自动直播签到]运行时出现异常","error"),console.error(`[${NAME}]`,t),$.Deferred().reject()}}},Exchange:{silver2coin:()=>BAPI.Exchange.silver2coin().then(t=>{MYDEBUG("Exchange.silver2coin: API.SilverCoinExchange.silver2coin",t),0===t.code?window.toast(`[银瓜子换硬币]${t.msg}`,"success"):403===t.code?window.toast(`[银瓜子换硬币]${t.msg}`,"info"):window.toast(`[银瓜子换硬币]${t.msg}`,"caution")},()=>(window.toast("[银瓜子换硬币]兑换失败，请检查网络","error"),delayCall(()=>MY_API.Exchange.silver2coin()))),runS2C:()=>{try{return MY_API.CONFIG.SILVER2COIN?checkNewDay(MY_API.CACHE.Silver2Coin_TS)?MY_API.Exchange.silver2coin().then(()=>{MY_API.CACHE.Silver2Coin_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.Exchange.runS2C,"瓜子换硬币")},()=>delayCall(()=>MY_API.Exchange.runS2C())):(runMidnight(MY_API.Exchange.runS2C,"瓜子换硬币"),$.Deferred().resolve()):$.Deferred().resolve()}catch(t){return window.toast("[银瓜子换硬币]运行时出现异常，已停止","error"),console.error(`[${NAME}]`,t),$.Deferred().reject()}}},Gift:{run_timer:void 0,ruid:void 0,room_id:void 0,medal_list:void 0,bag_list:void 0,time:void 0,remain_feed:void 0,over:!1,run_timer:void 0,sendGiftList:[1,6,30607],getMedalList:async(t=1)=>(1===t&&(MY_API.Gift.medal_list=[]),await BAPI.i.medal(t,25).then(e=>{if(MYDEBUG("Gift.getMedalList: API.i.medal",e),MY_API.Gift.medal_list=MY_API.Gift.medal_list.concat(e.data.fansMedalList),e.data.pageinfo.curPage<e.data.pageinfo.totalpages)return MY_API.Gift.getMedalList(t+1)},()=>(window.toast("[自动送礼]获取勋章列表失败，请检查网络","error"),delayCall(()=>MY_API.Gift.getMedalList())))),getBagList:async()=>await BAPI.gift.bag_list().then(t=>{MYDEBUG("Gift.getBagList: API.gift.bag_list",t),MY_API.Gift.bag_list=t.data.list,MY_API.Gift.time=t.data.time},()=>(window.toast("[自动送礼]获取包裹列表失败，请检查网络","error"),delayCall(()=>MY_API.Gift.getBagList()))),getFeedByGiftID:t=>{if(30607===t)return 50;for(let e=Live_info.gift_list.length-1;e>=0;--e)if(Live_info.gift_list[e].id===t)return Math.ceil(Live_info.gift_list[e].price/100);return 0},sort_medals:t=>{if("high"==MY_API.CONFIG.GIFT_SORT?t.sort((t,e)=>e.level-t.level==0?e.intimacy-t.intimacy:e.level-t.level):t.sort((t,e)=>t.level-e.level==0?t.intimacy-e.intimacy:t.level-e.level),MY_API.CONFIG.AUTO_GIFT_ROOMID&&MY_API.CONFIG.AUTO_GIFT_ROOMID.length>0){let e=MY_API.CONFIG.AUTO_GIFT_ROOMID;e.reverse();for(let i of e){let e=t.findIndex(t=>t.roomid==i);if(-1!=e){let i=t[e];t.splice(e,1),t.unshift(i)}}}return t},auto_light:async t=>{try{const e=MY_API.Gift.getFeedByGiftID(30607);let i=MY_API.CONFIG.LIGHT_MEDALS,n=void 0;if(n="LIGHT_WHITE"==MY_API.CONFIG.LIGHT_METHOD?t.filter(t=>0==t.is_lighted&&t.day_limit-t.today_feed>=e&&i.findIndex(e=>e==t.roomid)>=0):t.filter(t=>0==t.is_lighted&&t.day_limit-t.today_feed>=e&&-1==i.findIndex(e=>e==t.roomid)),MYDEBUG("[auto_light]即将点亮勋章房间列表",n),n&&n.length>0){n=MY_API.Gift.sort_medals(n),await MY_API.Gift.getBagList();let t=MY_API.Gift.bag_list.filter(t=>30607==t.gift_id);if(t&&t.length>0)for(let i of n){let n=t.find(t=>30607==t.gift_id&&t.gift_num>0);if(!n)break;{let t=i.day_limit-i.today_feed;if(t-e>=0||MY_API.CONFIG.FORCE_LIGHT){let o=await BAPI.room.room_init(parseInt(i.roomid,10)),a=parseInt(o.data.room_id,10),r=1,l=await BAPI.gift.bag_send(Live_info.uid,30607,i.target_id,r,n.bag_id,a,Live_info.rnd);0===l.code?(n.gift_num-=r,i.today_feed+=r*e,t-=r*e,window.toast(`[自动送礼]勋章[${i.medalName}]点亮成功，送出${r}个${n.gift_name}，[${i.today_feed}/${i.day_limit}]距离升级还需[${t}]`,"success"),MYDEBUG("Gift.auto_light",`勋章[${i.medalName}]点亮成功，送出${r}个${n.gift_name}，[${i.today_feed}/${i.day_limit}]`)):window.toast(`[自动送礼]勋章[${i.medalName}]点亮失败【${l.msg}】`,"caution")}}}}}catch(t){console.error(t),window.toast(`[自动送礼]点亮勋章出错:${t}`,"error")}},run:async()=>{try{if(!MY_API.CONFIG.AUTO_GIFT)return $.Deferred().resolve();if(MY_API.Gift.run_timer&&clearTimeout(MY_API.Gift.run_timer),!("GIFT_SEND_TIME"!=MY_API.CONFIG.GIFT_METHOD||isTime(MY_API.CONFIG.GIFT_SEND_HOUR,MY_API.CONFIG.GIFT_SEND_MINUTE)||SEND_GIFT_NOW||LIGHT_MEDAL_NOW)){let t=getIntervalTime(MY_API.CONFIG.GIFT_SEND_HOUR,MY_API.CONFIG.GIFT_SEND_MINUTE);MY_API.Gift.run_timer=setTimeout(MY_API.Gift.run,t);let e=new Date(ts_ms()+t).toLocaleString();return MYDEBUG("[自动送礼]",`将在${e}进行自动送礼`),$.Deferred().resolve()}if("GIFT_INTERVAL"==MY_API.CONFIG.GIFT_METHOD&&!SEND_GIFT_NOW&&!LIGHT_MEDAL_NOW){let t=6e4*MY_API.CONFIG.GIFT_INTERVAL;if(MY_API.CACHE.GiftInterval_TS){const e=ts_ms()-MY_API.CACHE.GiftInterval_TS;if(e<t){let i=t-e;return MY_API.Gift.run_timer=setTimeout(MY_API.Gift.run,i),void MYDEBUG("[自动送礼]",`将在${i}毫秒后进行自动送礼`)}}else MY_API.CACHE.GiftInterval_TS=ts_ms(),MY_API.saveCache()}MY_API.Gift.over=!1,await MY_API.Gift.getMedalList();let t=MY_API.Gift.medal_list;if(MYDEBUG("Gift.run: Gift.getMedalList().then: Gift.medal_list",t),t&&t.length>0){if(t=t.filter(t=>t.day_limit-t.today_feed>0&&t.level<20),t=MY_API.Gift.sort_medals(t),MY_API.CONFIG.EXCLUDE_ROOMID&&MY_API.CONFIG.EXCLUDE_ROOMID.length>0){const e=MY_API.CONFIG.EXCLUDE_ROOMID;t=t.filter(t=>-1==e.findIndex(e=>e==t.roomid))}if(await MY_API.Gift.auto_light(t),LIGHT_MEDAL_NOW)return LIGHT_MEDAL_NOW=!1,$.Deferred().resolve();for(let e of t){if(MY_API.Gift.over)break;let t=await BAPI.room.room_init(parseInt(e.roomid,10));MY_API.Gift.room_id=parseInt(t.data.room_id,10),MY_API.Gift.ruid=e.target_id,MY_API.Gift.remain_feed=e.day_limit-e.today_feed,MY_API.Gift.remain_feed>0&&(await MY_API.Gift.getBagList(),MY_API.Gift.remain_feed>0?(window.toast(`[自动送礼]勋章[${e.medalName}] 今日亲密度未满[${e.today_feed}/${e.day_limit}]，预计需要[${MY_API.Gift.remain_feed}]送礼开始`,"info"),await MY_API.Gift.sendGift(e)):window.toast(`[自动送礼]勋章[${e.medalName}] 今日亲密度已满`,"info"))}}await MY_API.Gift.sendRemainGift(MY_API.CONFIG.SPARE_GIFT_ROOM)}catch(t){return(()=>(window.toast("[自动送礼]送礼失败，请检查网络","error"),delayCall(()=>MY_API.Gift.run())))(),window.toast("[自动送礼]运行时出现异常，已停止","error"),console.error(`[${NAME}]`,t),$.Deferred().reject()}return SEND_GIFT_NOW=!1,(()=>{if("GIFT_SEND_TIME"==MY_API.CONFIG.GIFT_METHOD){let t=getIntervalTime(MY_API.CONFIG.GIFT_SEND_HOUR,MY_API.CONFIG.GIFT_SEND_MINUTE);MY_API.Gift.run_timer=setTimeout(MY_API.Gift.run,t);let e=new Date(ts_ms()+t).toLocaleString();MYDEBUG("[自动送礼]",`将在${e}进行自动送礼`),MY_API.CACHE.Gift_TS=ts_ms(),MY_API.saveCache()}else MYDEBUG("[自动送礼]",`将在${MY_API.CONFIG.GIFT_INTERVAL}分钟后进行自动送礼`),MY_API.CACHE.GiftInterval_TS=ts_ms(),MY_API.saveCache()})(),$.Deferred().resolve()},sendGift:async t=>{let e;if(await MY_API.Gift.getBagList(),MY_API.Gift.remain_feed<=0)return window.toast(`[自动送礼]勋章[${t.medalName}] 送礼结束，今日亲密度已满[${t.today_feed}/${t.day_limit}]`,"info"),$.Deferred().resolve();if(MY_API.Gift.time<=0&&(MY_API.Gift.time=ts_s()),MY_API.CONFIG.SEND_ALL_GIFT){let t=MY_API.Gift.bag_list.filter(t=>t.gift_num>0&&"永久"!=t.corner_mark);if(0==t.length)return void(MY_API.Gift.over=!0);e=t}else{let t=MY_API.Gift.bag_list.filter(t=>MY_API.Gift.sendGiftList.includes(t.gift_id)&&t.gift_num>0&&t.corner_mark.substring(0,t.corner_mark.indexOf("天"))<=MY_API.CONFIG.GIFT_LIMIT);if(MYDEBUG("[自动送礼]pass的礼物",t),0==t.length)return void(MY_API.Gift.over=!0);e=t}MYDEBUG("bag_list",e);for(let i of e){if(t.day_limit-t.today_feed<=0)return void window.toast(`[自动送礼]勋章[${t.medalName}] 送礼结束，今日亲密度已满[${t.today_feed}/${t.day_limit}]`,"info");let e=MY_API.Gift.getFeedByGiftID(i.gift_id);if(e>0){let n=Math.floor(MY_API.Gift.remain_feed/e);n>i.gift_num&&(n=i.gift_num),n>0&&(MYDEBUG("[自动送礼]送出礼物类型",i.gift_name),await BAPI.gift.bag_send(Live_info.uid,i.gift_id,MY_API.Gift.ruid,n,i.bag_id,MY_API.Gift.room_id,Live_info.rnd).then(o=>{MYDEBUG("Gift.sendGift: API.gift.bag_send",o),0===o.code?(i.gift_num-=n,t.today_feed+=n*e,MY_API.Gift.remain_feed-=n*e,window.toast(`[自动送礼]勋章[${t.medalName}] 送礼成功，送出${n}个${i.gift_name}，[${t.today_feed}/${t.day_limit}]距离升级还需[${MY_API.Gift.remain_feed}]`,"success")):window.toast(`[自动送礼]勋章[${t.medalName}] 送礼异常:${o.msg}`,"caution")},()=>(window.toast("[自动送礼]包裹送礼失败，请检查网络","error"),delayCall(()=>MY_API.Gift.sendGift(t)))))}}},sendRemainGift:async t=>{if(0==t)return $.Deferred().resolve();let e,i=void 0;if(await BAPI.live_user.get_anchor_in_room(t).then(t=>{if(MYDEBUG("API.live_user.get_anchor_in_room",t),!t.data.info.uid)return window.toast("[自动送礼]【剩余礼物】检查房间出错"),$.Deferred().reject();i=t.data.info.uid}),await MY_API.Gift.getBagList(),MY_API.Gift.time<=0&&(MY_API.Gift.time=ts_s()),MY_API.CONFIG.SEND_ALL_GIFT){let t=MY_API.Gift.bag_list.filter(t=>t.gift_num>0&&"永久"!=t.corner_mark);if(0==t.length)return void(MY_API.Gift.over=!0);e=t}else{let t=MY_API.Gift.bag_list.filter(t=>MY_API.Gift.sendGiftList.includes(t.gift_id)&&t.gift_num>0&&"1天"==t.corner_mark);if(0==t.length)return void(MY_API.Gift.over=!0);e=t}MYDEBUG("[自动送礼]【剩余礼物】bag_list",e);for(let n of e){if(MY_API.Gift.getFeedByGiftID(n.gift_id)>0){let e=n.gift_num;e>0&&await BAPI.gift.bag_send(Live_info.uid,n.gift_id,i,e,n.bag_id,t,Live_info.rnd).then(i=>{MYDEBUG("Gift.sendGift: API.gift.bag_send",i),0===i.code?(n.gift_num-=e,window.toast(`[自动送礼]【剩余礼物】房间[${t}] 送礼成功，送出${e}个${n.gift_name}`,"success")):window.toast(`[自动送礼]【剩余礼物】房间[${t}] 送礼异常:${i.msg}`,"caution")},()=>(window.toast("[自动送礼]【剩余礼物】包裹送礼失败，请检查网络","error"),delayCall(()=>MY_API.Gift.sendGift(medal))))}}}},stormQueue:[],stormBlack:!1,stormIdSet:{add:function(t){let e=[];try{(e=[...JSON.parse(localStorage.getItem(`${NAME}stormIdSet`)).list]).push(t),e.length>50&&e.splice(0,10),localStorage.setItem(`${NAME}stormIdSet`,JSON.stringify({list:e})),MYDEBUG(`${NAME}storm_Id_list_add`,e)}catch(i){e.push(t),localStorage.setItem(`${NAME}stormIdSet`,JSON.stringify({list:e}))}},isIn:function(t){let e=[];try{const i=JSON.parse(localStorage.getItem(`${NAME}stormIdSet`));return e=null===i?[]:[...i.list],MYDEBUG(`${NAME}storm_Id_list_read`,i),e.indexOf(t)>-1}catch(i){return localStorage.setItem(`${NAME}stormIdSet`,JSON.stringify({list:e})),MYDEBUG("读取"+`${NAME}stormIdSet`+"缓存错误已重置"),e.indexOf(t)>-1}}},Storm:{check:t=>MY_API.stormQueue.indexOf(t)>-1,append:t=>{MY_API.stormQueue.push(t),MY_API.stormQueue.length>MY_API.CONFIG.STORM_QUEUE_SIZE&&MY_API.stormQueue.shift()},over:t=>{MY_API.stormQueue.indexOf(t)>-1&&MY_API.stormQueue.splice(t,1)},run:t=>{try{return MY_API.CONFIG.STORM?MY_API.stormBlack?$.Deferred().resolve():inTimeArea(MY_API.CONFIG.TIME_AREA_START_H0UR,MY_API.CONFIG.TIME_AREA_END_H0UR,MY_API.CONFIG.TIME_AREA_START_MINUTE,MY_API.CONFIG.TIME_AREA_END_MINUTE)&&MY_API.CONFIG.TIME_AREA_DISABLE?(MYDEBUG("节奏风暴",`自动休眠，跳过检测roomid=${t}`),$.Deferred().resolve()):BAPI.Storm.check(t).then(e=>{if(MYDEBUG("MY_API.Storm.run: MY_API.API.Storm.check",e),0===e.code){var i=e.data;return MY_API.Storm.join(i.id,i.roomid,Math.round((new Date).getTime()/1e3)+i.time),$.Deferred().resolve()}window.toast(`[自动抽奖][节奏风暴](roomid=${t})${e.msg}`,"caution")},()=>{window.toast(`[自动抽奖][节奏风暴]检查直播间(${t})失败，请检查网络`,"error")}):$.Deferred().resolve()}catch(t){return window.toast("[自动抽奖][节奏风暴]运行时出现异常","error"),console.error(`[${NAME}]`,t),$.Deferred().reject()}},join:(t,e,i)=>{if(e=parseInt(e,10),t=parseInt(t,10),isNaN(e)||isNaN(t))return $.Deferred().reject();var n=Math.round(t/1e6);if(MY_API.stormIdSet.isIn(n))return $.Deferred().resolve();if(MY_API.stormIdSet.add(n),!MY_API.Storm.check(t)){MY_API.Storm.append(t);var o=0;i<=0&&(i=Math.round((new Date).getTime()/1e3)+90);var a=0;return window.toast(`[自动抽奖][节奏风暴]尝试抽奖(roomid=${e},id=${t})`,"success"),o=setInterval(()=>(async function(){try{if(!MY_API.Storm.check(t))return void clearInterval(o);var n=Math.round((new Date).getTime()/1e3);if(n>i&&i>0)return MY_API.Storm.over(t),void clearInterval(o);if(++a>MY_API.CONFIG.STORM_MAX_COUNT&&MY_API.CONFIG.STORM_MAX_COUNT>0)return MY_API.Storm.over(t),clearInterval(o),void window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${e},id=${t})到达尝试次数。\r\n尝试次数:${a},距离到期:${i-n}s`,"caution");let r;try{if(r=userToken&&appToken&&tokenData.access_token?await BAPI.Storm.join_ex(t,e,tokenData.access_token,BilibiliToken.appKey,BilibiliToken.headers):await BAPI.Storm.join(t,captcha_token="",captcha_phrase="",e),MYDEBUG("MY_API.Storm.join: MY_API.API.Storm.join",r),!r.code)return MY_API.Storm.over(t),Statistics.appendGift(r.data.gift_name,r.data.gift_num),window.toast(`[自动抽奖][节奏风暴]领取(roomid=${e},id=${t})成功,${r.data.gift_name+"x"+r.data.gift_num}\r\n${r.data.mobile_content}\r\n尝试次数:${a}`,"success"),void clearInterval(o);if(-1!=r.msg.indexOf("领取"))return MY_API.Storm.over(t),clearInterval(o),void window.toast(`[自动抽奖][节奏风暴]领取(roomid=${e},id=${t})成功,${r.msg}\r\n尝试次数:${a}`,"success");if(-1!=r.msg.indexOf("验证码"))return MY_API.Storm.over(t),clearInterval(o),MY_API.stormBlack=!0,void window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${e},id=${t})失败,疑似账号不支持,${r.msg}`,"caution");if(r.data&&0==r.data.length&&-1!=r.msg.indexOf("下次要更快一点"))return MY_API.Storm.over(t),window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${e},id=${t})疑似风暴黑屋,终止！`,"error"),clearInterval(o),MY_API.stormBlack=!0,void setTimeout(()=>{MY_API.stormBlack=!1},36e5);if(-1==r.msg.indexOf("下次要更快一点"))return void clearInterval(o)}catch(i){return MY_API.Storm.over(t),window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${e},id=${t})疑似触发风控,终止！\r\n尝试次数:${a}`,"error"),console.error(i),void clearInterval(o)}}catch(i){return MY_API.Storm.over(t),window.toast(`[自动抽奖][节奏风暴]抽奖(roomid=${e},id=${t})抽奖异常,终止！`,"error"),console.error(i),void clearInterval(o)}})(),MY_API.CONFIG.STORM_ONE_LIMIT),$.Deferred().resolve()}}},LITTLE_HEART:{getInfo:()=>XHR({GM:!0,anonymous:!0,method:"GET",url:`https://passport.bilibili.com/x/passport-login/oauth2/info?${appToken.signLoginQuery(`access_key=${tokenData.access_token}`)}`,responseType:"json",headers:appToken.headers}),RandomHex:t=>{const e="0123456789abcdef";let i="";i+=e[Math.floor(15*Math.random())+1];for(let n=0;n<t-1;n++)i+=e[Math.floor(16*Math.random())];return i},uuid:()=>MY_API.LITTLE_HEART.RandomHex(32).replace(/(\w{8})(\w{4})\w(\w{3})\w(\w{3})(\w{12})/,`$1-$2-4$3-${"89ab"[Math.floor(4*Math.random())]}$4-$5`),getFansMedal:async()=>{const t=await XHR({GM:!0,anonymous:!0,method:"GET",url:`https://api.live.bilibili.com/fans_medal/v1/FansMedal/get_list_in_room?${BilibiliToken.signQuery(`access_key=${tokenData.access_token}&target_id=${Live_info.tid}&uid=${Live_info.uid}&${baseQuery}`)}`,responseType:"json",headers:appToken.headers});if(void 0!==t&&200===t.response.status&&0===t.body.code&&t.body.data.length>0)return t.body.data},getGiftNum:async()=>{let t=0;return await BAPI.gift.bag_list().then(e=>{MYDEBUG("[小心心]检查包裹",e);const i=e.data.list.filter(t=>30607==t.gift_id&&"7天"==t.corner_mark);for(const e of i)t+=e.gift_num}),MYDEBUG("[小心心]检测到包裹内7天小心心数量",t),t},mobileHeartBeat:async t=>{const e=new WasmHash;await e.init();const i=(t=>e.hash("BLAKE2b512",e.hash("SHA3-384",e.hash("SHA384",e.hash("SHA3-512",e.hash("SHA512",JSON.stringify(t)))))))(t);let n="";for(const e in t)n+=`${e}=${encodeURIComponent(t[e])}&`;n+=`client_sign=${i}`;const o=await XHR({GM:!0,anonymous:!0,method:"POST",url:"https://live-trace.bilibili.com/xlive/data-interface/v1/heartbeat/mobileHeartBeat",data:BilibiliToken.signQuery(`access_key=${tokenData.access_token}&${n}&${baseQuery}`),responseType:"json",headers:appToken.headers});return void 0!==o&&200===o.response.status&&0===o.body.code},run:async()=>{if(!MY_API.CONFIG.LITTLE_HEART)return $.Deferred().resolve();if(!checkNewDay(MY_API.CACHE.LittleHeart_TS))return runMidnight(MY_API.LITTLE_HEART.run,"获取小心心"),$.Deferred().resolve();const t={platform:"android",uuid:MY_API.LITTLE_HEART.uuid(),buvid:appToken.buvid,seq_id:"1",room_id:"{room_id}",parent_id:"6",area_id:"283",timestamp:"{timestamp}",secret_key:"axoaadsffcazxksectbbb",watch_time:"300",up_id:"{target_id}",up_level:"40",jump_from:"30000",gu_id:MY_API.LITTLE_HEART.RandomHex(43),play_type:"0",play_url:"",s_time:"0",data_behavior_id:"",data_source_id:"",up_session:"l:one:live:record:{room_id}:{last_wear_time}",visit_id:MY_API.LITTLE_HEART.RandomHex(32),watch_status:"%7B%22pk_id%22%3A0%2C%22screen_status%22%3A1%7D",click_id:MY_API.LITTLE_HEART.uuid(),session_id:"",player_type:"0",client_ts:"{client_ts}"},e=async(t=!0)=>(t&&await sleep(5e3),!t||await MY_API.LITTLE_HEART.getGiftNum()>=24?(window.toast("[小心心]今日小心心已全部获取","success"),MY_API.CACHE.LittleHeart_TS=ts_ms(),MY_API.saveCache(),runMidnight(MY_API.LITTLE_HEART.run,"获取小心心")):(window.toast("[小心心]小心心未全部获取，295秒后将再次运行","info"),setTimeout(MY_API.LITTLE_HEART.run,295e3)));if(void 0===await setToken())return;if(!tokenData.access_token&&!tokenData.mid&&!tokenData.refresh_token){const t=await MY_API.LITTLE_HEART.getInfo();if(MYDEBUG("[小心心]userInfo",t),void 0===t)return console.error(GM_info.script.name,"获取用户信息错误");if(0!==t.body.code&&void 0===await setToken())return;if(t.body.data.mid!==Live_info.uid&&void 0===await setToken())return}console.log("tokenData",tokenData.access_token),MYDEBUG("[小心心]","开始客户端心跳"),window.toast("[小心心]开始获取小心心","success");const i=await MY_API.LITTLE_HEART.getGiftNum();if(!(i<24))return e(!1);{const n=await MY_API.LITTLE_HEART.getFansMedal();if(void 0!==n){const o=24-i,a=Math.ceil(o/n.length);let r=0;for(let i=0;i<a;i++){for(const i of n){if(r>=o)return e();const n=Object.assign({},t,{room_id:i.room_id.toString(),timestamp:(BilibiliToken.TS-300).toString(),up_id:i.target_id.toString(),up_session:`l:one:live:record:${i.room_id}:${i.last_wear_time}`,client_ts:BilibiliToken.TS.toString()});await MY_API.LITTLE_HEART.mobileHeartBeat(n),r++}if(r>=o)return e();await sleep(3e5)}}}}},AUTO_DANMU:{setValue:(t,e)=>void 0===MY_API.CONFIG[t][e]&&e>0?MY_API.AUTO_DANMU.setValue(t,e-1):MY_API.CONFIG[t][e],sendDanmu:async(t,e)=>(BAPI.room.get_info(e).then(i=>(MYDEBUG(`API.room.get_info roomId=${e} res`,i),BAPI.sendLiveDanmu(t,i.data.room_id).then(i=>{MYDEBUG(`[自动发弹幕]弹幕发送内容【${t}】，房间号【${e}】`,i),0!==i.code||i.msg?window.toast(`[自动发弹幕]弹幕【${t}】（房间号【${e}】）出错 ${i.msg}`,"caution"):window.toast(`[自动发弹幕]弹幕【${t}】（房间号【${e}】）发送成功`,"success")},()=>(window.toast(`[自动发弹幕]弹幕【${t}】（房间号【${e}】）发送失败`,"error"),$.Deferred().reject())))),()=>(window.toast(`[自动发弹幕]房间号【${e}】信息获取失败`,"error"),$.Deferred().reject())),getMaxLength:()=>{let t=void 0;const e=MY_API.CONFIG.DANMU_CONTENT.length,i=MY_API.CONFIG.DANMU_ROOMID.length,n=MY_API.CONFIG.DANMU_INTERVAL_TIME.length;return(t=e>=i?e:i)<n&&(t=n),t},run:async()=>{if(!MY_API.CONFIG.AUTO_DANMU)return $.Deferred().resolve();let t=MY_API.AUTO_DANMU.getMaxLength();for(let e=0;e<t;e++){let t=MY_API.AUTO_DANMU.setValue("DANMU_CONTENT",e),i=parseInt(MY_API.AUTO_DANMU.setValue("DANMU_ROOMID",e)),n=MY_API.AUTO_DANMU.setValue("DANMU_INTERVAL_TIME",e),o=void 0,a=MY_API.CACHE.AUTO_SEND_DANMU_TS,r=void 0,l=void 0,s=void 0,d=void 0,_=0;if(n.indexOf(":")>-1){l=!0;const t=n.split(":"),e=parseInt(t[0]),i=parseInt(t[1]),o=parseInt(t[2]);isTime(e,i,o)||(_=getIntervalTime(e,i,o))}else if(l=!1,(n=n.toLowerCase()).indexOf("h")>-1||n.indexOf("m")>-1||n.indexOf("s")>-1){const t=n.split("h"),e=void 0===t[1]?t[0].split("m"):t[1].split("m"),i=void 0===e[1]?e[0].split("s"):e[1].split("s"),o=t[0],a=e[0],r=i[0],l=isNaN(o)?0:o||0,s=isNaN(a)?0:a||0,_=isNaN(r)?0:r||0;d=36e5*l+6e4*s+1e3*_}else d=6e4*n;MYDEBUG("[自动发弹幕]MY_API.CACHE.AUTO_SEND_DANMU_TS => jsoncache",a);for(const e of a)if(e.roomid==i&&e.content==t){o=e.sendTs,r=a.indexOf(e);break}l||(s=o?ts_ms()-o:ts_ms());const I=()=>{const e={roomid:i,content:t,sendTs:ts_ms()};return o?a[r].sendTs=ts_ms():a.push(e),MY_API.CACHE.AUTO_SEND_DANMU_TS=a,MY_API.saveCache(!1)},c=(e,n)=>(n||I(),setTimeout(async()=>(await MY_API.AUTO_DANMU.sendDanmu(t,i),n||I(),c(e,n)),e));!l&&(s>=d||SEND_DANMU_NOW)?(SEND_DANMU_NOW=!1,await MY_API.AUTO_DANMU.sendDanmu(t,i),MYDEBUG(`[自动发弹幕]弹幕发送内容【${t}】，房间号【${i}】，距下次发送还有`,n),c(d,l)):l&&!_||SEND_DANMU_NOW?(SEND_DANMU_NOW=!1,await MY_API.AUTO_DANMU.sendDanmu(t,i),_=getIntervalTime(danmu_time[0],danmu_time[1],danmu_time[2]),MYDEBUG(`[自动发弹幕]弹幕发送内容【${t}】，房间号【${i}】，距下次发送还有`,"约24小时"),c(_,l)):(MYDEBUG(`[自动发弹幕]弹幕发送内容【${t}】，房间号【${i}】，距下次发送还有`,`${l?_/6e4:(d-s)/6e4}分钟`),setTimeout(async()=>{await MY_API.AUTO_DANMU.sendDanmu(t,i),c(l?864e5:d,l)},l?_:d-s)),await sleep(1100)}}},MaterialObject:{list:[],firstAid:void 0,run:()=>{try{if(!MY_API.CONFIG.MATERIAL_LOTTERY)return $.Deferred().resolve();if(MY_API.CACHE.materialobject_ts){const t=ts_ms()-MY_API.CACHE.materialobject_ts,e=6e4*MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL||6e5;if(t<e)return MYDEBUG("[实物抽奖]",`${e-t}毫秒后再次运行`),setTimeout(MY_API.MaterialObject.run,e-t),$.Deferred().resolve()}return MY_API.chatLog("[实物抽奖] 开始寻找可参加的抽奖"),MY_API.MaterialObject.check().then(t=>{t&&(MY_API.CACHE.last_aid=t,MY_API.CACHE.materialobject_ts=ts_ms(),MY_API.saveCache()),MYDEBUG("[实物抽奖]",`将在${MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL}分钟后再次运行实物抽奖`),setTimeout(MY_API.MaterialObject.run,6e4*MY_API.CONFIG.MATERIAL_LOTTERY_CHECK_INTERVAL||6e5)},()=>delayCall(()=>MY_API.MaterialObject.run()))}catch(t){return MY_API.chatLog("[实物抽奖]运行时出现异常","error"),console.error(`[${NAME}]`,t),$.Deferred().reject()}},check:(aid,valid=639,rem=MY_API.CONFIG.MATERIAL_LOTTERY_REM||9)=>(aid=parseInt(aid||MY_API.CACHE.last_aid,10),isNaN(aid)&&(aid=valid),MYDEBUG("API.MaterialObject.check: aid=",aid),BAPI.Lottery.MaterialObject.getStatus(aid).then(response=>{if(MYDEBUG("API.MaterialObject.check: API.MY_API.MaterialObject.getStatus",response),0===response.code&&response.data){if(3!=response.data.typeB[response.data.typeB.length-1].status&&void 0===MY_API.MaterialObject.firstAid&&(MY_API.MaterialObject.firstAid=aid),MY_API.CONFIG.MATERIAL_LOTTERY_IGNORE_QUESTIONABLE_LOTTERY)for(const str of MY_API.CONFIG.QUESTIONABLE_LOTTERY)if("/"!=str.charAt(0)&&"/"!=str.charAt(str.length-1)){if(response.data.title.toLowerCase().indexOf(str)>-1)return MY_API.chatLog(`[实物抽奖] 忽略存疑抽奖(aid=${aid})<br>含有关键字：`+str,"warning"),MY_API.MaterialObject.check(aid+1,aid)}else{let reg=eval(str);if(reg.test(response.data.title))return MY_API.chatLog(`[实物抽奖] 忽略存疑抽奖(aid=${aid})<br>匹配正则：`+str,"warning"),MY_API.MaterialObject.check(aid+1,aid)}return MY_API.MaterialObject.join(aid,response.data.title,response.data.typeB).then(()=>MY_API.MaterialObject.check(aid+1,aid))}if(-400===response.code||null==response.data)return rem?MY_API.MaterialObject.check(aid+1,valid,rem-1):$.Deferred().resolve(MY_API.MaterialObject.firstAid||valid);MY_API.chatLog(`[实物抽奖] ${response.msg}`,"warning")},()=>(MY_API.chatLog(`[实物抽奖] 检查抽奖(aid=${aid})失败，请检查网络`,"error"),delayCall(()=>MY_API.MaterialObject.check(aid,valid))))),join:(t,e,i,n=0)=>{if(n>=i.length)return $.Deferred().resolve();if(MY_API.MaterialObject.list.some(e=>e.aid===t&&e.number===n+1))return MY_API.MaterialObject.join(t,e,i,n+1);let o={title:e,aid:t,number:n+1,status:i[n].status,join_start_time:i[n].join_start_time,join_end_time:i[n].join_end_time,list:i[n].list,jpName:""};for(const t of o.list)o.jpName=o.jpName.concat(" ",t.jp_name);switch(o.status){case-1:{MY_API.chatLog(`[实物抽奖] 将在${new Date(1e3*(o.join_start_time+1)).toLocaleString()}参加抽奖<br>"${o.title}" aid=${o.aid} 第${n+1}轮 奖品：${o.jpName}`,"info"),MY_API.MaterialObject.list.push(o);const t=$.Deferred();t.then(()=>MY_API.MaterialObject.draw(o)),setTimeout(()=>{t.resolve()},1e3*(o.join_start_time-ts_s()+1))}break;case 0:return MY_API.MaterialObject.draw(o).then(()=>MY_API.MaterialObject.join(t,e,i,n+1));case 1:{MY_API.chatLog(`[实物抽奖] 已参加抽奖<br>"${o.title}" aid=${o.aid} 第${n+1}轮 奖品：${o.jpName}`,"info"),MY_API.MaterialObject.list.push(o);const t=$.Deferred();t.then(()=>MY_API.MaterialObject.notice(o)),setTimeout(()=>{t.resolve()},1e3*(o.join_end_time-ts_s()+1))}}return MY_API.MaterialObject.join(t,e,i,n+1)},draw:t=>BAPI.Lottery.MaterialObject.draw(t.aid,t.number).then(e=>{if(MYDEBUG("API.MaterialObject.check: API.MY_API.MaterialObject.draw",e),0===e.code){$.each(MY_API.MaterialObject.list,(e,i)=>{if(i.aid===t.aid&&i.number===t.number)return i.status=1,MY_API.MaterialObject.list[e]=i,!1}),MY_API.chatLog(`[实物抽奖] 成功参加抽奖<nr>"${t.title}"(aid=${t.aid}，第${t.number}轮) 奖品：${t.jpName}`,"success");const e=$.Deferred();e.then(()=>MY_API.MaterialObject.notice(t)),setTimeout(()=>{e.resolve()},1e3*(t.join_end_time-ts_s()+1))}else MY_API.chatLog(`[实物抽奖] "${t.title}"(aid=${t.aid}，第${t.number}轮)<br>${e.msg}`,"warning")},()=>(MY_API.chatLog(`[实物抽奖] 参加"${t.title}"(aid=${t.aid}，第${t.number}轮)<br>失败，请检查网络`,"error"),delayCall(()=>MY_API.MaterialObject.draw(t)))),notice:t=>BAPI.Lottery.MaterialObject.getWinnerGroupInfo(t.aid,t.number).then(e=>{if(MYDEBUG("API.MaterialObject.check: API.MY_API.MaterialObject.getWinnerGroupInfo",e),0===e.code){$.each(MY_API.MaterialObject.list,(e,i)=>{if(i.aid===t.aid&&i.number===t.number)return i.status=3,MY_API.MaterialObject.list[e]=i,!1});for(const n of e.data.groups)for(const e of n.list)if(e.uid===Live_info.uid){if(MY_API.chatLog(`[实物抽奖] 抽奖"${t.title}"(aid=${t.aid}，第${t.number}轮)获得奖励<br>"${n.giftTitle}"`,"prize"),winPrizeNum++,JQlogRedPoint.text(winPrizeNum),JQlogRedPoint.is(":hidden")&&JQlogRedPoint.show(),MY_API.CONFIG.FT_NOTICE){function i(){return FT_sendMsg(MY_API.CONFIG.FT_SCKEY,`【${GM_info.script.name}】实物抽奖中奖通知 ${t.title}，第${t.number}轮`,`###实物抽奖中奖\n###${t.title}\n###aid=${t.aid}\n###第${t.number}轮\n###获得奖励：\n###${n.giftTitle}\n###请及时填写领奖信息`).then(t=>{MYDEBUG("FT_sendMsg response",t),0==t.body.errno?window.toast("[实物抽奖] 方糖中奖提示发送成功","success"):window.toast(`[实物抽奖] 方糖中奖提示发送失败 ${t.errmsg}`,"error")}),()=>(MY_API.chatLog("[实物抽奖] 方糖中奖提示发送出错，请检查网络","error"),delayCall(()=>i()))}i()}return!0}MY_API.chatLog(`[实物抽奖] 抽奖"${t.title}"(aid=${t.aid}，第${t.number}轮)未中奖`,"info")}else MY_API.chatLog(`[实物抽奖] 抽奖"${t.title}"(aid=${t.aid}，第${t.number}轮)<br>${e.msg}`,"warning")},()=>(MY_API.chatLog(`[实物抽奖] 获取抽奖"${t.title}"(aid=${t.aid}，第${t.number}轮)<br>获取中奖名单失败，请检查网络`,"error"),delayCall(()=>MY_API.MaterialObject.notice(t))))},AnchorLottery:{roomidList:[],followingList:[],unfollowList:[],medal_list:[],waitForRecheckList:[],getMedalList:async(t=1)=>(1===t&&(MY_API.AnchorLottery.medal_list=[]),await BAPI.i.medal(t,25).then(e=>{if(MYDEBUG("AnchorLottery.getMedalList: API.i.medal",e),MY_API.AnchorLottery.medal_list=MY_API.AnchorLottery.medal_list.concat(e.data.fansMedalList),e.data.pageinfo.curPage<e.data.pageinfo.totalpages)return MY_API.AnchorLottery.getMedalList(t+1)},()=>(MY_API.chatLog("[天选时刻]<br>获取勋章列表失败，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.getMedalList())))),getFollowingList:(t=1,e=50)=>(1===t&&(MY_API.AnchorLottery.followingList=[]),BAPI.relation.getFollowings(Live_info.uid,t,e).then(i=>{MYDEBUG(`getFollowingList API.relation.getFollowings ${t}, ${e}`,i);let n=$.Deferred();if(0===i.code){n.resolve();const o=i.data.total;for(const t of i.data.list)MY_API.AnchorLottery.followingList.push(t.mid);return o-MY_API.AnchorLottery.followingList.length>0?$.when(MY_API.AnchorLottery.getFollowingList(t+1,e),n):(window.toast("[保存当前关注列表为白名单] 保存关注列表成功","success"),localStorage.setItem(`${NAME}AnchorFollowingList`,JSON.stringify({list:MY_API.AnchorLottery.followingList})),n)}return window.toast(`[保存当前关注列表为白名单] 获取关注列表出错 ${i.message}`,"error"),n.reject()},()=>(MY_API.chatLog("[天选时刻] 获取关注列表出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.getFollowingList())))),delAnchorFollowing:async(t=1,e=50)=>{return 1===t&&(MY_API.AnchorLottery.unfollowList=[]),function t(e,i){return BAPI.relation.getFollowings(Live_info.uid,e,i).then(n=>{MYDEBUG(`delAnchorFollowing API.relation.getFollowings(${e}, ${i})`,n);let o=$.Deferred();if(0===n.code){o.resolve();const a=n.data.total;for(const t of n.data.list)MY_API.AnchorLottery.unfollowList.push(t.mid);return a-MY_API.AnchorLottery.unfollowList.length>0?$.when(t(e+1,i),o):o}return window.toast(`[取关不在白名单内的UP主] 获取关注列表出错 ${n.message}`,"error"),o.reject()},()=>(MY_API.chatLog("[天选时刻] 获取关注列表出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.delAnchorFollowing())))}(t,e).then(()=>{const t=JSON.parse(localStorage.getItem(`${NAME}AnchorFollowingList`));if(0===t.list.length)return window.toast("[取关不在白名单内的UP主] 请先点击【保存当前关注列表为白名单】!","info"),$.Deferred().resolve();const e=[...t.list];let i=[],n=[];for(const t of MY_API.AnchorLottery.unfollowList)-1===e.indexOf(t)&&i.push(t);for(let t=0;t<=i.length;t++)n[t]=$.Deferred();n[0].resolve();for(let t=0;t<i.length;t++)n[t].then(()=>{let e=$.Deferred();setTimeout(()=>e.resolve(),MY_API.CONFIG.ANCHOR_INTERVAL*t),e.then(()=>{BAPI.relation.modify(i[t],2).then(e=>{MYDEBUG(`API.relation.modify ${i[t]}, 2`,e),0===e.code?(window.toast(`[取关不在白名单内的UP主] 取关UP(uid = ${i[t]})成功`,"success"),n[t+1].resolve()):(window.toast(`[取关不在白名单内的UP主] 取关UP(uid = ${i[t]})出错  ${e.message}`,"error"),n[t+1].reject())})})})})},getRoomList:async()=>{const t=["小时总榜","娱乐小时榜","网游小时榜","手游小时榜","绘画小时榜","电台小时榜","单机小时榜"],e=["全部","娱乐分区","网游分区","手游分区","绘画分区","电台分区","单机分区"];const i=JSON.parse(localStorage.getItem(`${NAME}AnchorRoomidList`))||{list:[]};MY_API.AnchorLottery.roomidList=[...i.list];const n=e=>BAPI.rankdb.getTopRealTimeHour(e).then(i=>{const n=i.data.list;MY_API.chatLog(`[天选时刻] 获取${t[e]}的直播间`,"info");for(const t of n)-1===MY_API.AnchorLottery.roomidList.indexOf(t.roomid)&&MY_API.AnchorLottery.roomidList.push(t.roomid)},()=>(MY_API.chatLog("[天选时刻] 获取小时榜直播间出错，请检查网络",error),delayCall(()=>n(data)))),o=t=>BAPI.room.getRoomList(t,0,0,1,50).then(i=>{const n=i.data.list;MY_API.chatLog(`[天选时刻] 获取${e[t]}的直播间`,"info");for(const t of n)-1===MY_API.AnchorLottery.roomidList.indexOf(t.roomid)&&MY_API.AnchorLottery.roomidList.push(t.roomid)},()=>(MY_API.chatLog("[天选时刻] 获取分区直播间出错，请检查网络","error"),delayCall(()=>o(t))));let a=[];for(let e=0;e<t.length-1;e++)a[e]=$.Deferred();for(let e=1;e<t.length;e++){let t=$.Deferred();setTimeout(()=>t.resolve(),1e3*(e-1)),t.then(()=>{n(e).then(()=>o(e).then(()=>a[e-1].resolve()))})}return $.when(...a).then(()=>(console.log("MY_API.AnchorLottery.roomidList",MY_API.AnchorLottery.roomidList),MY_API.AnchorLottery.roomidList.length>MY_API.CONFIG.ANCHOR_MAXROOM&&MY_API.AnchorLottery.roomidList.splice(0,MY_API.AnchorLottery.roomidList.length-MY_API.CONFIG.ANCHOR_MAXROOM),console.log("MY_API.AnchorLottery.roomidList 2222",MY_API.AnchorLottery.roomidList),localStorage.setItem(`${NAME}AnchorRoomidList`,JSON.stringify({list:MY_API.AnchorLottery.roomidList})),$.Deferred().resolve()))},check:roomid=>BAPI.xlive.anchor.check(roomid).then(response=>{if(MYDEBUG(`API.xlive.anchor.check(${roomid}) response`,response),0===response.code&&response.data){if(MY_API.CONFIG.ANCHOR_IGNORE_BLACKLIST)for(const str of MY_API.CONFIG.ANCHOR_BLACKLIST_WORD)if("/"!=str.charAt(0)&&"/"!=str.charAt(str.length-1)){if(response.data.award_name.toLowerCase().indexOf(str)>-1||response.data.danmu.toLowerCase().indexOf(str)>-1)return MY_API.chatLog(`[天选时刻] 忽略存疑天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id=${response.data.id}<br>含有关键字：`+str,"warning"),[!1]}else{let reg=eval(str);if(reg.test(response.data.award_name)||reg.test(response.data.danmu))return MY_API.chatLog(`[天选时刻] 忽略存疑天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id=${response.data.id}<br>匹配正则：`+str,"warning"),[!1]}const joinPrice=response.data.gift_num*response.data.gift_price;if(2===response.data.status)return MY_API.chatLog(`[天选时刻] 忽略已参加天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id=${response.data.id}`,"info"),[!1];if(0===response.data.time)return MY_API.chatLog(`[天选时刻] 忽略过期天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id=${response.data.id}`,"info"),[!1];if(joinPrice>MY_API.CONFIG.AHCHOR_NEED_GOLD)return MY_API.chatLog(`[天选时刻] 忽略付费天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id=${response.data.id}<br>所需金瓜子：${joinPrice}`,"warning"),[!1];switch(response.data.require_type){case 2:for(const t of MY_API.AnchorLottery.medal_list)if(t.long_roomid===response.data.room_id||t.roomid===response.data.room_id){if(t.level<response.data.require_value)return MY_API.chatLog(`[天选时刻] 忽略粉丝勋章等级不足的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id=${response.data.id}<br>所需勋章等级：${response.data.require_value} 你的勋章等级：${t.level}`,"warning"),[!1];break}return MY_API.chatLog(`[天选时刻] 忽略有粉丝勋章要求的天选<br>roomid = ${linkMsg(roomid,liveRoomUrl+roomid)}, id=${response.data.id}<br>所需勋章等级：${response.data.require_value}`,"warning"),[!1]}return[response.data.id,0===joinPrice?void 0:response.data.gift_id,0===joinPrice?void 0:response.data.gift_num,roomid,response.data.award_name,response.data.time]}return[!1]},()=>(MY_API.chatLog("[天选时刻] 天选检查出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.check(roomid)))),reCheck:t=>BAPI.xlive.anchor.check(t[3]).then(e=>{if(MYDEBUG(`API.xlive.anchor.reCheck(${t[3]}) response`,e),0===e.code&&e.data&&e.data.hasOwnProperty("award_users")&&e.data.award_users)for(const i of e.data.award_users)if(i.uid===Live_info.uid&&(MY_API.chatLog(`[天选时刻] 天选时刻<br>roomid = ${linkMsg(t[3],liveRoomUrl+t[3])}, id=${t[0]}中奖<br>奖品：${t[4]}<br>`,"prize"),winPrizeNum++,JQlogRedPoint.text(winPrizeNum),JQlogRedPoint.is(":hidden")&&JQlogRedPoint.show(),MY_API.CONFIG.FT_NOTICE))return FT_sendMsg(MY_API.CONFIG.FT_SCKEY,`【${GM_info.script.name}】天选时刻中奖通知 roomid = ${t[3]}，奖品:${t[4]}`,`###天选时刻中奖\n###roomid = ${t[3]}\n###id = ${t[0]}\n###获得奖品：\n###${t[4]}\n###请及时私信主播发放奖励`).then(t=>{MYDEBUG("FT_sendMsg response",t),0==t.body.errno?window.toast("[天选时刻] 方糖中奖提示发送成功","success"):window.toast(`[天选时刻] 方糖中奖提示发送失败 ${t.errmsg}`,"error")}),()=>(MY_API.chatLog("[天选时刻] 方糖中奖提示发送出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.reCheck(t)))},()=>(MY_API.chatLog("[天选时刻] 天选检查出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.check(roomid)))),join:t=>BAPI.xlive.anchor.join(t[0],t[1],t[2]).then(e=>{MYDEBUG(`API.xlive.anchor.join(${t[0]}) response`,e),0===e.code?(MY_API.chatLog(`[天选时刻] 成功参加天选<br>roomid = ${linkMsg(t[3],liveRoomUrl+t[3])}, id=${t[0]}<br>奖品：${t[4]}<br>`,"success"),MY_API.AnchorLottery.waitForRecheckList.push(t[3]),setTimeout(()=>{MY_API.AnchorLottery.reCheck(t)},1e3*(t[5]+3))):MY_API.chatLog(`[天选时刻] 天选参加失败<br>roomid = ${linkMsg(t[3],liveRoomUrl+t[3])}, id=${t[0]}<br>奖品：${t[4]}<br> ${e.msg}`,"warning")},()=>(MY_API.chatLog("[天选时刻] 天选参加出错，请检查网络","error"),delayCall(()=>MY_API.AnchorLottery.join(t)))),run:async()=>{if(!MY_API.CONFIG.ANCHOR_LOTTERY)return $.Deferred().resolve();const t=6e4*MY_API.CONFIG.ANCHOR_CHECK_INTERVAL;MY_API.chatLog("[天选时刻] 开始获取粉丝勋章信息"),await MY_API.AnchorLottery.getMedalList();for(let t=0;t<MY_API.AnchorLottery.medal_list.length;t++)await BAPI.room.get_info(MY_API.AnchorLottery.medal_list[t].roomid).then(e=>{MYDEBUG(`API.room.get_info roomId=${MY_API.AnchorLottery.medal_list[t].roomid} res`,e),MY_API.AnchorLottery.medal_list[t].long_roomid=e.data.room_id}),await sleep(MY_API.CONFIG.ANCHOR_INTERVAL);const e=ts_ms()-MY_API.CACHE.AnchorLottery_TS,i=e>=6e4*MY_API.CONFIG.ANCHOR_CHECK_INTERVAL?0:e;return MYDEBUG("[天选时刻]",`将在${i}毫秒后再次检查天选`),setTimeout(()=>(async function e(){await MY_API.AnchorLottery.getRoomList();const i=[...(JSON.parse(localStorage.getItem(`${NAME}AnchorRoomidList`))||{list:[]}).list];MY_API.chatLog(`[天选时刻] 开始检查天选（共${i.length}个房间）`,"success");for(const t of i)await MY_API.AnchorLottery.check(t).then(t=>{if(t[0])return MY_API.AnchorLottery.join(t)}),await sleep(MY_API.CONFIG.ANCHOR_INTERVAL);return MY_API.CACHE.AnchorLottery_TS=ts_ms(),MY_API.saveCache(),MY_API.chatLog(`[天选时刻] 本次轮询结束<br>${MY_API.CONFIG.ANCHOR_CHECK_INTERVAL}分钟后再次检查天选`,"success"),setTimeout(()=>e(),t)})(),i)}}};MY_API.init().then(()=>{try{if(0===parseInt(Live_info.uid)||isNaN(parseInt(Live_info.uid)))return void MY_API.chatLog("未登录，请先登录再使用脚本","warning");MY_API.newMessage(GM_info.script.version),MYDEBUG("MY_API.CONFIG",MY_API.CONFIG),StartPlunder(MY_API)}catch(t){console.error("初始化错误",t)}})}function StartPlunder(t){"use strict";let e=()=>{t.GIFT_COUNT.COUNT=0,t.GIFT_COUNT.CLEAR_TS=dateNow(),t.saveGiftCount(),MYDEBUG("已清空辣条数量")};checkNewDay(t.GIFT_COUNT.CLEAR_TS)&&e(),runExactMidnight(e,"重置统计"),t.creatSetBox(),t.removeUnnecessary();const i=["AUTO_GIFT_ROOMID","LIGHT_MEDALS","EXCLUDE_ROOMID"];if(!i.every(e=>$.isArray(t.CONFIG[e]))){for(const e of i)$.isArray(t.CONFIG[e])||(t.CONFIG[e]=t.CONFIG[e].split(","));t.chatLog("变量类型错误修复完成","success"),t.saveConfig()}if(setTimeout(()=>{t.AUTO_DANMU.run(),t.LITTLE_HEART.run(),t.GroupSign.run(),t.DailyReward.run(),t.LiveReward.run(),t.Exchange.runS2C(),t.Gift.run(),t.MaterialObject.run(),t.AnchorLottery.run()},6e3),t.CONFIG.LOTTERY&&(BAPI.room.getList().then(e=>{MYDEBUG("直播间列表",e);for(const i of e.data)BAPI.room.getRoomList(i.id,0,0,1,1).then(e=>{MYDEBUG("直播间号列表",e);for(let n=0;n<e.data.length;++n)t.listen(e.data[n].roomid,Live_info.uid,`${i.name}区`)})}),t.CONFIG.CHECK_HOUR_ROOM)){let e=()=>{if(t.GIFT_COUNT.COUNT>=t.CONFIG.MAX_GIFT&&(MYDEBUG("超过今日辣条限制，不参与抽奖"),t.max_blocked=!0),t.blocked||t.max_blocked)return t.blocked?(t.chatLog("进入小黑屋检查小时榜已停止运行"),void clearInterval(i)):void t.chatLog("辣条已达到最大值检查小时榜已停止运行");if(inTimeArea(t.CONFIG.TIME_AREA_START_H0UR,t.CONFIG.TIME_AREA_END_H0UR,t.CONFIG.TIME_AREA_START_MINUTE,t.CONFIG.TIME_AREA_END_MINUTE)&&t.CONFIG.TIME_AREA_DISABLE)return void t.chatLog("当前时间段不检查小时榜礼物","warning");const e=["小时总榜","娱乐小时榜","网游小时榜","手游小时榜","绘画小时榜","电台小时榜","单机小时榜"];let n=1,o=setInterval(()=>{n<e.length?((i=>{BAPI.rankdb.getTopRealTimeHour(i).then(n=>{let o=n.data.list;t.chatLog(`检查${e[i]}房间的礼物`,"warning");for(let e of o)t.checkRoom(e.roomid,`小时榜-${e.area_v2_parent_name}区`)})})(n),n++):clearInterval(o)},1e3)};setTimeout(e,6e3);let i=setInterval(e,parseInt(1e3*t.CONFIG.CHECK_HOUR_ROOM_INTERVAL))}const n=e=>{let i=setTimeout(()=>{if(t.raffleId_list.length>0||t.guardId_list.length>0||t.pkId_list.length>0)return MYDEBUG("[刷新直播间]","还有礼物没抽，延迟15s后刷新直播间"),n(15e3);if(checkNewDay(t.CACHE.LittleHeart_TS))return MYDEBUG("[刷新直播间]","正在获取小心心，10分钟后再次检查"),clearTimeout(i),n(6e5);if(inTimeArea(t.CONFIG.TIME_AREA_START_H0UR,t.CONFIG.TIME_AREA_END_H0UR,t.CONFIG.TIME_AREA_START_MINUTE,t.CONFIG.TIME_AREA_END_MINUTE)&&t.CONFIG.IN_TIME_RELOAD_DISABLE){let e=getIntervalTime(t.CONFIG.TIME_AREA_START_MINUTE,t.CONFIG.TIME_AREA_END_MINUTE)+6e4;return MYDEBUG("[刷新直播间]",`处于休眠时间段，将在${e}毫秒后刷新直播间`),n(e)}window.location.reload()},e)};t.CONFIG.TIME_RELOAD&&n(6e4*t.CONFIG.TIME_RELOAD_MINUTE)}function getIntervalTime(t,e,i){const n=new Date,o=3600*t*1e3+60*e*1e3+(i?1e3*i:0)-(3600*n.getHours()*1e3+60*n.getMinutes()*1e3+1e3*n.getSeconds());return MYDEBUG("[getIntervalTime]获取间隔时间",`${o}毫秒`),o<0?864e5+o:o}function isTime(t,e,i){let n=new Date,o=n.getHours(),a=n.getMinutes(),r=n.getSeconds();return o==t&&a==e&&!i||o==t&&a==e&&r==i||(MYDEBUG("isTime 错误时间",`目标时间${t}时${e}分${i||0}秒，当前时间${o}时${a}分${r}秒`),!1)}function inTimeArea(t,e,i,n){if(t>23||e>24||t<0||e<1||i>59||i<0||n>59||n<0)return!1;const o=new Date,a=o.getHours(),r=o.getMinutes();return t<e?a>=t&&a<e||a==e&&r>=i&&r<n:t>e?a>=t||a<e||a==e&&r>=i&&r<n:t==e?a==t&&i<=n&&r>=i&&r<n||a==t&&i>n&&r<=n&&r>i:void 0}function sleep(t){return new Promise(e=>{setTimeout(()=>{e()},t)})}function probability(t){if(t<=0)return!1;return t/100>=Math.random()}newWindow.init(),window.onload=(()=>{try{let t=localStorage.getItem(`${NAME}_UNIQUE_CHECK_CACHE`)||0;const e=ts_ms();if(e-t>=0&&e-t<=15e3)return window.toast("有其他直播间页面的脚本正在运行，本页面脚本停止运行","caution"),$.Deferred().resolve();let i;const n=()=>{i=setTimeout(n,1e4),t=ts_ms(),localStorage.setItem(`${NAME}_UNIQUE_CHECK_CACHE`,t)};window.addEventListener("unload",()=>{i&&(clearTimeout(i),t=0,localStorage.setItem(`${NAME}_UNIQUE_CHECK_CACHE`,t))}),n()}catch(t){return MYDEBUG("重复运行检测错误",t),$.Deferred().reject()}const t=(e=0)=>setTimeout(async()=>{const e="undefined"==typeof unsafeWindow?window:unsafeWindow;if(void 0===e.BilibiliLive||0===parseInt(e.BilibiliLive.UID)||isNaN(parseInt(e.BilibiliLive.UID)))return t(1e3);Live_info.room_id=e.BilibiliLive.ROOMID,Live_info.uid=e.BilibiliLive.UID,Live_info.tid=e.BilibiliLive.ANCHOR_UID,await BAPI.gift.gift_config().then(t=>{MYDEBUG("InitData: API.gift.gift_config",t),t.data&&$.isArray(t.data)?Live_info.gift_list=t.data:t.data.list&&$.isArray(t.data.list)?Live_info.gift_list=t.data.list:(Live_info.gift_list=[{id:6,price:1e3},{id:1,price:100},{id:30607,price:5e3}],window.toast("直播间礼物数据获取失败，使用备用数据","error"))}),Live_info.bili_jct=BAPI.getCookie("bili_jct"),Live_info.ruid=e.BilibiliLive.ANCHOR_UID,Live_info.rnd=e.BilibiliLive.RND,Live_info.visit_id=e.__statisObserver?e.__statisObserver.__visitId:"",MYDEBUG("Live_info",Live_info),init()},e);return t(0)}),Array.prototype.remove=function(t){const e=this.indexOf(t);e>-1&&this.splice(e,1)};const dateNow=()=>Date.now(),checkNewDay=t=>{if(0===t)return!0;let e=new Date(t),i=new Date,n=e.getDate();return i.getDate()!==n};function FT_sendMsg(t,e,i){return XHR({GM:!0,anonymous:!0,method:"POST",url:`https://sc.ftqq.com/${t}.send`,responseType:"json",data:encodeURI(`text=${e}&desp=${i}`)})}function XHR(t){return new Promise(e=>{const i=t=>{console.error(GM_info.script.name,t),e(void 0)};if(t.GM)"POST"===t.method&&(void 0===t.headers&&(t.headers={}),void 0===t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8")),t.timeout=3e4,t.onload=(t=>e({response:t,body:t.response})),t.onerror=i,t.ontimeout=i,GM_xmlhttpRequest(t);else{const n=new XMLHttpRequest;n.open(t.method,t.url),"POST"===t.method&&null===n.getResponseHeader("Content-Type")&&n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8"),t.cookie&&(n.withCredentials=!0),void 0!==t.responseType&&(n.responseType=t.responseType),n.timeout=3e4,n.onload=(t=>{const i=t.target;e({response:i,body:i.response})}),n.onerror=i,n.ontimeout=i,n.send(t.data)}})}}();
// ==UserScript==
// @namespace     https://github.com/andywang425
// @name          B站直播自动抢辣条
// @name:en       B站直播自动抢辣条
// @author        andywang425
// @description   自动参与Bilibili直播区广播礼物及小时榜房间礼物的抽奖;完成每日任务
// @description:en 自动参与Bilibili直播区广播礼物及小时榜房间礼物的抽奖;完成每日任务
// @updateURL     https://raw.githubusercontent.com/andywang425/Bilibili-SGTH/master/B%E7%AB%99%E7%9B%B4%E6%92%AD%E8%87%AA%E5%8A%A8%E6%8A%A2%E8%BE%A3%E6%9D%A1.user.js
// @downloadURL    https://raw.githubusercontent.com/andywang425/Bilibili-SGTH/master/B%E7%AB%99%E7%9B%B4%E6%92%AD%E8%87%AA%E5%8A%A8%E6%8A%A2%E8%BE%A3%E6%9D%A1.user.js
// @homepageURL   https://github.com/andywang425/Bilibili-SGTH/
// @supportURL    https://github.com/andywang425/Bilibili-SGTH/issues
// @icon          https://s1.hdslb.com/bfs/live/d57afb7c5596359970eb430655c6aef501a268ab.png
// @copyright     2020, andywang425 (https://github.com/andywang425)
// @license       MIT
// @version       2.5.4
// @include      /https?:\/\/live\.bilibili\.com\/[blanc\/]?[^?]*?\d+\??.*/
// @run-at       document-end
// @require      https://cdn.jsdelivr.net/gh/jquery/jquery@3.2.1/dist/jquery.min.js
// @require      https://cdn.jsdelivr.net/gh/andywang425/Bilibili-SGTH@v1.2/BilibiliAPI_Mod.min.js
// @require      https://cdn.jsdelivr.net/gh/andywang425/Bilibili-SGTH@v1.2/OCRAD.min.js
// @grant        none
// ==/UserScript==
"use strict";function addStyle(){$("head").append("\n    <style>\n        .igiftMsg_input{\n            outline: none;\n            border: 1px solid #e9eaec;\n            background-color: #fff;\n            border-radius: 4px;\n            padding: 1px 0 0;\n            overflow: hidden;\n            font-size: 12px;\n            line-height: 19px;\n            width: 30px;\n            'z-index': '10001';\n        }\n        .igiftMsg_btn{\n            background-color: #23ade5;\n            color: #fff;\n            border-radius: 4px;\n            border: none;\n            padding: 5px;\n            cursor: pointer;\n            box-shadow: 0 0 2px #00000075;\n            line-height: 10px;\n            'z-index': '10001';\n        }\n        .igiftMsg_fs{\n            border: 2px solid #d4d4d4;\n            'z-index': '10001';\n        }\n        input[type=checkbox] {\n            margin-right: 10px;\n            cursor: pointer;\n            width: 10px;\n            height: 10px;\n            position: relative;\n        }\n         \n        input[type=checkbox]:after {\n            position: absolute;\n            width: 7px;\n            height: 10px;\n            top: 0;\n            content: \" \";\n            background-color: #fff;\n            color: #fff;\n            display: inline-block;\n            visibility: visible;\n            border: 1px solid grey;\n            padding: 0 2px;\n            border-radius: 2px;\n        }\n         \n        input[type=checkbox]:checked:after {\n            background-color: #0f97e7;\n            content: \"✔\";\n            font-size: 10px;\n        }\n         \n        input[type=checkbox]:disabled:after {\n            width: 7px;\n            height: 10px;\n            top: 0;\n            color: #fff;\n            display: inline-block;\n            visibility: visible;\n            border: 1px solid grey;\n            padding: 0 2px;\n            border-radius: 2px;\n            background-color: #E9E7E3;\n            content: \"✔\";\n            font-size: 10px;\n        }\n    </style>\n        ")}function init(){var e=this;try{BAPI.setCommonArgs(BAPI.getCookie("bili_jct"))}catch(e){return void console.error("["+NAME+"]",e)}var t={CONFIG_DEFAULT:{TIME_RELOAD:60,RANDOM_DELAY:!0,RND_DELAY_START:2,RND_DELAY_END:5,TIME_AREA_DISABLE:!0,TIME_AREA_START_H0UR:2,TIME_AREA_END_H0UR:8,TIME_AREA_START_MINUTE:0,TIME_AREA_END_MINUTE:0,RANDOM_SKIP:0,MAX_GIFT:99999,IN_TIME_RELOAD_DISABLE:!1,RANDOM_SEND_DANMU:0,AUTO_GROUP_SIGN:!0,LIVE_SIGN:!0,FORCE_LOTTERY:!1,LOGIN:!0,WATCH:!0,COIN:!1,COIN_NUMBER:0,SHARE:!0,AUTO_TREASUREBOX:!0,SILVER2COIN:!1},CACHE_DEFAULT:{UNIQUE_CHECK:0,AUTO_GROUP_SIGH_TS:0,DailyReward_TS:0,LiveReward_TS:0,TreasureBox_TS:0,Silver2Coin_TS:0},CONFIG:{},CACHE:{},GIFT_COUNT:{COUNT:0,LOVE_COUNT:0,SILVER_COUNT:0,CLEAR_TS:0},init:function(){var e=$.Deferred();try{t.loadConfig().then(function(){t.chatLog("脚本载入配置成功","success"),e.resolve()})}catch(n){console.error("API初始化出错",n),t.chatLog("API初始化出错","warning"),e.reject()}try{t.loadCache().then(function(){window.toast("CACHE载入成功","success"),e.resolve()})}catch(t){console.error("CACHE初始化出错",t),window.toast("CACHE初始化出错","error"),e.reject()}return setTimeout(function(){t.TreasureBox.init()},3e3),e},loadConfig:function(){var e=$.Deferred();try{var n=JSON.parse(localStorage.getItem(NAME+"_CONFIG"));$.extend(!0,t.CONFIG,t.CONFIG_DEFAULT);for(var o in t.CONFIG)t.CONFIG.hasOwnProperty(o)&&void 0!==n[o]&&null!==n[o]&&(t.CONFIG[o]=n[o]);t.loadGiftCount(),e.resolve()}catch(n){console.log("API载入配置失败，加载默认配置",n),t.setDefaults(),e.reject()}return e},loadCache:function(){var e=$.Deferred();try{var n=JSON.parse(localStorage.getItem(NAME+"_CACHE"));$.extend(!0,t.CACHE,t.CACHE_DEFAULT);for(var o in t.CACHE)t.CACHE.hasOwnProperty(o)&&void 0!==n[o]&&null!==n[o]&&(t.CACHE[o]=n[o]);e.resolve()}catch(n){console.log("CACHE载入配置失败，加载默认配置",n),t.setDefaults(),e.reject()}return e},saveConfig:function(){try{return localStorage.setItem(NAME+"_CONFIG",JSON.stringify(t.CONFIG)),t.chatLog("配置已保存"),console.log(t.CONFIG),!0}catch(e){return console.log("API保存出错",e),!1}},saveCache:function(){try{return localStorage.setItem(NAME+"_CACHE",JSON.stringify(t.CACHE)),console.log("CACHE已保存",t.CACHE),!0}catch(e){return console.log("CACHE保存出错",e),!1}},setDefaults:function(){t.CONFIG=t.CONFIG_DEFAULT,t.CACHE=t.CACHE_DEFAULT,t.saveConfig(),t.saveCache(),t.chatLog("配置和CACHE已重置为默认。3秒后刷新页面"),setTimeout(function(){window.location.reload()},3e3)},setDailyTasksDefaults:function(){window.toast("3秒后刷新页面并再次执行每日任务","info"),setTimeout(function(){t.CACHE=t.CACHE_DEFAULT,t.saveCache(),window.location.reload()},3e3)},loadGiftCount:function(){try{var e=JSON.parse(localStorage.getItem(NAME+"_GIFT_COUNT"));for(var n in t.GIFT_COUNT)t.GIFT_COUNT.hasOwnProperty(n)&&void 0!==e[n]&&null!==e[n]&&(t.GIFT_COUNT[n]=e[n]);console.log(t.GIFT_COUNT)}catch(e){console.log("读取统计失败",e)}},saveGiftCount:function(){try{return localStorage.setItem(NAME+"_GIFT_COUNT",JSON.stringify(t.GIFT_COUNT)),console.log("统计保存成功",t.GIFT_COUNT),!0}catch(e){return console.log("统计保存出错",e),!1}},addGift:function(e){t.GIFT_COUNT.COUNT+=e,$("#giftCount span:eq(0)").text(t.GIFT_COUNT.COUNT),t.saveGiftCount()},addLove:function(e){t.GIFT_COUNT.LOVE_COUNT+=e,$("#giftCount span:eq(1)").text(t.GIFT_COUNT.LOVE_COUNT),t.saveGiftCount()},addSilver:function(e){t.GIFT_COUNT.SILVER_COUNT+=10*e,$("#giftCount span:eq(2)").text(t.GIFT_COUNT.SILVER_COUNT),t.saveGiftCount()},checkUpdate:function(){window.open("https://raw.githubusercontent.com/andywang425/Bilibili-SGTH/master/B%E7%AB%99%E7%9B%B4%E6%92%AD%E8%87%AA%E5%8A%A8%E6%8A%A2%E8%BE%A3%E6%9D%A1.user.js","_blank").location},creatSetBox:function(){var n=$('<button style="display: inline-block; float: left; margin-right: 7px;background-color: #23ade5;color: #fff;border-radius: 4px;border: none; padding:4px; cursor: pointer;box-shadow: 1px 1px 2px #00000075;" id="hiderbtn">隐藏窗口和抽奖信息<br></button>');n.click(function(){if(0==msgHide){msgHide=!0,$(".igiftMsg").hide(),o.hide();var e=$(".attention-btn-ctnr");e.animate({scrollTop:0},0),e.animate({scrollTop:e.prop("scrollHeight")},10),document.getElementById("hiderbtn").innerHTML="显示窗口和抽奖信息"}else{msgHide=!1,$(".igiftMsg").show(),o.show();var t=$(".attention-btn-ctnr");t.animate({scrollTop:t.prop("scrollHeight")},0),document.getElementById("hiderbtn").innerHTML="隐藏窗口和抽奖信息"}}),$(".attention-btn-ctnr").append(n);var o=$("<div>");o.css({width:"auto",height:"auto",position:"absolute",top:"0px",right:"0px",background:"#F0F0F0",padding:"10px","z-index":"10001","border-radius":"4px",overflow:"hidden"}),o.append('\n<fieldset class="igiftMsg_fs">\n     <legend style = "color: black">今日统计</legend>\n            <div id="giftCount" style="font-size: large; text-shadow: 1px 1px #00000066; color: blueviolet;">\n            辣条&nbsp;<span>'+t.GIFT_COUNT.COUNT+"</span> <s>亲密度</s>&nbsp;<span>"+t.GIFT_COUNT.LOVE_COUNT+"</span>\n            银瓜子&nbsp;<span>"+t.GIFT_COUNT.SILVER_COUNT+'万</span>\n            <button style="font-size: small" class="igiftMsg_btn" data-action="save">保存所有设置</button>\n            </div>\n</fieldset>\n\n<fieldset class="igiftMsg_fs">\n     <legend style = "color: black">低调设置</legend>\n     <div data-toggle="RANDOM_DELAY">\n        <label style="cursor: pointer; margin: 5px auto; color: darkgreen">\n        <input style="vertical-align: text-top;" type="checkbox">抽奖附加随机延迟\n        <input class="RND_DELAY_START igiftMsg_input" style="width: 20px;vertical-align: top;" type="text">~\n        <input class="RND_DELAY_END igiftMsg_input" style="width: 20px;vertical-align: top;" type="text">s\n        </label>\n    </div>\n    <div data-toggle="TIME_AREA_DISABLE">\n        <label style="cursor: pointer; margin: 5px auto; color: darkgreen">\n        <input style="vertical-align: text-top;" type="checkbox">启用\n        <input class="startHour igiftMsg_input" style="width: 20px;" type="text">点\n        <input class="startMinute igiftMsg_input" style="width: 20px;" type="text">分至\n        <input class="endHour igiftMsg_input" style="width: 20px;" type="text">点\n        <input class="endMinute igiftMsg_input" style="width: 20px;" type="text">分不抽奖(24小时制)\n        </label>\n    </div>\n    <div data-toggle="RANDOM_SKIP">\n        <label style="cursor: pointer; margin: 5px auto; color: darkgreen">\n        随机跳过礼物(整数0到100,为0则不跳过)<input class="per igiftMsg_input" style="width: 20px;" type="text">%\n        </label>\n    </div>\n    <div data-toggle="MAX_GIFT">\n        <label style="cursor: pointer; margin: 5px auto; color: darkgreen">\n        当天最多抢辣条数量(整数)<input class="num igiftMsg_input" style="width: 40px;" type="text">\n        </label>    \n    </div>\n    <div data-toggle="RANDOM_SEND_DANMU">\n        <label style="cursor: pointer; margin: 5px auto; color: darkgreen">\n        抽奖时活跃弹幕发送概率(整数0到5,为0则不发送)<input class="per igiftMsg_input" style="width: 20px;" type="text">%\n        </label>\n    </div>\n</fieldset>\n\n<fieldset class="igiftMsg_fs">\n    <legend style = "color: black">每日任务设置</legend>\n    <div style ="line-height: 15px; color: black" data-toggle="LOGIN">\n    <input style="vertical-align: text-top;" type="checkbox">\n    登陆\n    </div>\n    <div style ="line-height: 15px; color: black" data-toggle="WATCH">\n    <input style="vertical-align: text-top;" type="checkbox">\n    观看视频\n    </div>\n    <div style ="line-height: 15px; color: black" data-toggle="COIN">\n    <input style="vertical-align: text-top;" type="checkbox">\n    自动投币<input class="coin_number igiftMsg_input" style="width: 40px;" type="text">个   \n    </div>\n    <div style ="line-height: 15px; color: black" data-toggle="SHARE">\n    <input style="vertical-align: text-top;" type="checkbox">\n    分享视频\n    </div>\n    </div>\n    <div style ="line-height: 15px; color: black" data-toggle="SILVER2COIN">\n    <input style="vertical-align: text-top;" type="checkbox">\n    银瓜子换硬币\n    </div>\n    <div style ="line-height: 15px; color: black" data-toggle="LIVE_SIGN">\n    <input style="vertical-align: text-top;" type="checkbox">\n    直播区签到\n    </div>\n    <div style ="line-height: 15px" data-toggle="AUTO_GROUP_SIGN">\n    <label style="cursor: pointer; margin: 5px auto; color: darkgreen">\n        <input style="vertical-align: text-top;" type="checkbox">\n        应援团签到\n    </label> \n    </div>\n    <div style ="line-height: 15px" data-toggle="AUTO_TREASUREBOX">\n    <label style="cursor: pointer; margin: 5px auto; color: purple">\n        <input style="vertical-align: text-top;" type="checkbox">\n        自动领银瓜子宝箱\n    </label> \n    </div>\n    <div><button data-action="reset_dailyTasks" style="color: red;" class="igiftMsg_btn">再次执行每日任务</button></div>\n    </fieldset>\n<fieldset class="igiftMsg_fs">\n    <legend style = "color: black">其他设置</legend>\n    <div style = "color: black" data-toggle="TIME_RELOAD">\n    本直播间重载时间(整数,刷新后生效)：\n    <input class="delay-seconds igiftMsg_input" type="text" style="width: 30px;">分\n    <div style = "line-height: 15px" data-toggle="IN_TIME_RELOAD_DISABLE">\n        <label style="cursor: pointer; margin: 5px auto; color: darkgreen">\n            <input style="vertical-align: text-top;" type="checkbox">不抽奖时段不重载直播间\n        </label>        \n    </div>\n    <div style = "line-height: 15px" data-toggle="FORCE_LOTTERY">\n        <label style="cursor: pointer; margin: 5px auto; color: red;">\n            <input style="vertical-align: text-top;" type="checkbox">进入小黑屋后强制重复抽奖(危)\n        </label>\n    </div>\n    <div id = "resetArea">\n        <button data-action="reset" style="color: red;" class="igiftMsg_btn">重置所有为默认</button>\n        <button style="font-size: small" class="igiftMsg_btn" data-action="countReset">重置统计</button>\n        <button style="font-size: small; color: green;" class="igiftMsg_btn" data-action="checkUpdate">检查更新</button>\n    </div>\n\n</fieldset>\n\n<label style ="color: darkblue">\n        v2.5.4 <a href="https://github.com/andywang425/Bilibili-SGTH/" target="_blank">更多说明和更新日志见github上的项目说明(点我)</a>\n</label>\n'),$(".live-player-mounter").append(o),o.find('div[data-toggle="TIME_RELOAD"] .delay-seconds').val(t.CONFIG.TIME_RELOAD.toString()),o.find('div[data-toggle="RANDOM_SKIP"] .per').val(parseInt(t.CONFIG.RANDOM_SKIP).toString()),o.find('div[data-toggle="RANDOM_SEND_DANMU"] .per').val(parseInt(t.CONFIG.RANDOM_SEND_DANMU).toString()),o.find('div[data-toggle="MAX_GIFT"] .num').val(parseInt(t.CONFIG.MAX_GIFT).toString()),t.CONFIG.RANDOM_DELAY&&o.find('div[data-toggle="RANDOM_DELAY"] input').attr("checked",""),t.CONFIG.TIME_AREA_DISABLE&&o.find('div[data-toggle="TIME_AREA_DISABLE"] input').attr("checked",""),t.CONFIG.IN_TIME_RELOAD_DISABLE&&o.find('div[data-toggle="IN_TIME_RELOAD_DISABLE"] input').attr("checked",""),t.CONFIG.AUTO_GROUP_SIGN&&o.find('div[data-toggle="AUTO_GROUP_SIGN"] input').attr("checked",""),t.CONFIG.FORCE_LOTTERY&&o.find('div[data-toggle="FORCE_LOTTERY"] input').attr("checked",""),t.CONFIG.LOGIN&&o.find('div[data-toggle="LOGIN"] input').attr("checked",""),t.CONFIG.WATCH&&o.find('div[data-toggle="WATCH"] input').attr("checked",""),t.CONFIG.COIN&&o.find('div[data-toggle="COIN"] input').attr("checked",""),t.CONFIG.SHARE&&o.find('div[data-toggle="SHARE"] input').attr("checked",""),t.CONFIG.LIVE_SIGN&&o.find('div[data-toggle="LIVE_SIGN"] input').attr("checked",""),t.CONFIG.AUTO_TREASUREBOX&&o.find('div[data-toggle="AUTO_TREASUREBOX"] input').attr("checked",""),t.CONFIG.SILVER2COIN&&o.find('div[data-toggle="SILVER2COIN"] input').attr("checked",""),o.find('div[data-toggle="COIN"] .coin_number').val(t.CONFIG.COIN_NUMBER.toString()),o.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_START').val(t.CONFIG.RND_DELAY_START.toString()),o.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_END').val(t.CONFIG.RND_DELAY_END.toString()),o.find('div[data-toggle="TIME_AREA_DISABLE"] .startHour').val(t.CONFIG.TIME_AREA_START_H0UR.toString()),o.find('div[data-toggle="TIME_AREA_DISABLE"] .endHour').val(t.CONFIG.TIME_AREA_END_H0UR.toString()),o.find('div[data-toggle="TIME_AREA_DISABLE"] .startMinute').val(t.CONFIG.TIME_AREA_START_MINUTE.toString()),o.find('div[data-toggle="TIME_AREA_DISABLE"] .endMinute').val(t.CONFIG.TIME_AREA_END_MINUTE.toString()),o.find('div[id="giftCount"] [data-action="save"]').click(function(){var e=t.CONFIG.TIME_AREA_START_H0UR=parseInt(o.find('div[data-toggle="TIME_AREA_DISABLE"] .startHour').val()),n=t.CONFIG.TIME_AREA_END_H0UR=parseInt(o.find('div[data-toggle="TIME_AREA_DISABLE"] .endHour').val()),r=t.CONFIG.TIME_AREA_START_MINUTE=parseInt(o.find('div[data-toggle="TIME_AREA_DISABLE"] .startMinute').val()),i=t.CONFIG.TIME_AREA_END_MINUTE=parseInt(o.find('div[data-toggle="TIME_AREA_DISABLE"] .endMinute').val());return e<0||n<0||r<0||i<0?void t.chatLog("[定时休眠]数据小于0"):e>24||n>24||r>60||i>60?void t.chatLog("[定时休眠]时间错误"):(t.CONFIG.TIME_AREA_START_H0UR=e,t.CONFIG.TIME_AREA_END_H0UR=n,t.CONFIG.TIME_AREA_START_MINUTE=r,t.CONFIG.TIME_AREA_END_MINUTE=i,val=parseInt(o.find('div[data-toggle="RANDOM_SKIP"] .per').val()),val<0||val>100?void t.chatLog("[随机跳过礼物]数据小于等于0或大于10000"):(t.CONFIG.RANDOM_SKIP=val,val=parseInt(o.find('div[data-toggle="RANDOM_SEND_DANMU"] .per').val()),val>5?void t.chatLog("[活跃弹幕]为维护直播间弹幕氛围,弹幕发送概率不得大于5%"):val<0?void t.chatLog("[活跃弹幕]数据小于0"):(t.CONFIG.RANDOM_SEND_DANMU=val,val=parseInt(o.find('div[data-toggle="MAX_GIFT"] .num').val()),t.CONFIG.MAX_GIFT=val,val=parseInt(o.find('div[data-toggle="TIME_RELOAD"] .delay-seconds').val()),val<=0||val>1e4?void t.chatLog("[直播间重载时间]数据小于等于0或大于10000"):(t.CONFIG.TIME_RELOAD=val,val=parseInt(o.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_START').val()),n=parseInt(o.find('div[data-toggle="RANDOM_DELAY"] .RND_DELAY_END').val()),val<0||n>100?void t.chatLog("[抽奖延时]数据小于0或大于100"):n<=val?void t.chatLog("[抽奖延时]数据大小关系不正确"):(t.CONFIG.RND_DELAY_START=val,t.CONFIG.RND_DELAY_END=n,val=parseInt(o.find('div[data-toggle="COIN"] .coin_number').val()),val<0?void t.chatLog("[自动投币]数据小于0"):(t.CONFIG.COIN_NUMBER=val,void t.saveConfig()))))))}),o.find('button[data-action="reset"]').click(function(){t.setDefaults()}),o.find('button[data-action="checkUpdate"]').click(function(){t.checkUpdate()}),o.find('button[data-action="reset_dailyTasks"]').click(function(){t.setDailyTasksDefaults()}),o.find('div[data-toggle="RANDOM_DELAY"] input:checkbox').change(function(){t.CONFIG.RANDOM_DELAY=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="RANDOM_DELAY"] [data-action="save"] input').click(function(){t.CONFIG.RND_DELAY_START=parseInt(o.find('div[data-toggle="RANDOM_DELAY"].RND_DELAY_START').val()),t.CONFIG.RND_DELAY_END=parseInt(o.find('div[data-toggle="RANDOM_DELAY"].RND_DELAY_END').val()),t.saveConfig()}),o.find('div[data-toggle="TIME_AREA_DISABLE"] input:checkbox').change(function(){t.CONFIG.TIME_AREA_DISABLE=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="AUTO_GROUP_SIGN"] input:checkbox').change(function(){t.CONFIG.AUTO_GROUP_SIGN=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="FORCE_LOTTERY"] input:checkbox').change(function(){t.CONFIG.FORCE_LOTTERY=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="LOGIN"] input:checkbox').change(function(){t.CONFIG.LOGIN=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="WATCH"] input:checkbox').change(function(){t.CONFIG.WATCH=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="COIN"] input:checkbox').change(function(){t.CONFIG.COIN=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="SHARE"] input:checkbox').change(function(){t.CONFIG.SHARE=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="SILVER2COIN"] input:checkbox').change(function(){t.CONFIG.SILVER2COIN=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="LIVE_SIGN"] input:checkbox').change(function(){t.CONFIG.LIVE_SIGN=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="AUTO_TREASUREBOX"] input:checkbox').change(function(){t.CONFIG.AUTO_TREASUREBOX=$(e).prop("checked"),t.saveConfig()}),o.find('div[data-toggle="IN_TIME_RELOAD_DISABLE"] input:checkbox').change(function(){t.CONFIG.IN_TIME_RELOAD_DISABLE=$(e).prop("checked"),t.saveConfig()}),o.find('#resetArea [data-action="countReset"]').click(function(){t.GIFT_COUNT={COUNT:0,LOVE_COUNT:0,CLEAR_TS:0},t.saveGiftCount(),t.chatLog("已清空3秒后刷新页面"),setTimeout(function(){window.location.reload()},3e3)})},chatLog:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=$("<div class='igiftMsg'>"),o=$("<div>"),r=$("#chat-history-list"),i=new Date;switch(o.text(e),n.text(i.toLocaleString()),n.append(o),n.css({"text-align":"center","border-radius":"4px","min-height":"30px",width:"256px",color:"#9585FF","line-height":"30px",padding:"0 10px",margin:"10px auto"}),o.css({"word-wrap":"break-word",width:"100%","line-height":"1em","margin-bottom":"10px"}),t){case"warning":n.css({border:"1px solid rgb(236, 221, 192)",color:"rgb(218, 142, 36)",background:"rgb(245, 235, 221) none repeat scroll 0% 0%"});break;case"success":n.css({border:"1px solid rgba(22, 140, 0, 0.28)",color:"rgb(69, 171, 69)",background:"none 0% 0% repeat scroll rgba(16, 255, 0, 0.18)"});break;default:n.css({border:"1px solid rgb(203, 195, 255)",background:"rgb(233, 230, 255) none repeat scroll 0% 0%"})}0==msgHide&&(r.find("#chat-items").append(n),r.scrollTop(r.prop("scrollHeight")))},blocked:!1,max_blocked:!1,listen:function(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"本直播间";BAPI.room.getConf(e).then(function(r){server_host=r.data.host,console.log("服务器地址",r);var i=new BAPI.DanmuWebSocket(n,e,r.data.host_server_list,r.data.token);i.bind(function(e){i=e,t.chatLog(o+"弹幕服务器连接断开，尝试重连","warning")},function(){t.chatLog("——————连接弹幕服务器成功——————\n房间号: "+e+" 分区: "+o,"success")},function(){t.blocked&&(i.close(),t.chatLog("进了小黑屋主动与弹幕服务器断开连接-"+o,"warning")),t.max_blocked&&(i.close(),t.chatLog("辣条最大值主动与弹幕服务器断开连接-"+o,"warning"))},function(e){if(!inTimeArea(t.CONFIG.TIME_AREA_START_H0UR,t.CONFIG.TIME_AREA_END_H0UR,t.CONFIG.TIME_AREA_START_MINUTE,t.CONFIG.TIME_AREA_END_MINUTE)||!t.CONFIG.TIME_AREA_DISABLE)switch(console.log("弹幕公告"+o,e),e.cmd){case"GUARD_MSG":e.roomid===e.real_roomid?t.checkRoom(e.roomid,o):(t.checkRoom(e.roomid,o),t.checkRoom(e.real_roomid,o));break;case"PK_BATTLE_SETTLE_USER":t.checkRoom(e.data.winner.room_id,o);break;case"NOTICE_MSG":e.roomid===e.real_roomid?t.checkRoom(e.roomid,o):(t.checkRoom(e.roomid,o),t.checkRoom(e.real_roomid,o));break;default:return}})},function(){t.chatLog("获取弹幕服务器地址错误","warning")})},RoomId_list:[],err_roomId:[],auto_danmu_list:["(=・ω・=)","（￣▽￣）","awsl","666","kksk","(⌒▽⌒)","(｀・ω・´)","╮(￣▽￣)╭","(￣3￣)","Σ( ￣□￣||)","(^・ω・^ )","_(:3」∠)_"],checkRoom:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"本直播间";t.blocked||t.max_blocked||t.RoomId_list.indexOf(e)>=0||(t.RoomId_list.push(e),BAPI.room.room_entry_action(e),probability(t.CONFIG.RANDOM_SEND_DANMU)&&BAPI.sendLiveDanmu(t.auto_danmu_list[Math.floor(12*Math.random())],e).then(function(e){console.log("弹幕发送回显",e)}),BAPI.xlive.lottery.check(e).then(function(o){t.RoomId_list.remove(e),console.log("检查房间返回信息",o);var r=o.data;if(0===o.code){var i=void 0;if(r.gift){i=r.gift;for(var a in i)i.hasOwnProperty(a)&&t.creat_join(e,i[a],"gift",n)}if(r.guard){i=r.guard;for(var d in i)i.hasOwnProperty(d)&&t.creat_join(e,i[d],"guard",n)}if(r.pk){i=r.pk;for(var s in i)i.hasOwnProperty(s)&&t.creat_join(e,i[s],"pk",n)}}else t.chatLog("[检查房间出错]"+response.msg,"warning"),t.err_roomId.indexOf(e)>-1?console.log("[检查此房间出错多次]"+e+o.message):(t.err_roomId.push(e),t.checkRoom(e,n),console.log("[检查房间出错_重试一次]"+e+o.message))}))},Id_list_history:{add:function(e,t){var n=[];try{var o=JSON.parse(localStorage.getItem(NAME+"_"+t+"Id_list"));n=[].concat(o.list),n.push(e),n.length>150&&n.splice(0,50),localStorage.setItem(NAME+"_"+t+"Id_list",JSON.stringify({list:n})),console.log(NAME+"_"+t+"Id_list_add",n)}catch(o){n.push(e),localStorage.setItem(NAME+"_"+t+"Id_list",JSON.stringify({list:n}))}},isIn:function(e,t){var n=[];try{var o=JSON.parse(localStorage.getItem(NAME+"_"+t+"Id_list"));return n=null===o?[]:[].concat(o.list),console.log(NAME+"_"+t+"Id_list_read",o),n.indexOf(e)>-1}catch(o){return localStorage.setItem(NAME+"_"+t+"Id_list",JSON.stringify({list:n})),console.log("读取"+NAME+"_"+t+"Id_list缓存错误已重置"),n.indexOf(e)>-1}}},raffleId_list:[],guardId_list:[],pkId_list:[],creat_join:function(e,n,o){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"本直播间";if(console.log("礼物信息",n),t.GIFT_COUNT.COUNT>=t.CONFIG.MAX_GIFT)return console.log("超过今日辣条限制，不参与抽奖"),void(t.max_blocked=!0);switch(o){case"gift":if(t.Id_list_history.isIn(n.raffleId,"raffle"))return void console.log("礼物重复");t.raffleId_list.push(n.raffleId),t.Id_list_history.add(n.raffleId,"raffle");break;case"guard":if(t.Id_list_history.isIn(n.id,"guard"))return void console.log("舰长重复");t.guardId_list.push(n.id),t.Id_list_history.add(n.id,"guard");break;case"pk":if(t.Id_list_history.isIn(n.id,"pk"))return void console.log("pk重复");t.pkId_list.push(n.id),t.Id_list_history.add(n.id,"pk")}var i=n.time_wait||0;t.CONFIG.RANDOM_DELAY&&(i+=Math.floor(Math.random()*(t.CONFIG.RND_DELAY_END-t.CONFIG.RND_DELAY_START+1))+t.CONFIG.RND_DELAY_START);var a=$("<div class='igiftMsg'>"),d=$("<div>"),s=$("<div>"),c=$("#chat-history-list"),l=new Date;d.text("["+r+"]"+n.thank_text.split("<%")[1].split("%>")[0]+n.thank_text.split("%>")[1]),a.text(l.toLocaleString()),a.append(d),s.css("color","red"),s.text("等待抽奖"),d.append(s),a.css({"text-align":"center","border-radius":"4px","min-height":"30px",width:"256px",color:"#9585FF","line-height":"30px",padding:"0 10px",margin:"10px auto"}),d.css({"word-wrap":"break-word",width:"100%","line-height":"1em","margin-bottom":"10px"}),a.css({border:"1px solid rgb(203, 195, 255)",background:"rgb(233, 230, 255) none repeat scroll 0% 0%"}),0==msgHide&&(c.find("#chat-items").append(a),c.scrollTop(c.prop("scrollHeight")));var u=setInterval(function(){if(s.text("等待抽奖倒计时"+i+"秒"),i<=0){if(probability(t.CONFIG.RANDOM_SKIP))s.text("跳过此礼物抽奖");else switch(s.text("进行抽奖..."),o){case"gift":t.gift_join(e,n.raffleId,n.type).then(function(e,o){s.text("获得"+e),o&&(e.indexOf("辣条")>-1?t.addGift(o):e.indexOf("亲密度")>-1?t.addLove(o):e.indexOf("银瓜子")>-1&&t.addSilver(o)),t.raffleId_list.remove(n.raffleId)});break;case"guard":t.guard_join(e,n.id).then(function(e,o){s.text("获得"+e),o&&(e.indexOf("辣条")>-1?t.addGift(o):e.indexOf("亲密度")>-1?t.addLove(o):e.indexOf("银瓜子")>-1&&t.addSilver(o)),t.guardId_list.remove(n.id)});break;case"pk":t.pk_join(e,n.id).then(function(e,o){s.text("获得"+e),o&&(e.indexOf("辣条")>-1?t.addGift(o):e.indexOf("亲密度")>-1?t.addLove(o):e.indexOf("银瓜子")>-1&&t.addSilver(o)),t.pkId_list.remove(n.id)})}s.css("color","green"),clearInterval(u)}i--},1e3)},gift_join:function(e,n,o){var r=$.Deferred();return BAPI.Lottery.Gift.join(e,n,o).then(function(i){switch(console.log("抽奖返回信息",i),i.code){case 0:i.data.award_text?r.resolve(i.data.award_text,i.data.award_num):r.resolve(i.data.award_name+"X"+i.data.award_num.toString(),i.data.award_num);break;default:i.msg.indexOf("拒绝")>-1?0==t.CONFIG.FORCE_LOTTERY?(t.blocked=!0,r.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):++gift_join_try<=5?t.gift_join(e,n,o):(gift_join_try=0,r.resolve("[礼物抽奖](roomid="+e+",id="+n+",type="+o+")"+i.msg)):r.resolve("[礼物抽奖](roomid="+e+",id="+n+",type="+o+")"+i.msg)}}),r},guard_join:function(e,n){var o=$.Deferred();return BAPI.Lottery.Guard.join(e,n).then(function(r){switch(console.log("上船抽奖返回信息",r),r.code){case 0:r.data.award_text?o.resolve(r.data.award_text,r.data.award_num):o.resolve(r.data.award_name+"X"+r.data.award_num.toString(),r.data.award_num);break;default:r.msg.indexOf("拒绝")>-1?0==t.CONFIG.FORCE_LOTTERY?(t.blocked=!0,o.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):++guard_join_try<=5?t.guard_join(e,id):(guard_join_try=0,o.resolve("[礼物抽奖](roomid="+e+",id="+raffleId+",type="+type+")"+r.msg)):o.resolve("[上船](roomid="+e+",id="+n+")"+r.msg)}}),o},pk_join:function(e,n){var o=$.Deferred();return BAPI.Lottery.Pk.join(e,n).then(function(r){switch(console.log("PK抽奖返回信息",r),r.code){case 0:r.data.award_text?o.resolve(r.data.award_text,r.data.award_num):o.resolve(r.data.award_name+"X"+r.data.award_num.toString(),r.data.award_num);break;default:r.msg.indexOf("拒绝")>-1?0==t.CONFIG.FORCE_LOTTERY?(t.blocked=!0,o.resolve("访问被拒绝，您的帐号可能已经被关小黑屋，已停止")):++pk_join_try<=5?t.pk_join(e,id):(pk_join_try=0,o.resolve("[礼物抽奖](roomid="+e+",id="+raffleId+",type="+type+")"+r.msg)):o.resolve("[PK](roomid="+e+",id="+n+")"+r.msg)}}),o},GroupSign:{getGroups:function(){return BAPI.Group.my_groups().then(function(e){return console.log("GroupSign.getGroups: API.Group.my_groups",e),0===e.code?$.Deferred().resolve(e.data.list):(window.toast("[自动应援团签到]'"+e.msg,"caution"),$.Deferred().reject())},function(){return window.toast("[自动应援团签到]获取应援团列表失败，请检查网络","error"),delayCall(function(){return t.GroupSign.getGroups()})})},signInList:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(n>=e.length)return $.Deferred().resolve();var o=e[n];return BAPI.Group.sign_in(o.group_id,o.owner_uid).then(function(r){console.log("GroupSign.signInList: API.Group.sign_in",r);var i=$.Deferred();return 0!==r.code?(window.toast("[自动应援团签到]'"+r.msg,"caution"),t.GroupSign.signInList(e,n)):(r.data.add_num>0?(window.toast("[自动应援团签到]应援团(group_id="+o.group_id+",owner_uid="+o.owner_uid+")签到成功，当前勋章亲密度+"+r.data.add_num,"success"),i.resolve()):0==r.data.add_num?(window.toast("[自动应援团签到]应援团(group_id="+o.group_id+",owner_uid="+o.owner_uid+")已签到","caution"),i.resolve()):i.reject(),$.when(t.GroupSign.signInList(e,n+1),i))},function(){return window.toast("[自动应援团签到]应援团(group_id="+o.group_id+",owner_uid="+o.owner_uid+")签到失败，请检查网络","error"),delayCall(function(){return t.GroupSign.signInList(e,n)})})},run:function(){try{return t.CONFIG.AUTO_GROUP_SIGN?checkNewDay(t.CACHE.AUTO_GROUP_SIGH_TS)?t.GroupSign.getGroups().then(function(e){return t.GroupSign.signInList(e).then(function(){t.CACHE.AUTO_GROUP_SIGH_TS=ts_ms(),t.saveCache(),runTomorrow(t.GroupSign.run)},function(){return delayCall(function(){return t.GroupSign.run()})})},function(){return delayCall(function(){return t.GroupSign.run()})}):(runTomorrow(t.GroupSign.run),$.Deferred().resolve()):$.Deferred().resolve()}catch(e){return window.toast("[自动应援团签到]运行时出现异常，已停止","error"),console.error("["+NAME+"]",e),$.Deferred().reject()}}},DailyReward:{coin_exp:0,login:function(){return BAPI.DailyReward.login().then(function(){console.log("DailyReward.login: API.DailyReward.login"),window.toast("[自动每日奖励][每日登录]完成","success")},function(){return window.toast("[自动每日奖励][每日登录]完成失败，请检查网络","error"),delayCall(function(){return t.DailyReward.login()})})},watch:function(e,n){return t.CONFIG.WATCH?BAPI.DailyReward.watch(e,n,Live_info.uid,ts_s()).then(function(t){console.log("DailyReward.watch: API.DailyReward.watch",t),0===t.code?window.toast("[自动每日奖励][每日观看]完成(av="+e+")","success"):window.toast("[自动每日奖励][每日观看]'"+t.msg,"caution")},function(){return window.toast("[自动每日奖励][每日观看]完成失败，请检查网络","error"),delayCall(function(){return t.DailyReward.watch(e,n)})}):$.Deferred().resolve()},coin:function(e,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!t.CONFIG.COIN)return $.Deferred().resolve();if(t.DailyReward.coin_exp>=10*t.CONFIG.COIN_NUMBER)return window.toast("[自动每日奖励][每日投币]今日投币已完成","info"),$.Deferred().resolve();if(o>=e.length)return window.toast("[自动每日奖励][每日投币]动态里可投币的视频不足","caution"),$.Deferred().resolve();var i=JSON.parse(e[o].card),a=Math.min(2,n);return r&&(a=1),BAPI.DailyReward.coin(i.aid,a).then(function(d){return console.log("DailyReward.coin: API.DailyReward.coin",d),0===d.code?(t.DailyReward.coin_exp+=10*a,window.toast("[自动每日奖励][每日投币]投币成功(av="+i.aid+",num="+a+")","success"),t.DailyReward.coin(e,n-a,o+1)):-110===d.code?(window.toast("[自动每日奖励][每日投币]未绑定手机，已停止","error"),$.Deferred().reject()):34003===d.code?r?t.DailyReward.coin(e,n,o+1):t.DailyReward.coin(e,n,o,!0):34005===d.code?t.DailyReward.coin(e,n,o+1):(window.toast("[自动每日奖励][每日投币]'"+d.msg,"caution"),t.DailyReward.coin(e,n,o+1))},function(){return delayCall(function(){return t.DailyReward.coin(e,n,o)})})},share:function(e){return t.CONFIG.SHARE?BAPI.DailyReward.share(e).then(function(t){console.log("DailyReward.share: API.DailyReward.share",t),0===t.code?window.toast("[自动每日奖励][每日分享]分享成功(av="+e+")","success"):71e3===t.code?window.toast("[自动每日奖励][每日分享]今日分享已完成","info"):window.toast("[自动每日奖励][每日分享]'"+t.msg,"caution")},function(){return window.toast("[自动每日奖励][每日分享]分享失败，请检查网络","error"),delayCall(function(){return t.DailyReward.share(e)})}):$.Deferred().resolve()},dynamic:function(){return BAPI.dynamic_svr.dynamic_new(Live_info.uid,8).then(function(e){if(console.log("DailyReward.dynamic: API.dynamic_svr.dynamic_new",e),0===e.code){if(e.data.cards[0]){var n=JSON.parse(e.data.cards[0].card),o=t.DailyReward.watch(n.aid,n.cid),r=t.DailyReward.coin(e.data.cards,Math.max(t.CONFIG.COIN_NUMBER-t.DailyReward.coin_exp/10,0)),i=t.DailyReward.share(n.aid);return $.when(o,r,i)}window.toast('[自动每日奖励]"动态-投稿视频"中暂无动态',"info")}else window.toast('[自动每日奖励]获取"动态-投稿视频"\''+e.msg,"caution")},function(){return window.toast('[自动每日奖励]获取"动态-投稿视频"失败，请检查网络',"error"),delayCall(function(){return t.DailyReward.dynamic()})})},run:function(){try{return checkNewDay(t.CACHE.DailyReward_TS)?BAPI.DailyReward.exp().then(function(e){if(console.log("DailyReward.run: API.DailyReward.exp",e),0===e.code)return t.DailyReward.coin_exp=e.number,t.DailyReward.login(),t.DailyReward.dynamic().then(function(){t.CACHE.DailyReward_TS=ts_ms(),t.saveCache(),runTomorrow(t.DailyReward.run)});window.toast("[自动每日奖励]"+e.message,"caution")},function(){return window.toast("[自动每日奖励]获取每日奖励信息失败，请检查网络","error"),delayCall(function(){return t.DailyReward.run()})}):(runTomorrow(t.DailyReward.run),$.Deferred().resolve())}catch(e){return window.toast("[自动每日奖励]运行时出现异常","error"),console.error("["+NAME+"]",e),$.Deferred().reject()}}},LiveReward:{dailySignIn:function(){return BAPI.xlive.dosign().then(function(e){
console.log("LiveReward.dailySignIn: API.xlive.dosign",e),0===e.code?window.toast("[自动直播签到]完成","success"):1011040===e.code?window.toast("[自动直播签到]今日直播签到已完成","info"):window.toast("[自动直播签到]"+e.message,"caution")},function(){return window.toast("[自动直播签到]直播签到失败，请检查网络","error"),delayCall(function(){return t.LiveReward.dailySignIn()})})},run:function(){try{if(!t.CONFIG.LIVE_SIGN)return $.Deferred().resolve();if(!checkNewDay(t.CACHE.LiveReward_TS))return runTomorrow(t.LiveReward.run),$.Deferred().resolve();t.LiveReward.dailySignIn(),t.CACHE.LiveReward_TS=ts_ms(),t.saveCache(),runTomorrow(t.LiveReward.run)}catch(e){return window.toast("[自动直播签到]运行时出现异常","error"),console.error("["+NAME+"]",e),$.Deferred().reject()}}},Exchange:{silver2coin:function(){return BAPI.Exchange.silver2coin().then(function(e){console.log("Exchange.silver2coin: API.SilverCoinExchange.silver2coin",e),0===e.code?window.toast("[银瓜子换硬币]"+e.msg,"success"):403===e.code?window.toast("[银瓜子换硬币]"+e.msg,"info"):window.toast("[银瓜子换硬币]"+e.msg,"caution")},function(){return window.toast("[银瓜子换硬币]兑换失败，请检查网络","error"),delayCall(function(){return t.Exchange.silver2coin()})})},runS2C:function(){try{return t.CONFIG.SILVER2COIN?checkNewDay(t.CACHE.Silver2Coin_TS)?t.Exchange.silver2coin().then(function(){t.CACHE.Silver2Coin_TS=ts_ms(),t.saveCache(),runTomorrow(t.Exchange.runS2C)},function(){return delayCall(function(){return t.Exchange.runS2C()})}):(runTomorrow(t.Exchange.runS2C),$.Deferred().resolve()):$.Deferred().resolve()}catch(e){return window.toast("[银瓜子换硬币]运行时出现异常，已停止","error"),console.error("["+NAME+"]",e),$.Deferred().reject()}}},TreasureBox:{timer:void 0,time_end:void 0,time_start:void 0,promise:{calc:void 0,timer:void 0},DOM:{image:void 0,canvas:void 0,div_tip:void 0,div_timer:void 0},init:function(){if(!t.CONFIG.AUTO_TREASUREBOX)return $.Deferred().resolve();var e=$.Deferred();return runUntilSucceed(function(){try{if($(".draw-box.gift-left-part").length)return window.toast("[自动领取瓜子]当前直播间有实物抽奖，暂停领瓜子功能","caution"),e.resolve(),!0;var n=$("#gift-control-vm div.treasure-box.p-relative");if(!n.length)return!1;n=n.first(),n.attr("id","old_treasure_box"),n.hide();var o=$('<div id="'+NAME+'_treasure_div" class="treasure-box p-relative" style="min-width: 46px;display: inline-block;float: left;padding: 22px 0 0 15px;"></div>');t.TreasureBox.DOM.div_tip=$('<div id="'+NAME+'_treasure_div_tip" class="t-center b-box none-select">自动<br>领取中</div>'),t.TreasureBox.DOM.div_timer=$('<div id="'+NAME+'_treasure_div_timer" class="t-center b-box none-select">0</div>'),t.TreasureBox.DOM.image=$('<img id="'+NAME+'_treasure_image" style="display:none">'),t.TreasureBox.DOM.canvas=$('<canvas id="'+NAME+'_treasure_canvas" style="display:none" height="40" width="120"></canvas>');var r="min-width: 40px;padding: 2px 3px;margin-top: 3px;font-size: 12px;color: #fff;background-color: rgba(0,0,255,.5);border-radius: 10px;";if(t.TreasureBox.DOM.div_tip[0].style=r,t.TreasureBox.DOM.div_timer[0].style=r,o.append(t.TreasureBox.DOM.div_tip),o.append(t.TreasureBox.DOM.image),o.append(t.TreasureBox.DOM.canvas),t.TreasureBox.DOM.div_tip.after(t.TreasureBox.DOM.div_timer),n.after(o),!Live_info.mobile_verify)return t.TreasureBox.setMsg("未绑定<br>手机"),window.toast("[自动领取瓜子]未绑定手机，已停止","caution"),e.resolve(),!0;try{OCRAD}catch(n){return t.TreasureBox.setMsg("初始化<br>失败"),window.toast("[自动领取瓜子]OCRAD初始化失败，请检查网络","error"),console.error("["+NAME+"]",n),e.resolve(),!0}return t.TreasureBox.timer=setInterval(function(){var e=parseInt(t.TreasureBox.DOM.div_timer.text(),10);isNaN(e)&&(e=0),e>0?t.TreasureBox.DOM.div_timer.text(e-1+"s"):t.TreasureBox.DOM.div_timer.hide()},1e3),t.TreasureBox.DOM.image[0].onload=function(){var e=t.TreasureBox.DOM.canvas[0].getContext("2d");e.font="40px agencyfbbold",e.textBaseline="top",e.clearRect(0,0,t.TreasureBox.DOM.canvas[0].width,t.TreasureBox.DOM.canvas[0].height),e.drawImage(t.TreasureBox.DOM.image[0],0,0);var n=t.TreasureBox.captcha.OCR.getGrayscaleMap(e),o=t.TreasureBox.captcha.OCR.orderFilter2In3x3(n);e.clearRect(0,0,120,40);for(var r=0;r<o.length;++r){var i=o[r];e.fillStyle="rgb("+i+", "+i+", "+i+")",e.fillRect(r%120,Math.round(r/120),1,1)}try{var a=t.TreasureBox.captcha.correctQuestion(OCRAD(e.getImageData(0,0,120,40)));console.log("TreasureBox.DOM.image.load","question =",a);var d=t.TreasureBox.captcha.eval(a);console.log("TreasureBox.DOM.image.load","answer =",d),void 0!==d&&(console.info("["+NAME+"][自动领取瓜子]验证码识别结果: "+a+" = "+d),t.TreasureBox.promise.calc.resolve(d))}catch(e){t.TreasureBox.promise.calc.reject()}},e.resolve(),!0}catch(t){return window.toast("[自动领取瓜子]初始化时出现异常，已停止","error"),console.error("["+NAME+"]",t),e.reject(),!0}}),e},run:function(){try{if(!t.CONFIG.AUTO_TREASUREBOX||!t.TreasureBox.timer)return;if(Live_info.blocked)return t.TreasureBox.setMsg("小黑屋"),void window.toast("[自动领取瓜子]帐号被关小黑屋，停止领取瓜子","caution");if(!checkNewDay(t.CACHE.TreasureBox_TS))return t.TreasureBox.setMsg("今日<br>已领完"),void runTomorrow(t.TreasureBox.run);t.TreasureBox.getCurrentTask().then(function(e){if(console.log("TreasureBox.run: TreasureBox.getCurrentTask().then",e),0===e.code){t.TreasureBox.promise.timer=$.Deferred(),t.TreasureBox.promise.timer.then(function(){t.TreasureBox.captcha.calc().then(function(e){t.TreasureBox.getAward(e).then(function(){return t.TreasureBox.run()},function(){return t.TreasureBox.run()})},function(){return TreasureBox.run()})}),t.TreasureBox.time_end=e.data.time_end,t.TreasureBox.time_start=e.data.time_start;var n=t.TreasureBox.time_end-ts_s()+1;n<0&&(n=0),setTimeout(function(){t.TreasureBox.promise.timer&&t.TreasureBox.promise.timer.resolve()},1e3*n),t.TreasureBox.DOM.div_timer.text(n+"s"),t.TreasureBox.DOM.div_timer.show(),t.TreasureBox.DOM.div_tip.html("轮数<br>"+e.data.times+"/"+e.data.max_times+"<br>银瓜子<br>"+e.data.silver)}else if(-10017===e.code)t.TreasureBox.setMsg("今日<br>已领完"),t.CACHE.TreasureBox_TS=ts_ms(),t.saveCache(),runTomorrow(t.TreasureBox.run);else{if(-500!==e.code)return window.toast("[自动领取瓜子]"+e.msg,"caution"),t.TreasureBox.run();location.reload()}})}catch(e){t.TreasureBox.setMsg("运行<br>异常"),window.toast("[自动领取瓜子]运行时出现异常，已停止","error"),console.error("["+NAME+"]",e)}},setMsg:function(e){t.CONFIG.AUTO_TREASUREBOX&&(t.TreasureBox.promise.timer&&(t.TreasureBox.promise.timer.reject(),t.TreasureBox.promise.timer=void 0),t.TreasureBox.DOM.div_timer&&t.TreasureBox.DOM.div_timer.hide(),t.TreasureBox.DOM.div_tip&&t.TreasureBox.DOM.div_tip.html(e))},getAward:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t.CONFIG.AUTO_TREASUREBOX?n>3?$.Deferred().resolve():BAPI.TreasureBox.getAward(t.TreasureBox.time_start,t.TreasureBox.time_end,e).then(function(e){switch(console.log("TreasureBox.getAward: getAward",e),e.code){case 0:window.toast("[自动领取瓜子]领取了 "+e.data.awardSilver+" 银瓜子","success");case-903:return $.Deferred().resolve();case-902:case-901:return t.TreasureBox.captcha.calc().then(function(e){return t.TreasureBox.getAward(e,n)});case-800:return t.TreasureBox.setMsg("未绑定<br>手机"),window.toast("[自动领取瓜子]未绑定手机，已停止","caution"),$.Deferred().reject();case-500:var o=$.Deferred();return setTimeout(function(){t.TreasureBox.captcha.calc().then(function(e){t.TreasureBox.getAward(e,n+1).then(function(){return o.resolve()},function(){return o.reject()})},function(){return o.reject()})},3e3),o;case 400:return e.msg.indexOf("拒绝")>-1?(Live_info.blocked=!0,t.TreasureBox.setMsg("拒绝<br>访问"),window.toast("[自动领取瓜子]访问被拒绝，您的帐号可能已经被关小黑屋，已停止","error"),$.Deferred().reject()):(window.toast("[自动领取瓜子]"+e.msg,"caution"),$.Deferred().resolve());default:window.toast("[自动领取瓜子]"+e.msg,"caution")}},function(){return window.toast("[自动领取瓜子]获取任务失败，请检查网络","error"),delayCall(function(){return t.TreasureBox.getAward(e,n)})}):$.Deferred().reject()},getCurrentTask:function(){return t.CONFIG.AUTO_TREASUREBOX?BAPI.TreasureBox.getCurrentTask().then(function(e){return console.log("TreasureBox.getCurrentTask: API.TreasureBox.getCurrentTask",e),$.Deferred().resolve(e)},function(){return window.toast("[自动领取瓜子]获取当前任务失败，请检查网络","error"),delayCall(function(){return t.TreasureBox.getCurrentTask()})}):$.Deferred().reject()},captcha:{cnt:0,calc:function(){return t.CONFIG.AUTO_TREASUREBOX?t.TreasureBox.captcha.cnt>20?(t.TreasureBox.setMsg("验证码<br>识别<br>失败"),window.toast("[自动领取瓜子]验证码识别失败，已停止","error"),$.Deferred().reject()):BAPI.TreasureBox.getCaptcha(ts_ms()).then(function(e){if(console.log("TreasureBox.captcha.calc: getCaptcha",e),0===e.code){t.TreasureBox.captcha.cnt++;var n=$.Deferred();return t.TreasureBox.promise.calc=$.Deferred(),t.TreasureBox.promise.calc.then(function(e){t.TreasureBox.captcha.cnt=0,n.resolve(e)},function(){t.TreasureBox.captcha.calc().then(function(e){n.resolve(e)},function(){n.reject()})}),t.TreasureBox.DOM.image.attr("src",e.data.img),n}return window.toast("[自动领取瓜子]"+e.msg,"caution"),delayCall(function(){return t.TreasureBox.captcha.calc()})},function(){return window.toast("[自动领取瓜子]加载验证码失败，请检查网络","error"),delayCall(function(){return t.TreasureBox.captcha.calc()})}):(t.TreasureBox.captcha.cnt=0,$.Deferred().reject())},OCR:{getGrayscaleMap:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:235,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:120,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:40,r=[],i=0;i<o;i++)for(var a=0;a<n;a++){var d=function(t,n){var o=e.getImageData(t,n,1,1).data;return o?77*o[0]+150*o[1]+29*o[2]+128>>8:0}(a,i);r.push(d>t?d:0)}return r},orderFilter2In3x3:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:120,o=function(t,o){return t+o*n>=0?e[t+o*n]:255},r=[],i=e.length,a=t-1,d=0;d<i;++d){var s=[d%n,Math.floor(d/n)],c=s[0],l=s[1],u=new Array(9);u[0]=o(c-1,l-1),u[1]=o(c+0,l-1),u[2]=o(c+1,l-1),u[3]=o(c-1,l+0),u[4]=o(c+0,l+0),u[5]=o(c+1,l+0),u[6]=o(c-1,l+1),u[7]=o(c+0,l+1),u[8]=o(c+1,l+1),u.sort(function(e,t){return e-t}),r.push(u[a])}return r},execMap:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,n=[],o=e.length,r=0;r<o;++r){var i=0,a=e[r-120],d=e[r-120-1],s=e[r-120+1],c=e[r-1],l=e[r+1],u=e[r+120],g=e[r+120-1],_=e[r+120+1];a&&(i+=1),d&&(i+=1),s&&(i+=1),c&&(i+=1),l&&(i+=1),u&&(i+=1),g&&(i+=1),_&&(i+=1),i>t?n.push(1):n.push(0)}return n}},eval:function(e){return new Function("return "+e)()},correctStr:{g:9,z:2,Z:2,o:0,l:1,B:8,O:0,S:6,s:6,i:1,I:1,".":"-",_:4,b:6,R:8,"|":1,D:0,">":3},correctQuestion:function(e){var n="";e=e.trim();for(var o in e){var r=t.TreasureBox.captcha.correctStr[e[o]];n+=void 0!==r?r:e[o]}return"4"===n[2]&&(n[2]="+"),n}}}};t.init().then(function(){var e=!1;try{!function(){var n=Date.now();n-t.CACHE.UNIQUE_CHECK>=0&&n-t.CACHE.UNIQUE_CHECK<=1e4&&($(".link-toast").hide(),$(".igiftMsg").hide(),window.toast("有其他直播间页面的脚本正在运行，本页面脚本停止运行","caution"),e=!0)}();var n=void 0;window.addEventListener("unload",function(){n&&(clearTimeout(n),t.CACHE.UNIQUE_CHECK=0,t.saveCache())}),function e(){n=setTimeout(e,1e3),t.CACHE.UNIQUE_CHECK=Date.now(),t.saveCache()}()}catch(e){console.error("重复运行检测错误",e)}if(1!=e){if(0===parseInt(Live_info.uid)||isNaN(parseInt(Live_info.uid)))return void t.chatLog("未登录，请先登录再使用脚本","warning");console.log(t.CONFIG),StartPlunder(t)}})}function StartPlunder(e){var t=function(){checkNewDay(e.GIFT_COUNT.CLEAR_TS)?(e.GIFT_COUNT.COUNT=0,e.GIFT_COUNT.LOVE_COUNT=0,e.GIFT_COUNT.CLEAR_TS=dateNow(),e.saveGiftCount(),console.log("清空辣条数量")):console.log("无需清空辣条数量")};setInterval(t,6e4),t(),setTimeout(function(){e.GroupSign.run(),e.DailyReward.run(),e.LiveReward.run(),e.Exchange.runS2C(),e.TreasureBox.run()},6e3),e.creatSetBox(),BAPI.room.getList().then(function(t){console.log("直播间列表",t);var n=!0,o=!1,r=void 0;try{for(var i,a=t.data[Symbol.iterator]();!(n=(i=a.next()).done);n=!0)!function(){var t=i.value;BAPI.room.getRoomList(t.id,0,0,1,1).then(function(n){console.log("直播间号列表",n);for(var o=0;o<n.data.length;++o)e.listen(n.data[o].roomid,Live_info.uid,t.name+"区")})}()}catch(e){o=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw r}}});var n=function(){return e.GIFT_COUNT.COUNT>=e.CONFIG.MAX_GIFT&&(console.log("超过今日辣条限制，不参与抽奖"),e.max_blocked=!0),e.blocked||e.max_blocked?e.blocked?(e.chatLog("进入小黑屋检查小时榜已停止运行"),void clearInterval(o)):void e.chatLog("辣条已达到最大值检查小时榜已停止运行"):inTimeArea(e.CONFIG.TIME_AREA_START_H0UR,e.CONFIG.TIME_AREA_END_H0UR,e.CONFIG.TIME_AREA_START_MINUTE,e.CONFIG.TIME_AREA_END_MINUTE)&&e.CONFIG.TIME_AREA_DISABLE?void e.chatLog("当前时间段不检查小时榜礼物","warning"):void BAPI.rankdb.getTopRealTimeHour().then(function(t){var n=t.data.list;e.chatLog("检查小时榜房间的礼物","warning"),console.log(n);var o=!0,r=!1,i=void 0;try{for(var a,d=n[Symbol.iterator]();!(o=(a=d.next()).done);o=!0){var s=a.value;e.checkRoom(s.roomid,"小时榜-"+s.area_v2_parent_name+"区")}}catch(e){r=!0,i=e}finally{try{!o&&d.return&&d.return()}finally{if(r)throw i}}})};setTimeout(n,6e3);var o=setInterval(n,12e4);!function t(n){setTimeout(function(){if(e.raffleId_list.length>0||e.guardId_list.length>0||e.pkId_list.length>0)return console.log("还有礼物没抽 延迟30s后刷新直播间"),void t(3e4);inTimeArea(e.CONFIG.TIME_AREA_START_H0UR,e.CONFIG.TIME_AREA_END_H0UR,e.CONFIG.TIME_AREA_START_MINUTE,e.CONFIG.TIME_AREA_END_MINUTE)&&e.CONFIG.IN_TIME_RELOAD_DISABLE||e.blocked||e.max_blocked||window.location.reload()},n)}(6e4*e.CONFIG.TIME_RELOAD)}function inTimeArea(e,t,n,o){if(e>t||e>23||t>24||e<0||t<1||n>59||n<0||o>59||o<0)return console.log("错误时间段"),!1;var r=new Date,i=r.getHours(),a=r.getMinutes();return e<t?i>=e&&i<t||i==t&&a>=n&&a<o:e>t?i>=e||i<t||i==t&&a>=n&&a<o:e==t?a>=n&&a<o:void 0}function probability(e){return!(e<=0)&&e>=Math.ceil(100*Math.random())}var msgHide=!1,logSwitch=!0,NAME="IGIFTMSG",BAPI=BilibiliAPI,server_host=void 0,gift_join_try=0,guard_join_try=0,pk_join_try=0,tz_offset=(new Date).getTimezoneOffset()+480,ts_ms=function(){return Date.now()},ts_s=function(){return Math.round(ts_ms()/1e3)};logSwitch||(console.log=function(){});var Live_info={room_id:void 0,uid:void 0,mobile_verify:void 0},runUntilSucceed=function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;setTimeout(function(){t()||e(t,o,o)},n)},delayCall=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,n=$.Deferred();return setTimeout(function(){var t=e();t&&t.then?t.then(function(e,t,o,r,i,a){return n.resolve(e,t,o,r,i,a)}):n.resolve()},t),n},runTomorrow=function(e){var t=new Date;t.setMinutes(t.getMinutes()+tz_offset),t.setDate(t.getDate()+1),t.setHours(0,1,0,0),t.setMinutes(t.getMinutes()-tz_offset),setTimeout(e,t-ts_ms()),console.log("runTomorrow",t.toString())},newWindow={init:function(){return newWindow.Toast.init().then(function(){})},Toast:{init:function(){try{var e=[];return window.toast=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;switch(n){case"success":case"info":case"caution":case"error":break;default:n="info"}var r=$('<div class="link-toast '+n+' fixed"><span class="toast-text">'+t+"</span></div>")[0];document.body.appendChild(r),r.style.top=document.body.scrollTop+40*e.length+10+"px",r.style.left=document.body.offsetWidth+document.body.scrollLeft-r.offsetWidth-5+"px",e.push(r),setTimeout(function(){r.className+=" out",setTimeout(function(){e.shift(),e.forEach(function(e){e.style.top=parseInt(e.style.top,10)-40+"px"}),$(r).remove()},200)},o)},$.Deferred().resolve()}catch(e){return console.error("初始化浮动提示时出现异常",e),$.Deferred().reject()}}}};newWindow.init(),$(function(){!function e(t){setTimeout(function(){void 0===BilibiliLive||0===parseInt(BilibiliLive.UID)||isNaN(parseInt(BilibiliLive.UID))?(e(1e3),console.log("无配置信息")):(Live_info.room_id=BilibiliLive.ROOMID,Live_info.uid=BilibiliLive.UID,BAPI.live_user.get_info_in_room(Live_info.room_id).then(function(e){console.log("InitData: API.live_user.get_info_in_room",e),Live_info.mobile_verify=e.data.info.mobile_verify}),console.log(Live_info),init())},t)}(1e3),addStyle()}),Array.prototype.remove=function(e){var t=this.indexOf(e);t>-1&&this.splice(t,1)};var dateNow=function(){return Date.now()},checkNewDay=function(e){if(0===e)return!0;var t=new Date(e),n=new Date,o=t.getDate();return n.getDate()!==o};